<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>OBLITERATE PACKGEN</title>
<script src="https://cdn.tailwindcss.com">
</script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&amp;display=swap" rel="stylesheet"/>
<!-- JS Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.2/vanilla-tilt.min.js">
</script>
<style>
        :root {
             --base-hue: 190; /* Default hue from #22d3ee */
            --accent-saturation: 86%;
            --accent-lightness: 53%;

            /* Accent colors from picker */
            --glow-color-2: hsl(var(--base-hue), var(--accent-saturation), var(--accent-lightness));
            --glow-color-1: hsl(calc(var(--base-hue) + 15), var(--accent-saturation), calc(var(--accent-lightness) - 5%));
            
            /* UI colors derived from base hue */
            --bg-color: hsl(var(--base-hue), 20%, 8%);
            --panel-bg-color: hsl(var(--base-hue), 18%, 14%);
            --border-color: hsl(var(--base-hue), 15%, 25%);
            --text-primary: hsl(var(--base-hue), 15%, 90%);
            --text-secondary: hsl(var(--base-hue), 10%, 65%);
            --text-on-accent: hsl(var(--base-hue), 20%, 8%);

            /* Lighter accent for gradients */
            --glow-color-1-light: hsl(calc(var(--base-hue) + 15), var(--accent-saturation), 75%);
            --glow-color-2-light: hsl(var(--base-hue), var(--accent-saturation), 75%);
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow-y: auto;
            overflow-x: hidden;            /* Custom scrollbar for better theme integration */
            scrollbar-width: thin;
            scrollbar-color: var(--glow-color-2) transparent;
        }

        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-track {
            background: transparent;
        }
        body::-webkit-scrollbar-thumb {
            background-color: var(--glow-color-2);
            border-radius: 10px;
            border: 2px solid var(--bg-color);
        }

        #bg-canvas, #scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        #scanline {
            background: linear-gradient(to bottom, transparent, rgba(34, 211, 238, 0.05) 50%, transparent);
            background-size: 100% 4px;
            animation: scan 12s linear infinite;
            opacity: 0.7;
            pointer-events: none;
        }

        @keyframes scan {
            from { background-position: 0 0; }
            to { background-position: 0 -400px; }
        }
        
        #main-content {
            position: relative;
            z-index: 1;
        }
        
        /* Title Load-in Animation */
        .title-char {
            display: inline-block;
            opacity: 0;
            transform: translateY(-20px);
            animation: boot-up 0.5s forwards;
        }
        
        .cyber-flicker {
            animation: boot-up 0.5s forwards, cyber-flicker-anim 4s infinite;
        }

        @keyframes boot-up {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* New Cyber-Flicker text effect */
        @keyframes cyber-flicker-anim {
            0%, 100% {
                text-shadow: 
                    0 0 5px #fff, 
                    0 0 10px #fff, 
                    0 0 15px var(--glow-color-2), 
                    0 0 20px var(--glow-color-2), 
                    0 0 25px var(--glow-color-2), 
                    0 0 30px var(--glow-color-1), 
                    0 0 35px var(--glow-color-1);
            }
            50% {
                text-shadow: 
                    0 0 10px #fff, 
                    0 0 15px #fff, 
                    0 0 20px var(--glow-color-1), 
                    0 0 25px var(--glow-color-1), 
                    0 0 30px var(--glow-color-1), 
                    0 0 35px var(--glow-color-2), 
                    0 0 40px var(--glow-color-2);
            }
        }
        
        /* Holographic Card Style */
        .holo-card {
            background: hsl(var(--base-hue) 18% 14% / 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform-style: preserve-3d;
            perspective: 1500px;
            position: relative;
            box-shadow: 0 0 25px var(--glow-color-2); /* Stronger initial glow */
            transition: box-shadow 0.3s ease-out; /* Add transition for glow */
        }
        
        .holo-card:hover {
            box-shadow: 0 0 40px var(--glow-color-2); /* Even stronger hover glow */
        }

        .holo-card .glare {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(224, 242, 254, 0.2), transparent 40%);
            mix-blend-mode: screen;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            border-radius: 1.0rem;
        }

        .holo-card::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            border-radius: 1.0rem;
            border: 2px solid transparent;
            background: linear-gradient(135deg, var(--glow-color-1), var(--glow-color-2)) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: destination-out;
            mask-composite: exclude;
            opacity: 0.6;
            transition: opacity 0.3s;
        }
        
        .holo-card:hover::before { opacity: 1; }

        .card-corner {
            position: absolute;
            width: 20px; height: 20px;
            border-style: solid;
            border-color: var(--glow-color-1);
            opacity: 0.7;
            transition: border-color 0.3s;
        }
        .holo-card:hover .card-corner { border-color: var(--glow-color-2); }
        .card-corner.top-left { top: 10px; left: 10px; border-width: 2px 0 0 2px; }
        .card-corner.top-right { top: 10px; right: 10px; border-width: 2px 2px 0 0; }
        .card-corner.bottom-left { bottom: 10px; left: 10px; border-width: 0 0 2px 2px; }
        .card-corner.bottom-right { bottom: 10px; right: 10px; border-width: 0 2px 2px 0; }
        
        .typewriter-text::after {
            content: 'â–ˆ';
            animation: blink 1s step-end infinite;
            color: var(--glow-color-2);
        }
        @keyframes blink { 50% { opacity: 0; } }
        
        .btn-gradient {
            background-image: linear-gradient(to right, var(--glow-color-1), var(--glow-color-2), var(--glow-color-1));
            background-size: 200% auto;
            transition: all 0.5s;
            box-shadow: 0 0 15px var(--glow-color-2); /* Initial glow */
        }
        .btn-gradient:hover:not(:disabled) {
            background-position: right center;
            box-shadow: 0 0 35px var(--glow-color-2), 0 0 10px var(--glow-color-1); /* Stronger glow with secondary color */
            transform: translateY(-2px); /* Slight lift */
        }
        .btn-gradient:active:not(:disabled) { 
            transform: scale(0.97) translateY(0); /* Press effect */
            box-shadow: 0 0 15px var(--glow-color-2); /* Reset shadow on active */
        }
        .btn-gradient:disabled { opacity: 0.4; cursor: not-allowed; box-shadow: none; }

        .toggle-btn {
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: transparent;
            color: var(--glow-color-1);
            border-radius: 8px;
            transition: all 0.3s ease, box-shadow 0.2s ease;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem;
            width: 100%;
            text-align: center;
        }
        .toggle-btn:hover:not(.active):not(:disabled) {
            background-color: rgba(14, 165, 233, 0.1);
            border-color: var(--glow-color-2);
            color: var(--text-primary); /* Text color shift on hover */
        }
        .toggle-btn.active {
            background-color: var(--glow-color-2);
            color: var(--text-on-accent);
            border-color: var(--glow-color-2);
            box-shadow: 0 0 18px var(--glow-color-2); /* More intense active glow */
            font-weight: bold;
        }
        .toggle-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: var(--border-color); 
            transition: .4s; 
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5); /* Inner shadow for depth */
        }
        .slider:before { 
            position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; 
            background-color: var(--text-primary); /* Thumb color */
            transition: .4s; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Thumb shadow */
        }
        input:checked + .slider { 
            background-color: var(--glow-color-2); 
            box-shadow: 0 0 15px var(--glow-color-2); /* Glow on active */
        }
        input:disabled + .slider { opacity: 0.5; cursor: not-allowed; }
        input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        /* Range Slider */
        .slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px; /* Slightly thicker track */
            background: linear-gradient(to right, var(--glow-color-1) 0%, var(--glow-color-2) 100%); /* Gradient track */
            outline: none;
            opacity: 0.9; /* More visible track */
            transition: opacity .2s;
            border-radius: 9999px;
            border: 1px solid var(--border-color); /* Subtle border */
        }
        .slider-thumb:hover { opacity: 1; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px; height: 18px; /* Slightly larger thumb */
            background: var(--glow-color-2);
            cursor: pointer; border-radius: 50%;
            box-shadow: 0 0 12px var(--glow-color-2), 0 0 5px rgba(255,255,255,0.7); /* Stronger thumb glow */
            border: 2px solid var(--bg-color); /* Contrast border for thumb */
            transition: all 0.2s ease;
        }
        .slider-thumb::-webkit-slider-thumb:active {
            transform: scale(1.1); /* Pop on active */
        }
        .slider-thumb::-moz-range-thumb {
            width: 18px; height: 18px;
            background: var(--glow-color-2);
            cursor: pointer; border-radius: 50%;
            border: 2px solid var(--bg-color);
            box-shadow: 0 0 12px var(--glow-color-2), 0 0 5px rgba(255,255,255,0.7);
            transition: all 0.2s ease;
        }
        .slider-thumb::-moz-range-thumb:active {
            transform: scale(1.1);
        }

        /* Joke List */
        #joke-display-area ul {
            list-style: none; padding: 0; margin: 0;
            text-align: left;
            max-height: 140px; /* Adjust as needed */
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--glow-color-2) transparent;
        }
        #joke-display-area ul::-webkit-scrollbar { width: 6px; }
        #joke-display-area ul::-webkit-scrollbar-track { background: transparent; }
        #joke-display-area ul::-webkit-scrollbar-thumb {
            background-color: var(--glow-color-2);
            border-radius: 10px;
            border: 1px solid var(--panel-bg-color);
        }

        #joke-display-area li { 
            padding: 8px 10px; /* Slightly more padding */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            font-size: 0.9em; 
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        #joke-display-area li:hover {
            background-color: rgba(14, 165, 233, 0.05); /* Subtle highlight on hover */
            box-shadow: 0 0 5px rgba(14, 165, 233, 0.3);
        }
        #joke-display-area li:last-child { border-bottom: none; }

        .topic-tag {
            padding: 6px 12px; /* Slightly larger tags */
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: transparent;
            color: var(--glow-color-1);
            border-radius: 9999px;
            transition: all 0.3s ease, box-shadow 0.2s ease;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem; /* text-xs */
        }
        .topic-tag:hover:not(.active) {
            background-color: rgba(14, 165, 233, 0.1);
            border-color: var(--glow-color-2);
            color: var(--text-primary);
        }
        .topic-tag.active {
            background-color: var(--glow-color-2);
            color: var(--bg-color);
            border-color: var(--glow-color-2);
            box-shadow: 0 0 12px var(--glow-color-2); /* More intense active glow */
            font-weight: bold;
        }
        #custom-topic-input { transition: all 0.3s ease; }
        #custom-topic-input::placeholder { color: var(--text-secondary); }

        textarea, input[type="text"], input[type="number"], select, input[type="color"] {
             background-color: var(--panel-bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, select:focus, input[type="color"]:focus {
            border-color: var(--glow-color-2);
            box-shadow: 0 0 8px var(--glow-color-2);
            outline: none;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 100;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.visible { 
            opacity: 1; 
        }
        .modal.hidden { 
            display: none; /* Hide completely after transition */
        }

        .modal-content {
            background: var(--bg-color);
            margin: auto;
            padding: 2rem;
            border: 1px solid var(--glow-color-1);
            width: 80%;
            max-width: 700px;
            border-radius: 1rem;
            box-shadow: 0 0 40px var(--glow-color-2); /* Stronger modal glow */
            position: relative;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal.visible .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-close {
            color: #aaa;
            position: absolute;
            top: 10px; right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        .modal-close:hover,
        .modal-close:focus { color: var(--glow-color-2); text-decoration: none; }

        /* Tab Styles */
        .tabs-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .tab-btn { padding: 0.5rem 1rem; cursor: pointer; border: none; background: none; color: var(--text-secondary); font-family: 'Share Tech Mono', monospace; transition: all 0.3s ease; border-bottom: 2px solid transparent; margin-bottom: -1px; }
        .tab-btn:hover { color: var(--text-primary); }
        .tab-btn.active { color: var(--glow-color-2); border-bottom-color: var(--glow-color-2); font-weight: bold; text-shadow: 0 0 5px var(--glow-color-2); } /* Tab active glow */
        .tab-panel { display: none; animation: fadeIn 0.5s; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Overrides for Tailwind classes to use CSS variables */
        h1#title {
            background-image: linear-gradient(to right, var(--glow-color-1-light), var(--glow-color-2-light));
            text-shadow: 0 0 15px var(--glow-color-2), 0 0 8px var(--glow-color-1); /* Title text glow */
        }
        p#view-counter { 
            color: var(--glow-color-2); 
            opacity: 0.8; 
            text-shadow: 0 0 3px var(--glow-color-2); /* View counter glow */
        }
        .text-slate-400, p.tracking-widest, .text-xs.text-slate-400 {
            color: var(--text-secondary);
            text-shadow: 0 0 2px rgba(34, 211, 238, 0.2); /* Subtle text shadow for labels */
        }
        #joke-display-area { 
            color: var(--text-primary); 
            text-shadow: 0 0 5px var(--glow-color-1); /* Joke text glow */
        }
        
        /* Adjusted the main content container to be wider */
        #main-content {
            max-width: 96rem; /* Equivalent to Tailwind's max-w-7xl */
        }

        /* Advanced Controls Panel: Remove max-w-lg from HTML and ensure it fills parent */
        .advanced-controls-panel { /* New class to target this specific panel more cleanly */
            width: 100%; /* Ensure it takes full width of its parent */
        }

        /* Animated divider */
        .animated-divider {
            border-bottom: 1px dashed var(--border-color);
            position: relative;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .animated-divider::before, .animated-divider::after {
            content: '';
            position: absolute;
            height: 2px;
            background: var(--glow-color-2);
            animation: divider-flow 4s linear infinite;
        }
        .animated-divider::before {
            left: 0; width: 30%; top: -1px;
            animation-delay: 0s;
        }
        .animated-divider::after {
            right: 0; width: 30%; top: -1px;
            animation-delay: 2s;
        }
        @keyframes divider-flow {
            0% { transform: translateX(-100%); opacity: 0; }
            50% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }

        /* Copy Button Feedback */
        #copy-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.6rem; /* Make it slightly larger */
            background-color: var(--panel-bg-color); /* Use panel background */
            border-radius: 9999px;
            transition: background-color 0.2s ease, transform 0.2s ease, opacity 0.3s ease;
            box-shadow: 0 0 8px rgba(34, 211, 238, 0.2);
        }
        #copy-btn:hover {
            background-color: var(--border-color);
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--glow-color-2);
        }
        #copy-btn #copy-icon {
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }
        #copy-btn:hover #copy-icon {
            color: var(--glow-color-2);
        }
        #copy-feedback {
            color: var(--glow-color-2);
            text-shadow: 0 0 5px var(--glow-color-2);
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--glow-color-2);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex justify-center min-h-screen p-4">
<div id="scanline"></div>
<canvas id="bg-canvas"></canvas>
<div class="w-full max-w-7xl mx-auto my-auto flex flex-col text-center" id="main-content">
<header class="mb-8">
<h1 class="text-5xl md:text-7xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-sky-300 to-cyan-300" id="title">
<!-- Title injected by JS -->
</h1>
<p class="text-sm text-cyan-400/70 mt-2 tracking-widest" id="view-counter">TOTAL PAGE VIEWS: [generatorStats("views")]</p>
</header>
<!-- Joke Display Area -->
<div class="holo-card rounded-2xl p-6 md:p-10 min-h-[200px] flex items-center justify-center shadow-2xl shadow-cyan-500/10" id="joke-card">
<div class="glare"></div>
<div class="card-corner top-left"></div><div class="card-corner top-right"></div>
<div class="text-lg md:text-xl font-medium text-slate-200 px-4 w-full" id="joke-display-area">
<p id="joke-display-text">Press the button to generate a pack.</p>
</div>
<div class="card-corner bottom-left"></div><div class="card-corner bottom-right"></div>
<button class="absolute top-4 right-4 p-2 bg-slate-900/50 rounded-full hover:bg-slate-800/50 transition-all duration-300 opacity-0 focus:opacity-100" id="copy-btn" title="Copy to clipboard">
<svg class="bi bi-clipboard text-slate-400" fill="currentColor" height="16" id="copy-icon" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path></svg>
<span class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white opacity-0 transition-opacity" id="copy-feedback">Copied!</span>
</button>
</div>
<!-- POV Selector -->
<div class="mt-8 mb-4">
<p class="text-sm text-slate-400 mb-3 tracking-widest">POINT OF VIEW</p>
<div class="flex justify-center gap-2 md:gap-4" id="pov-selector">
<button class="toggle-btn !rounded-full !px-6 active" data-pov="second">You</button>
<button class="toggle-btn !rounded-full !px-6" data-pov="third">He</button>
<button class="toggle-btn !rounded-full !px-6" data-pov="first">I saw</button>
</div>
</div>
<!-- Generation Modes & Parameters -->
<div class="mt-6 mb-4 text-left mx-auto p-4 border border-slate-700 rounded-lg bg-slate-900/30 advanced-controls-panel">
<p class="text-sm text-slate-400 mb-3 tracking-widest text-center">ADVANCED CONTROLS</p>
<div class="animated-divider"></div> <!-- Animated Divider -->
<!-- Tab Navigation -->
<div class="tabs-nav" id="tabs-nav">
<button class="tab-btn active" data-hotkey="1" data-tab="tab-generation">Generation</button>
<button class="tab-btn" data-hotkey="2" data-tab="tab-topics">Topics</button>
<button class="tab-btn" data-hotkey="3" data-tab="tab-content">Content</button>
<button class="tab-btn" data-hotkey="4" data-tab="tab-advanced">Advanced</button>
</div>
<!-- Tab Content Panels -->
<div id="tabs-content">
<!-- Generation Tab -->
<div class="tab-panel active" id="tab-generation">
<!-- More Generation Controls -->
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="timing-slider">
        Timing &amp; Pacing: <span class="font-bold text-cyan-400" id="timing-value">Normal</span>
</label>
<input class="w-full slider-thumb" id="timing-slider" max="5" min="1" type="range" value="3"/>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="verbosity-style">Verbosity Style:</label>
<select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs" id="verbosity-style">
<option value="concise">Concise</option>
<option value="narrative">Narrative</option>
<option value="rambling">Rambling</option>
<option value="stream">Stream of Consciousness</option>
</select>
</div>
<div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4" id="mode-selector">
<button class="toggle-btn active" data-mode="single">Single</button>
<button class="toggle-btn" data-mode="story" disabled="" title="Generate a joke first to enable Story Chain">Story Chain</button>
<button class="toggle-btn" data-mode="remix" disabled="" title="Generate a joke first to enable Remix">Remix</button>
<button class="toggle-btn" data-mode="escalation">Escalation</button>
</div>
<div class="animated-divider"></div> <!-- Animated Divider -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 items-center border-t border-slate-700/50 pt-3">
<div class="flex items-center justify-between gap-3 p-2 rounded-md bg-slate-800/50">
<label class="text-sm cursor-pointer select-none" for="theme-lock-toggle">Theme Lock</label>
<label class="switch"><input disabled="" id="theme-lock-toggle" type="checkbox"/><span class="slider round"></span></label>
</div>
<div class="flex items-center justify-between gap-3 p-2 rounded-md bg-slate-800/50">
<label class="text-sm cursor-pointer select-none" for="batch-toggle">Batch Mode</label>
<label class="switch"><input id="batch-toggle" type="checkbox"/><span class="slider round"></span></label>
</div>
</div>
<div class="mt-4" id="params-container">
<label class="text-xs text-slate-400" for="absurdity-slider">Absurdity: <span class="font-bold text-cyan-400" id="absurdity-value">5</span></label>
<input class="w-full slider-thumb" id="absurdity-slider" max="10" min="1" type="range" value="5"/>
</div>
<div class="hidden mt-4 grid grid-cols-[auto_1fr] gap-x-4 gap-y-2 items-center text-xs" id="batch-controls">
<label class="text-slate-400" for="batch-steps">Steps:</label>
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-center" id="batch-steps" max="10" min="2" type="number" value="3"/>
</div>
<div class="animated-divider"></div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="joke-length-slider">
        Joke Length: <span class="font-bold text-cyan-400" id="joke-length-value">Medium</span>
</label>
<input class="w-full slider-thumb" id="joke-length-slider" max="5" min="1" type="range" value="3"/>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="detail-level-slider">Detail Level: <span class="font-bold text-cyan-400" id="detail-level-value">Standard</span></label>
<input class="w-full slider-thumb" id="detail-level-slider" max="5" min="1" type="range" value="3"/>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="creativity-level-slider">Creativity Level: <span class="font-bold text-cyan-400" id="creativity-level-value">Balanced</span></label>
<input class="w-full slider-thumb" id="creativity-level-slider" max="5" min="1" type="range" value="3"/>
</div>
<div class="flex items-center justify-between gap-3 p-2 rounded-md bg-slate-800/50 mb-3">
<label class="text-sm cursor-pointer select-none" for="avoid-repetition-toggle">Avoid Repetition</label>
<label class="switch"><input id="avoid-repetition-toggle" type="checkbox"/><span class="slider round"></span></label>
</div>
<div class="animated-divider"></div>
<!-- Additional Fine-Tuning Settings -->
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="sarcasm-level-slider">Sarcasm Level: <span class="font-bold text-cyan-400" id="sarcasm-level-value">Balanced</span></label>
<input class="w-full slider-thumb" id="sarcasm-level-slider" max="5" min="1" type="range" value="3"/>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="realism-vs-surrealism">Realism vs. Surrealism:</label>
<select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs" id="realism-vs-surrealism">
<option value="balanced">Balanced</option>
<option value="realistic">Grounded</option>
<option value="surreal">Surreal</option>
<option value="dreamlike">Dreamlike</option>
</select>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="visual-imagery-slider">Visual Imagery Intensity: <span class="font-bold text-cyan-400" id="visual-imagery-value">3</span></label>
<input class="w-full slider-thumb" id="visual-imagery-slider" max="5" min="1" type="range" value="3"/>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="logical-coherence-toggle">Logical Coherence:</label>
<select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs" id="logical-coherence-toggle">
<option value="auto">Auto</option>
<option value="tight">Tightly coherent</option>
<option value="loose">Loosely connected</option>
<option value="chaotic">Intentionally incoherent</option>
</select>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="exaggeration-mode">Exaggeration Mode:</label>
<select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs" id="exaggeration-mode">
<option value="mild">Mild</option>
<option value="medium">Medium</option>
<option value="over-the-top">Over the Top</option>
<option value="absurd-max">Absurd Max</option>
</select>
</div>

<div class="mb-3">
  <label class="block text-xs text-slate-400 mb-1" for="theme-randomizer-toggle">Theme Randomizer</label>
  <label class="switch">
    <input id="theme-randomizer-toggle" type="checkbox"/>
    <span class="slider round"></span>
  </label>
</div>
<div class="mb-3">
  <label class="block text-xs text-slate-400 mb-1" for="noun-count">Preferred Noun Count:</label>
  <input id="noun-count" type="number" min="1" max="50" value="10" class="w-full bg-slate-800 border border-slate-600 rounded p-1 text-xs" />
</div>
<div class="mb-3">
  <label class="block text-xs text-slate-400 mb-1" for="verb-density">Verb Density:</label>
  <input type="range" id="verb-density" min="1" max="5" value="3" class="slider-thumb w-full"/>
</div>
<div class="mb-3">
  <label class="block text-xs text-slate-400 mb-1" for="sentence-rhythm">Sentence Rhythm:</label>
  <select id="sentence-rhythm" class="w-full text-xs bg-slate-800 border border-slate-600 rounded p-1">
    <option value="varied">Varied</option>
    <option value="short-punchy">Short & Punchy</option>
    <option value="long-runons">Long Run-ons</option>
    <option value="musical">Musical Flow</option>
  </select>
</div>
<div class="mb-3">
  <label class="block text-xs text-slate-400 mb-1" for="backstory-injection">Backstory Injection:</label>
  <textarea id="backstory-injection" rows="2" placeholder="e.g., this character used to be a pro skater" class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs"></textarea>
</div>
<div class="mb-3">
  <label class="block text-xs text-slate-400 mb-1" for="emotion-arc">Emotion Arc:</label>
  <select id="emotion-arc" class="w-full text-xs bg-slate-800 border border-slate-600 rounded p-1">
    <option value="neutral">Neutral</option>
    <option value="rise-fall">Rise & Fall</option>
    <option value="fall-rise">Fall then Rise</option>
    <option value="volatile">Chaotic Mood Swings</option>
  </select>
</div>
<div class="mb-3">
  <label class="block text-xs text-slate-400 mb-1" for="shock-value">Shock Value: <span class="font-bold text-cyan-400" id="shock-value-label">3</span></label>
  <input type="range" id="shock-value" min="1" max="5" value="3" class="slider-thumb w-full"/>
</div>
<div class="mb-3">
  <label class="block text-xs text-slate-400 mb-1" for="callback-count">Number of Callbacks:</label>
  <input type="number" id="callback-count" min="0" max="10" value="1" class="w-full bg-slate-800 border border-slate-600 rounded p-1 text-xs"/>
</div>
<div class="mb-3">
  <label class="block text-xs text-slate-400 mb-1" for="conflict-type">Primary Conflict Type:</label>
  <select id="conflict-type" class="w-full text-xs bg-slate-800 border border-slate-600 rounded p-1">
    <option value="internal">Internal (psychological)</option>
    <option value="social">Social (drama, beef)</option>
    <option value="absurdist">Absurdist (nonsense)</option>
    <option value="physical">Physical (slapstick)</option>
    <option value="cosmic">Cosmic (existential/AI/God)</option>
  </select>
</div>
<div class="mb-3">
  <label class="block text-xs text-slate-400 mb-1" for="generation-seed">Generation Seed (Optional):</label>
  <input type="text" id="generation-seed" placeholder="e.g., 42, chaos23" class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs"/>
</div>
<div class="animated-divider"></div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="pacing-variation-slider">
        Pacing Variation: <span class="font-bold text-cyan-400" id="pacing-variation-value">Medium</span>
    </label>
    <input class="w-full slider-thumb" id="pacing-variation-slider" max="5" min="1" type="range" value="3"/>
</div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="unexpectedness-slider">
        Unexpectedness: <span class="font-bold text-cyan-400" id="unexpectedness-value">Balanced</span>
    </label>
    <input class="w-full slider-thumb" id="unexpectedness-slider" max="5" min="1" type="range" value="3"/>
</div>
<div class="flex items-center justify-between gap-3 p-2 rounded-md bg-slate-800/50 mb-3">
    <label class="text-sm cursor-pointer select-none" for="anti-humor-toggle">Anti-Humor Mode</label>
    <label class="switch"><input id="anti-humor-toggle" type="checkbox"/><span class="slider round"></span></label>
</div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="joke-source-adherence-slider">
        Joke Source Adherence: <span class="font-bold text-cyan-400" id="joke-source-adherence-value">50%</span>
    </label>
    <input class="w-full slider-thumb" id="joke-source-adherence-slider" max="100" min="0" type="range" value="50"/>
</div>
</div>
<!-- Topics Tab -->
<div class="tab-panel" id="tab-topics">
<!-- More Topic Controls -->
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="topic-priority-mode">Topic Priority Mode:</label>
<select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs" id="topic-priority-mode">
<option value="balanced">Balanced</option>
<option value="strict">Strict Topic Enforcement</option>
<option value="loose">Loose Theme Matching</option>
<option value="randomized">Chaotic Topic Use</option>
</select>
</div>
<div id="topic-controls">
<p class="text-sm text-slate-400 mb-2 tracking-widest text-center">TOPIC MATRIX</p>
<div class="flex flex-wrap justify-center gap-2 mb-3" id="topic-grid"></div>
<div class="grid grid-cols-3 gap-2 text-xs mb-3">
<button class="toggle-btn !text-xs !py-1" id="select-all-topics-btn">Select All</button>
<button class="toggle-btn !text-xs !py-1" id="deselect-all-topics-btn">Deselect All</button>
<button class="toggle-btn !text-xs !py-1" id="randomize-topics-btn">Randomize</button>
</div>
<div class="flex gap-2 mb-3">
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="custom-topic-input" placeholder="Add custom topic..." type="text"/>
<button class="toggle-btn !text-xs !py-1 !w-auto px-3" id="add-topic-btn">Add</button>
</div>
<div class="text-center">
<button class="toggle-btn !text-xs !py-2 !px-4" id="ai-topic-suggestion-btn">AI Suggest Topics</button>
</div>
</div>
<div class="animated-divider"></div> <!-- Animated Divider -->
<div class="border-t border-slate-700/50 pt-3 mt-4">
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="topic-influence-slider">Topic Influence: <span class="font-bold text-cyan-400" id="topic-influence-value">Balanced</span></label>
<input class="w-full slider-thumb" id="topic-influence-slider" max="5" min="1" type="range" value="3"/>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="exclude-topics-textarea">Exclude Topics (one per line):</label>
<textarea class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="exclude-topics-textarea" placeholder="e.g., politics
sports" rows="2"></textarea>
</div>
<div class="flex justify-between items-center mt-4">
<label class="block text-xs text-slate-400 mb-1">Topic Clustering:</label>
<button class="toggle-btn !text-xs !py-1 !w-auto px-3" id="manage-clusters-btn">Manage Clusters</button>
</div>
<div class="flex gap-2">
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-1/2 text-xs focus:ring-cyan-500 focus:border-cyan-500" id="cluster-name-input" placeholder="Cluster Name" type="text"/>
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-1/4 h-8" id="cluster-color-input" type="color" value="#22d3ee"/>
<button class="toggle-btn !text-xs !py-1 !w-auto px-3" id="create-cluster-btn">Create Cluster</button>
</div>
</div>
<div class="animated-divider"></div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="topic-combination-logic">Topic Combination Logic:</label>
    <select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs" id="topic-combination-logic">
        <option value="intersection">Intersection (All selected)</option>
        <option value="union" selected>Union (Any selected)</option>
        <option value="weighted_random">Weighted Random</option>
    </select>
</div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="topic-relatedness-slider">
        Topic Relatedness (Chain/Remix): <span class="font-bold text-cyan-400" id="topic-relatedness-value">High</span>
    </label>
    <input class="w-full slider-thumb" id="topic-relatedness-slider" max="5" min="1" type="range" value="4"/>
</div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="max-new-topics">Max New Topics per Joke:</label>
    <input class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs" id="max-new-topics" type="number" value="2" min="0" max="5"/>
</div>
</div>
</div>
<!-- Content Tab -->
<div class="tab-panel" id="tab-content">
<!-- More Content Controls -->
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="punchline-style">Punchline Style:</label>
<select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs" id="punchline-style">
<option value="twist">Surprise Twist</option>
<option value="callback">Callback</option>
<option value="shock">Shock Factor</option>
<option value="dry">Dry/Witty</option>
</select>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="sentence-structure">Preferred Sentence Structure:</label>
<select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs" id="sentence-structure">
<option value="any">Any</option>
<option value="compound">Compound Sentences</option>
<option value="fragmented">Fragmented Style</option>
<option value="run-on">Run-On Chaos</option>
</select>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="guaranteed-words">Guaranteed Words:</label>
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="guaranteed-words" placeholder="e.g., uncle, whiplash" type="text"/>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="starts-with">Starts With (one per line):</label>
<textarea class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="starts-with" placeholder="e.g., yo uncle
nigga you" rows="2"></textarea>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="scenario-list">Scenario List (one per line):</label>
<textarea class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="scenario-list" placeholder="e.g., during a job interview
at a funeral" rows="3"></textarea>
<div class="flex items-center gap-2 mt-2">
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="current-scenario" placeholder="Current Scenario (or enter manually)" type="text"/>
<button class="toggle-btn !text-xs !py-1 !w-auto px-3" id="random-scenario-btn">Random</button>
<button class="toggle-btn !text-xs !py-1 !w-auto px-3" id="clear-scenario-btn">Clear</button>
</div>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="cultural-context">Cultural Context (one per line):</label>
<textarea class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="cultural-context" placeholder="e.g., 90s skateboarding
Warhammer 40k lore
anime, k-pop" rows="2"></textarea>
</div>
<div class="animated-divider"></div>
<div class="mb-3 flex justify-between items-center gap-4">
<div>
<label class="block text-xs text-slate-400 mb-1" for="min-words">Min Words:</label>
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-20 text-center text-xs" id="min-words" max="50" min="1" type="number" value="5"/>
</div>
<div>
<label class="block text-xs text-slate-400 mb-1" for="max-words">Max Words:</label>
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-20 text-center text-xs" id="max-words" max="100" min="1" type="number" value="20"/>
</div>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="complexity-level">Complexity/Vocabulary:</label>
<input class="w-full slider-thumb" id="complexity-level" max="10" min="1" type="range" value="5"/>
<span class="text-xs text-cyan-400 text-right block mt-1" id="complexity-value">Medium</span>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="joke-tone">Tone/Mood:</label>
<select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="joke-tone">
<option value="any">Any</option>
<option value="sarcastic">Sarcastic</option>
<option value="absurd">Absurd</option>
<option value="dark">Dark</option>
<option value="lighthearted">Lighthearted</option>
<option value="cynical">Cynical</option>
<option value="ironic">Ironic</option>
</select>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="humor-type">Humor Type:</label>
<select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="humor-type">
<option value="any">Any</option>
<option value="observational">Observational</option>
<option value="slapstick">Slapstick</option>
<option value="wordplay">Wordplay</option>
<option value="dark humor">Dark Humor</option>
<option value="surreal">Surreal</option>
<option value="satirical">Satirical</option>
</select>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="joke-structure">Joke Structure:</label>
<select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="joke-structure">
<option value="any">Any (Standard)</option>
<option value="question-answer">Question &amp; Answer</option>
<option value="dialogue">Short Dialogue</option>
<option value="one-liner">Punchy One-Liner</option>
</select>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="slang-level-slider">Slang/Jargon Level: <span class="font-bold text-cyan-400" id="slang-level-value">Normal</span></label>
<input class="w-full slider-thumb" id="slang-level-slider" max="5" min="1" type="range" value="3"/>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="narrator-persona">Narrator Persona:</label>
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="narrator-persona" placeholder="e.g., a tired robot, an ancient wizard" type="text"/>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="target-audience">Target Audience:</label>
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="target-audience" placeholder="e.g., adults, gamers, sci-fi fans" type="text"/>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="forbidden-constraints">Forbidden Constraints (Negative Prompt):</label>
<textarea class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="forbidden-constraints" placeholder="Words or themes to avoid (e.g., politics, puns, the word 'moist')" rows="2"></textarea>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="excluded-words">Excluded Words:</label>
<textarea class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="excluded-words" placeholder="Specific words to exclude" rows="2"></textarea>
</div>
<div class="animated-divider"></div> <!-- Animated Divider -->
<div class="text-center mt-4">
<button class="toggle-btn !text-xs !py-2 !px-4" id="clear-content-inputs-btn">Clear All Content Inputs</button>
</div>
<div class="animated-divider"></div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="character-trait-injection">Character Traits (one per line):</label>
    <textarea class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="character-trait-injection" placeholder="e.g., clumsy, arrogant, always hungry" rows="2"></textarea>
</div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="emotional-tone-shift">Emotional Tone Shift:</label>
    <select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs" id="emotional-tone-shift">
        <option value="none" selected>None</option>
        <option value="positive_to_negative">Positive to Negative</option>
        <option value="negative_to_positive">Negative to Positive</option>
        <option value="sudden_twist">Sudden Twist</option>
    </select>
</div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="sensory-detail-focus">Sensory Detail Focus:</label>
    <select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs" id="sensory-detail-focus">
        <option value="any" selected>Any</option>
        <option value="visual">Visual</option>
        <option value="auditory">Auditory</option>
        <option value="tactile">Tactile</option>
        <option value="olfactory_gustatory">Olfactory/Gustatory</option>
    </select>
</div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="abstract-level-slider">
        Abstract vs. Concrete: <span class="font-bold text-cyan-400" id="abstract-level-value">Balanced</span>
    </label>
    <input class="w-full slider-thumb" id="abstract-level-slider" max="5" min="1" type="range" value="3"/>
</div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="pop-culture-specificity">Pop Culture Specificity:</label>
    <select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs" id="pop-culture-specificity">
        <option value="generic" selected>Generic</option>
        <option value="specific">Specific (e.g., exact movie name)</option>
        <option value="obscure_niche">Obscure/Niche</option>
    </select>
</div>
</div>
<!-- Advanced Tab -->
<div class="tab-panel" id="tab-advanced">
<!-- More Advanced Settings -->
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="humor-algorithm-mode">Humor Algorithm Mode:</label>
<select class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs" id="humor-algorithm-mode">
<option value="default">Default Model</option>
<option value="experimental">Experimental Mode</option>
<option value="mimic">Mimic Celebrity Voice</option>
<option value="chaotic">Chaotic Neural Net</option>
</select>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="entropy-bias">Entropy Bias:</label>
<input class="w-full slider-thumb" id="entropy-bias" max="10" min="0" type="range" value="5"/>
</div>
<div class="mb-4 border-b border-slate-700/50 pb-4">
<label class="block text-xs text-slate-400 mb-1" for="theme-color-picker">Theme Color:</label>
<input class="w-full h-10 p-1 bg-slate-800 border border-slate-600 rounded cursor-pointer" id="theme-color-picker" type="color" value="#22d3ee"/>
</div>
<div class="mb-3">
<label class="block text-xs text-slate-400 mb-1" for="inspirational-source">Joke Source:</label>
<textarea class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="inspirational-source" placeholder="Paste text here to match style (e.g., sample jokes)..." rows="4"></textarea>
</div>
<div class="mb-3">
<div class="flex justify-between items-center">
<label class="block text-xs text-slate-400 mb-1">Context Templates:</label>
<button class="toggle-btn !text-xs !py-1 !w-auto px-3" id="load-template-btn">Load Template</button>
</div>
<div class="flex gap-2">
<select class="bg-slate-800 border border-slate-600 rounded p-1 w-1/3 text-xs" id="template-category-select">
<option value="professional">Professional</option>
<option value="social">Social</option>
<option value="gaming">Gaming</option>
<option value="custom">Custom</option>
</select>
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-1/2 text-xs focus:ring-cyan-500 focus:border-cyan-500" id="template-name-input" placeholder="Template Name" type="text"/>
<button class="toggle-btn !text-xs !py-1 !w-auto px-3" id="save-template-btn">Save as Template</button>
</div>
</div>
<div class="mb-3">
<div class="flex justify-between items-center">
<label class="block text-xs text-slate-400 mb-1">Reference Library:</label>
<button class="toggle-btn !text-xs !py-1 !w-auto px-3" id="reference-library-btn">Open Library</button>
</div>
<div class="flex gap-2 mb-2">
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="reference-search-input" placeholder="Search References..." type="text"/>
<button class="toggle-btn !text-xs !py-1 !w-auto px-3" id="search-references-btn">Search</button>
</div>
<div class="flex gap-2">
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="reference-api-query" placeholder="Search API for References..." type="text"/>
<button class="toggle-btn !text-xs !py-1 !w-auto px-3" id="search-api-btn">Search API</button>
</div>
<div class="mt-2 text-xs text-slate-300" id="reference-results"></div>
</div>
<div>
<div class="flex justify-between items-center">
<label class="block text-xs text-slate-400 mb-1">Knowledge Base Manager:</label>
<button class="toggle-btn !text-xs !py-1 !w-auto px-3" id="knowledge-base-btn">Manage</button>
</div>
<div class="flex gap-2">
<select class="bg-slate-800 border border-slate-600 rounded p-1 w-1/2 text-xs" id="knowledge-base-select">
<option value="">Select Knowledge Base</option>
</select>
<input class="bg-slate-800 border border-slate-600 rounded p-1 w-1/2 text-xs focus:ring-cyan-500 focus:border-cyan-500" id="knowledge-base-keywords" placeholder="Keywords for Retrieval (optional)" type="text"/>
</div>
</div>
<div class="animated-divider"></div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="temperature-override-slider">
        Generation Temperature: <span class="font-bold text-cyan-400" id="temperature-override-value">1.0</span>
    </label>
    <input class="w-full slider-thumb" id="temperature-override-slider" max="2.0" min="0.1" step="0.1" type="range" value="1.0"/>
</div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="top-p-override-slider">
        Top-P Sampling: <span class="font-bold text-cyan-400" id="top-p-override-value">0.95</span>
    </label>
    <input class="w-full slider-thumb" id="top-p-override-slider" max="1.0" min="0.1" step="0.05" type="range" value="0.95"/>
</div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="repetition-penalty-slider">
        Repetition Penalty: <span class="font-bold text-cyan-400" id="repetition-penalty-value">1.1</span>
    </label>
    <input class="w-full slider-thumb" id="repetition-penalty-slider" max="2.0" min="1.0" step="0.1" type="range" value="1.1"/>
</div>
<div class="mb-3">
    <label class="block text-xs text-slate-400 mb-1" for="custom-instruction-injection">Custom Instruction (Current Joke):</label>
    <textarea class="bg-slate-800 border border-slate-600 rounded p-1 w-full text-xs focus:ring-cyan-500 focus:border-cyan-500" id="custom-instruction-injection" placeholder="e.g., Make it rhyme, End with a question" rows="2"></textarea>
</div>
</div>
</div>
</div>
<!-- Generate Button -->
<div class="mt-8 relative">
<div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2" id="spinner" style="display:none;">
<div class="spinner"></div>
</div>
<button class="btn-gradient text-white font-bold py-4 px-14 rounded-full text-lg shadow-2xl shadow-cyan-500/20 focus:outline-none focus:ring-4 focus:ring-cyan-500/50" data-hotkey="g" id="generate-btn">
                Generate
            </button>
</div>
<!-- Hotkeys & FAQ Buttons -->
<div class="mt-8 flex justify-center gap-4">
<button class="toggle-btn !text-xs !py-2 !px-4 !rounded-full" data-hotkey="h" id="hotkeys-btn">Hotkeys</button>
<button class="toggle-btn !text-xs !py-2 !px-4 !rounded-full" data-hotkey="f" id="faq-btn">FAQ &amp; Guide</button>
</div>
</div>
<!-- Modals (Hidden by default, will be shown by JS) -->
<div class="modal hidden" id="topicClustersModal">
<div class="modal-content">
<span class="modal-close" data-modal-id="topicClustersModal">Ã—</span>
<h2 class="text-2xl mb-4">Topic Cluster Management</h2>
<p>Functionality to create, view, and manage topic clusters will be here.</p>
</div>
</div>
<div class="modal hidden" id="referenceLibraryModal">
<div class="modal-content">
<span class="modal-close" data-modal-id="referenceLibraryModal">Ã—</span>
<h2 class="text-2xl mb-4">Reference Library</h2>
<p>Functionality to add, search, and use references will be here.</p>
</div>
</div>
<div class="modal hidden" id="knowledgeBaseModal">
<div class="modal-content">
<span class="modal-close" data-modal-id="knowledgeBaseModal">Ã—</span>
<h2 class="text-2xl mb-4">Knowledge Base Manager</h2>
<p>Functionality to create, upload, and manage knowledge bases will be here.</p>
</div>
</div>
<div class="modal hidden" id="hotkeysModal">
<div class="modal-content">
<span class="modal-close" data-modal-id="hotkeysModal">Ã—</span>
<h2 class="2xl mb-4">Keyboard Shortcuts</h2>
<ul class="text-left leading-relaxed">
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">Ctrl</kbd> + <kbd class="bg-gray-700 px-2 py-1 rounded">Enter</kbd> / <kbd class="bg-gray-700 px-2 py-1 rounded">G</kbd>: Generate Pack</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">C</kbd> (when joke displayed): Copy Joke(s) to Clipboard</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">1</kbd> / <kbd class="bg-gray-700 px-2 py-1 rounded">2</kbd> / <kbd class="bg-gray-700 px-2 py-1 rounded">3</kbd> / <kbd class="bg-gray-700 px-2 py-1 rounded">4</kbd>: Switch Tabs (Generation, Topics, Content, Advanced)</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">T</kbd>: Toggle Theme Lock (if enabled)</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">B</kbd>: Toggle Batch Mode</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">L</kbd>: Toggle Avoid Repetition</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">I</kbd>: Increase Detail Level (slider)</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">O</kbd>: Increase Creativity Level (slider)</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">R</kbd>: Randomize Topics</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">A</kbd>: Select All Topics</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">D</kbd>: Deselect All Topics</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">U</kbd>: Focus Exclude Topics textarea</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">J</kbd>: AI Suggest Topics</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">S</kbd>: Random Scenario</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">E</kbd>: Clear Current Scenario</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">Alt</kbd> + <kbd class="bg-gray-700 px-2 py-1 rounded">C</kbd>: Clear All Content Inputs</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">H</kbd>: Open/Close Hotkeys Guide</li>
<li class="mb-2"><kbd class="bg-gray-700 px-2 py-1 rounded">F</kbd>: Open/Close FAQ &amp; Guide</li>
</ul>
</div>
</div>
<div class="modal hidden" id="faqModal">
<div class="modal-content">
<span class="modal-close" data-modal-id="faqModal">Ã—</span>
<h2 class="text-2xl mb-4 text-center">FAQ &amp; Guide</h2>
<div class="faq-section mb-4">
<h3 class="text-xl text-cyan-400 mb-2">What is OBLITERATE PACKGEN?</h3>
<p class="text-sm text-slate-300">OBLITERATE PACKGEN is an AI-powered joke generator specialized in creating surreal, observational roast humor with modern street slang and AAVE, designed to mimic a very specific comedic style.</p>
</div>
<div class="faq-section mb-4">
<h3 class="text-xl text-cyan-400 mb-2">Point of View</h3>
<ul class="text-sm text-slate-300 list-disc list-inside">
<li>**You (Second-person)**: Jokes directly address the subject.</li>
<li>**He (Third-person)**: Jokes observe the subject from an external perspective.</li>
<li>**I saw (First-person)**: Jokes are framed as personal anecdotes.</li>
</ul>
</div>
<div class="faq-section mb-4">
<h3 class="text-xl text-cyan-400 mb-2">Generation Tab</h3>
<ul class="text-sm text-slate-300 list-disc list-inside">
<li>**Modes**:
                        <ul class="list-circle list-inside ml-4">
<li>**Single**: Generates one standalone joke.</li>
<li>**Story Chain** (Disabled until first joke): Continues the narrative from the previous joke.</li>
<li>**Remix** (Disabled until first joke): Creates a variation of the previous joke, maintaining a similar structure.</li>
<li>**Escalation**: Increases the absurdity level with each subsequent generation.</li>
</ul>
</li>
<li>**Theme Lock**: When active, subsequent jokes will stick to the same theme or subject as the last generated joke.</li>
<li>**Batch Mode**: Generates multiple jokes (steps) at once, displayed as a list.</li>
<li>**Absurdity Slider**: Controls the level of surrealism and outlandishness in the jokes (1 = mild, 10 = extreme).</li>
<li>**Detail Level Slider**: Controls the verbosity and descriptive richness of the joke (e.g., "Brief" for short, punchy; "Highly Descriptive" for more elaborate).</li>
<li>**Creativity Level Slider**: Adjusts how much the AI adheres to strict constraints (lower values) versus generating more novel, unexpected, or "out-of-the-box" content (higher values).</li>
<li>**Avoid Repetition Toggle**: When enabled, the AI will try to actively avoid repeating similar concepts, phrases, or joke structures that it has recently generated.</li>
</ul>
</div>
<div class="faq-section mb-4">
<h3 class="text-xl text-cyan-400 mb-2">Topics Tab</h3>
<ul class="text-sm text-slate-300 list-disc list-inside">
<li>**Topic Matrix**: Select predefined topics to guide the joke's subject matter.</li>
<li>**Select All / Deselect All / Randomize**: Quickly manage your topic selections.</li>
<li>**Add Custom Topic**: Add your own topics to the matrix.</li>
<li>**AI Suggest Topics**: Prompts the AI to generate new topic ideas based on its general knowledge.</li>
<li>**Topic Influence Slider**: Controls how strongly the selected topics must be incorporated into the generated joke (1 = suggestion, 5 = strict adherence).</li>
<li>**Exclude Topics**: Explicitly list topics or keywords that the AI must avoid when generating the joke.</li>
<li>**Topic Clustering**: (Placeholder) Future feature for grouping topics.</li>
</ul>
</div>
<div class="faq-section mb-4">
<h3 class="text-xl text-cyan-400 mb-2">Content Tab</h3>
<ul class="text-sm text-slate-300 list-disc list-inside">
<li>**Guaranteed Words**: Force specific words to appear in the joke.</li>
<li>**Starts With**: Specify phrases the joke must begin with (one per line).</li>
<li>**Scenario List**: Provide a list of settings for the joke; "Random" picks one, "Clear" removes it.</li>
<li>**Cultural Context**: Include references to specific cultural elements.</li>
<li>**Min/Max Words**: Set the length constraints for the joke.</li>
<li>**Complexity/Vocabulary**: Adjust the linguistic sophistication.</li>
<li>**Tone/Mood**: Define the emotional flavor of the humor.</li>
<li>**Humor Type**: Specify the style of comedy.</li>
<li>**Target Audience**: Tailor the joke to a specific demographic.</li>
<li>**Forbidden Constraints (Negative Prompt)**: List words or themes to explicitly avoid.</li>
<li>**Excluded Words**: Ensure specific words do not appear in the output.</li>
<li>**Clear All Content Inputs**: Resets all fields in this tab.</li>
</ul>
</div>
<div class="faq-section mb-4">
<h3 class="text-xl text-cyan-400 mb-2">Advanced Tab</h3>
<ul class="text-sm text-slate-300 list-disc list-inside">
<li>**Theme Color Picker**: Changes the accent color of the entire UI and background particles.</li>
<li>**Joke Source**: Paste text here to match style. This overrides other stylistic settings to ensure precise imitation.</li>
<li>**Context Templates**: (Placeholder) For saving and loading sets of content parameters.</li>
<li>**Reference Library**: (Placeholder) For managing external reference materials.</li>
<li>**Knowledge Base Manager**: (Placeholder) For integrating custom knowledge bases.</li>
</ul>
</div>
</div>
</div>
<script>
        // --- INITIALIZATION & SETUP ---
        const jokeDisplayTextElement = document.getElementById('joke-display-text'); 
        const generateBtn = document.getElementById('generate-btn');
        const spinner = document.getElementById('spinner');
        const copyBtn = document.getElementById('copy-btn');
        const copyIcon = document.getElementById('copy-icon');
        const copyFeedback = document.getElementById('copy-feedback');
        const jokeCard = document.getElementById('joke-card');
        const glare = jokeCard.querySelector('.glare');
        const jokeDisplayArea = document.getElementById('joke-display-area');
        const povSelector = document.getElementById('pov-selector');
        const modeSelector = document.getElementById('mode-selector');
        const themeLockToggle = document.getElementById('theme-lock-toggle');
        const batchToggle = document.getElementById('batch-toggle');
        const batchControls = document.getElementById('batch-controls');
        const batchSteps = document.getElementById('batch-steps');
        const absurditySlider = document.getElementById('absurdity-slider');
        const absurdityValue = document.getElementById('absurdity-value');
        const topicControls = document.getElementById('topic-controls');
        const topicGrid = document.getElementById('topic-grid');
        const selectAllTopicsBtn = document.getElementById('select-all-topics-btn');
        const deselectAllTopicsBtn = document.getElementById('deselect-all-topics-btn');
        const randomizeTopicsBtn = document.getElementById('randomize-topics-btn');
        const customTopicInput = document.getElementById('custom-topic-input');
        const addTopicBtn = document.getElementById('add-topic-btn');
        const guaranteedWordsInput = document.getElementById('guaranteed-words');
        const startsWithTextarea = document.getElementById('starts-with');
        const scenarioListTextarea = document.getElementById('scenario-list');
        const currentScenarioInput = document.getElementById('current-scenario');
        const randomScenarioBtn = document.getElementById('random-scenario-btn');
        const clearScenarioBtn = document.getElementById('clear-scenario-btn');
        const culturalContextTextarea = document.getElementById('cultural-context');
        const inspirationalSourceTextarea = document.getElementById('inspirational-source'); 
        const forbiddenConstraintsTextarea = document.getElementById('forbidden-constraints');
        const excludedWordsTextarea = document.getElementById('excluded-words');
        const clearContentInputsBtn = document.getElementById('clear-content-inputs-btn');
        const manageClustersBtn = document.getElementById('manage-clusters-btn');
        const clusterNameInput = document.getElementById('cluster-name-input');
        const clusterColorInput = document.getElementById('cluster-color-input');
        const createClusterBtn = document.getElementById('create-cluster-btn');
        const loadTemplateBtn = document.getElementById('load-template-btn');
        const templateCategorySelect = document.getElementById('template-category-select');
        const templateNameInput = document.getElementById('template-name-input');
        const saveTemplateBtn = document.getElementById('save-template-btn');
        const referenceLibraryBtn = document.getElementById('reference-library-btn');
        const referenceSearchInput = document.getElementById('reference-search-input');
        const searchReferencesBtn = document.getElementById('search-references-btn');
        const referenceApiQueryInput = document.getElementById('reference-api-query');
        const searchApiBtn = document.getElementById('search-api-btn');
        const knowledgeBaseBtn = document.getElementById('knowledge-base-btn');
        const knowledgeBaseSelect = document.getElementById('knowledge-base-select');
        const themeColorPicker = document.getElementById('theme-color-picker');
        const hotkeysBtn = document.getElementById('hotkeys-btn');
        const faqBtn = document.getElementById('faq-btn');

        // --- Newly Added Control Elements ---

        // Generation Tab
        const pacingVariationSlider = document.getElementById('pacing-variation-slider');
        const pacingVariationValue = document.getElementById('pacing-variation-value');
        const unexpectednessSlider = document.getElementById('unexpectedness-slider');
        const unexpectednessValue = document.getElementById('unexpectedness-value');
        const antiHumorToggle = document.getElementById('anti-humor-toggle');
        const jokeSourceAdherenceSlider = document.getElementById('joke-source-adherence-slider');
        const jokeSourceAdherenceValue = document.getElementById('joke-source-adherence-value');

        // Topics Tab
        const topicCombinationLogicSelect = document.getElementById('topic-combination-logic');
        const topicRelatednessSlider = document.getElementById('topic-relatedness-slider');
        const topicRelatednessValue = document.getElementById('topic-relatedness-value');
        const maxNewTopicsInput = document.getElementById('max-new-topics');

        // Content Tab
        const characterTraitInjectionTextarea = document.getElementById('character-trait-injection');
        const emotionalToneShiftSelect = document.getElementById('emotional-tone-shift');
        const sensoryDetailFocusSelect = document.getElementById('sensory-detail-focus');
        const abstractLevelSlider = document.getElementById('abstract-level-slider');
        const abstractLevelValue = document.getElementById('abstract-level-value');
        const popCultureSpecificitySelect = document.getElementById('pop-culture-specificity');

        // Advanced Tab
        const temperatureOverrideSlider = document.getElementById('temperature-override-slider');
        const temperatureOverrideValue = document.getElementById('temperature-override-value');
        const topPOverrideSlider = document.getElementById('top-p-override-slider');
        const topPOverrideValue = document.getElementById('top-p-override-value');
        const repetitionPenaltySlider = document.getElementById('repetition-penalty-slider');
        const repetitionPenaltyValue = document.getElementById('repetition-penalty-value');
        const customInstructionInjectionTextarea = document.getElementById('custom-instruction-injection');
        
        // --- Existing Content control elements ---
        const minWordsInput = document.getElementById('min-words');
        const maxWordsInput = document.getElementById('max-words');
        const complexityLevelSlider = document.getElementById('complexity-level');
        const complexityValueSpan = document.getElementById('complexity-value');
        const jokeToneSelect = document.getElementById('joke-tone');
        const humorTypeSelect = document.getElementById('humor-type');
        const targetAudienceInput = document.getElementById('target-audience');
        const jokeStructureSelect = document.getElementById('joke-structure');
        const slangLevelSlider = document.getElementById('slang-level-slider');
        const slangLevelValueSpan = document.getElementById('slang-level-value');
        const narratorPersonaInput = document.getElementById('narrator-persona');

        // --- Existing Generation Tab elements ---
const jokeLengthSlider = document.getElementById('joke-length-slider');
const jokeLengthValue = document.getElementById('joke-length-value');

const lengthSettings = {
    1: { label: "Very Short", min: 3, max: 6 },
    2: { label: "Short", min: 5, max: 10 },
    3: { label: "Medium", min: 10, max: 20 },
    4: { label: "Long", min: 25, max: 50 },
    5: { label: "Epic & Convoluted", min: 50, max: 120 }
};

jokeLengthSlider.addEventListener('input', () => {
    const val = jokeLengthSlider.value;
    jokeLengthValue.textContent = lengthSettings[val].label;
    minWordsInput.value = lengthSettings[val].min;
    maxWordsInput.value = lengthSettings[val].max;
});

        const detailLevelSlider = document.getElementById('detail-level-slider');
        const detailLevelValueSpan = document.getElementById('detail-level-value');
        const creativityLevelSlider = document.getElementById('creativity-level-slider');
        const creativityLevelValueSpan = document.getElementById('creativity-level-value');
        const avoidRepetitionToggle = document.getElementById('avoid-repetition-toggle');

        // --- Existing Topics Tab elements ---
        const topicInfluenceSlider = document.getElementById('topic-influence-slider');
        const topicInfluenceValueSpan = document.getElementById('topic-influence-value');
        const excludeTopicsTextarea = document.getElementById('exclude-topics-textarea');
        const aiTopicSuggestionBtn = document.getElementById('ai-topic-suggestion-btn');

        // --- State Variables ---
        let canCopy = false;
        let scrambleInterval, typewriterInterval;
        let lastGeneratedJoke = null;
        let currentMode = 'single';
        let absurdity = 5;
        let isThemeLocked = false;
        let isBatchMode = false;
        let availableTopics = ['Food', 'Animals', 'Tech', 'History', 'Space', 'Sports', 'Music', 'Movies', 'Random']; 
        let selectedTopics = [];
        let punchlineBlacklist = new Set();
        let usedWords = new Set();
        let usedThemes = new Set();
        let usedScenarios = new Set();
        let usedFamilyMembers = new Set();
        let usedObjects = new Set();
        let usedActions = new Set();
        let usedComparisons = new Set();        let currentScenario = '';
        let randomScenarioMode = false;
        let savedTemplates = {};
        let currentTemplateCategory = 'custom';
        let references = [];
        let knowledgeBases = [];
        let selectedKnowledgeBase = '';
        let knowledgeBaseKeywords = '';
        const themeVariations = {
            familyMembers: ['uncle', 'dad', 'mom', 'cousin', 'brother', 'sister', 'grandma', 'grandpa', 'aunt'],
            objects: ['toilet', 'shower', 'oven', 'alarm clock', 'remote', 'belt', 'stapler', 'cardboard', 'fire hose', 'hotdog', 'jar', 'toolbox', 'knuckles', 'anchor', 'hat'],
            actions: ['walk', 'run', 'jump', 'fly', 'dive', 'throw', 'drop', 'pour', 'tie', 'wear', 'use', 'steal', 'serve', 'flush', 'spit'],
            comparisons: ['like', 'as if', 'just like', 'similar to', 'resembling', 'matching', 'copying'],
            locations: ['attic', 'sink', 'bathroom', 'kitchen', 'living room', 'bedroom', 'garage', 'basement', 'roof'],
            situations: ['instead of', 'when', 'why', 'because', 'after', 'before', 'while']
        };

        const tabsNav = document.getElementById('tabs-nav');
        const tabsContent = document.getElementById('tabs-content');

        // --- HELPER FUNCTIONS ---
        function hexToHSL(H) {
            let r = 0, g = 0, b = 0;
            if (H.length == 4) {
                r = "0x" + H[1] + H[1];
                g = "0x" + H[2] + H[2];
                b = "0x" + H[3] + H[3];
            } else if (H.length == 7) {
                r = "0x" + H[1] + H[2];
                g = "0x" + H[3] + H[4];
                b = "0x" + H[5] + H[6];
            }
            r /= 255; g /= 255; b /= 255;
            let cmin = Math.min(r,g,b), cmax = Math.max(r,g,b), delta = cmax - cmin, h = 0, s = 0, l = 0;
            if (delta == 0) h = 0;
            else if (cmax == r) h = ((g - b) / delta) % 6;
            else if (cmax == g) h = (b - r) / delta + 2;
            else h = (r - g) / delta + 4;
            h = Math.round(h * 60);
            if (h < 0) h += 360;
            l = (cmax + cmin) / 2;
            s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
            s = +(s * 100).toFixed(1);
            l = +(l * 100).toFixed(1);
            return { h, s, l };
        }
        function getRandomUnusedVariations() {
            const variations = {};
            for (const [category, items] of Object.entries(themeVariations)) {
                const unused = items.filter(item => !usedWords.has(item)); // A simple check against usedWords is good enough
                if (unused.length > 0) {
                    variations[category] = unused.slice(0, 3).join(', '); // Suggest a few
                }
            }
            return variations;
        }

        function trackUsedContent(joke) {
            if (!joke) return;
            const lowerJoke = joke.toLowerCase();
            
            // Track individual words
            const words = lowerJoke.split(/\s+/);
            words.forEach(word => {
                if (word.length > 3) usedWords.add(word);
            });

            // Track family members
            const familyPattern = /(yo\s+(uncle|dad|mom|cousin|brother|sister|grandma|grandpa|aunt)|your\s+(uncle|dad|mom|cousin|brother|sister|grandma|grandpa|aunt))/gi;
            const familyMatches = lowerJoke.match(familyPattern) || [];
            familyMatches.forEach(match => usedFamilyMembers.add(match));

            // Track objects
            const objectPattern = /(toilet|shower|oven|alarm clock|remote|belt|stapler|cardboard|fire hose|hotdog|jar|toolbox|knuckles|anchor|hat)/gi;
            const objectMatches = lowerJoke.match(objectPattern) || [];
            objectMatches.forEach(match => usedObjects.add(match));

            // Track actions
            const actionPattern = /(walk|run|jump|fly|dive|throw|drop|pour|tie|wear|use|steal|serve|flush|spit)(?:ed|ing|s)?/gi;
            const actionMatches = lowerJoke.match(actionPattern) || [];
            actionMatches.forEach(match => usedActions.add(match));

            // Track comparisons
            const comparisonPattern = /(like|as if|just like|similar to|resembling|matching|copying)/gi;
            const comparisonMatches = lowerJoke.match(comparisonPattern) || [];
            comparisonMatches.forEach(match => usedComparisons.add(match));

            // Track scenarios
            const scenarioPattern = /(instead of|when|why|because|after|before|while).*?(?=\s|$)/gi;
            const scenarioMatches = lowerJoke.match(scenarioPattern) || [];
            scenarioMatches.forEach(match => usedScenarios.add(match));
        }



       function updateThemeColor(color) {
            const root = document.documentElement;
            const hsl = hexToHSL(color);
            root.style.setProperty('--base-hue', hsl.h);
            root.style.setProperty('--accent-saturation', `${hsl.s}%`);
            root.style.setProperty('--accent-lightness', `${hsl.l}%`);
            if (particles && particles.material) {
                particles.material.color.set(color);
            }
            localStorage.setItem('packgenThemeColor', color);
        }

        // --- MODAL ELEMENTS (PLACEHOLDERS) ---
        const topicClustersModal = document.getElementById('topicClustersModal');
        const referenceLibraryModal = document.getElementById('referenceLibraryModal');
        const knowledgeBaseModal = document.getElementById('knowledgeBaseModal');
        const hotkeysModal = document.getElementById('hotkeysModal');
        const faqModal = document.getElementById('faqModal'); 
        
        // --- 3D TILT & GLARE EFFECT ---
        VanillaTilt.init(jokeCard, { max: 8, speed: 400, glare: false, perspective: 1500 });
        jokeCard.addEventListener('mousemove', (e) => {
            const rect = jokeCard.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const { width, height } = rect;
            glare.style.opacity = '1';
            glare.style.transform = `translate(${(x / width) * 100 - 50}%, ${(y / height) * 100 - 50}%)`;
        });
        jokeCard.addEventListener('mouseleave', () => { glare.style.opacity = '0'; });

        // --- AUDIO SETUP ---
        let synth, membraneSynth;
        document.body.addEventListener('click', async () => {
            try {
                if (typeof Tone === 'undefined') return;
                if (Tone.context.state !== 'running') await Tone.start();
                if (!synth) synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle8' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }, volume: -10 }).toDestination();
                if (!membraneSynth) membraneSynth = new Tone.MembraneSynth({ pitchDecay: 0.02, octaves: 4, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.3, sustain: 0.01, release: 0.6 }, volume: -8 }).toDestination();
            } catch (e) {
                console.error("Could not initialize audio.", e);
                synth = null; membraneSynth = null;
            }
        }, { once: true });
        
        // --- JOKE EXAMPLES ---
        // These examples are now primarily for fallback style if no Joke Source is provided
        // and to reinforce the overall style for the AI even when Joke Source is used.
        const exampleJokes = `
            - bill cosby cosplayed as yo uncle in jumanji
            - the last time you said sausage yo dad appeared in front of you like mr krabs in front of plankton
            - you threw an anchor down at yo uncle and make him walk the plank
            - yo uncle wear a backwards hat to appear good in the hood
            - yo walk downstairs and go straight to hell
            - you dropkicked the buttcrack monster out the window and served it back to him
            - you dont even got infinity stones you just put skittles on yo knuckles
            - nigga you uncle woke up in an operation game getting knocked back out with a toolbox
            - nigga you had to cave dive into a crevace in the sink and drowned before hitting the middle
            - instead of raking the leaves you use yo big ass overbite you got
            - you the first nigga in the world with cardboard for a bathroom door
            - yo dad got banned off rec room cuz he was gonna steal somebody afro in a sexual way
            - you had to serve your dad's life sentence after he died
            - nigga you got a remote to flush your toilet from long distances
            - when yo uncle died that nigga flew to the attic and ascended thee
            - why is yo alarm clock just eddie murphy getting stung by a bee on repeat
            - you use a stapler as a back scratcher
            - nigga yo uncle let you get ran over by the same car he saw coming two years ago just so he could say i told you so
            - nigga yo oven light is just a fire fly in a jar you caught last week
            - you pour milk on yo cereal with a fire hose
            - instead of a belt you just tie a really long hotdog around your waist
            - nigga your shower head is just your uncle spitting water on you
            - nigga you uncle got his ass whooped by liv morgan in the wrestling ring and then took her out for ice cream
            - nigga yo uncle poured a budweiser on yo cereal and said it's fine because it had foam in it
            - nigga you uncle tried to reenact the first self-sustaining nuclear reaction by pouring gasoline on yo forehead and lighting a match
        `;

        // --- CORE FUNCTIONS ---
        async function generateAIPack(params = {}) {
            const { mode = 'single', referenceJoke = null, absurdityLevel = 5, isLocked = false } = params;
            const activePovBtn = povSelector.querySelector('.toggle-btn.active');
            const pov = activePovBtn ? activePovBtn.dataset.pov : 'second'; 

            const povInstructions = {
            second: '- **Point of View:** Second-person direct address (e.g., "You are...", "yo...").',
            third: '- **Point of View:** Third-person observational (e.g., "He once...", "his uncle...").',
            first: '- **Point of View:** First-person anecdote (e.g., "I saw him...", "I remember when...").'
        };

        const jokeSource = inspirationalSourceTextarea.value.trim();

        let styleBlock = '';

            if (jokeSource) {
               styleBlock = `// STYLE INSTRUCTIONS //
- Your most critical instruction is to perfectly mimic the writing style, tone, structure, slang, grammar, punctuation, capitalization, and overall feel of the text provided under "Joke Source Style Guide".
- Your primary task is **CREATION**, not **REPETITION**. You must generate a **NEW, 100% ORIGINAL** joke.
- **CRITICALLY IMPORTANT: DO NOT repeat, rephrase, or use any part of the exact jokes from the "Joke Source Style Guide" verbatim.** The examples are ONLY to teach you the *style*. Your output must be completely unique.
- **Joke Source Style Guide (LEARN FROM THIS STYLE - DO NOT COPY THE CONTENT):**
${jokeSource}`;
            } else {
                const variations = getRandomUnusedVariations();
            styleBlock = `// STYLE INSTRUCTIONS //
- The joke must be in the style of surreal, absurd pop-culture reference jokes.
- It must be a single, punchy sentence, often starting with "dis nga," "yo," "that nigga," "you," or "yo uncle."
- The humor is absurd, observational, and often involves bizarre comparisons or scenarios.
- Your primary goal is to perfectly mimic the tone, structure, and linguistic patterns of the examples provided below.
- **CRITICAL: DO NOT REPEAT ANY OF THE EXAMPLE JOKES. Generate a completely new, unique joke that follows their style.**
- **Example jokes (for style reference only - DO NOT REPEAT THESE):**
${exampleJokes}

- **IMPORTANT: DO NOT USE THESE PREVIOUSLY USED ELEMENTS:**
  * Previously used family members: ${Array.from(usedFamilyMembers).join(', ') || 'None yet'}
  * Previously used objects: ${Array.from(usedObjects).join(', ') || 'None yet'}
  * Previously used actions: ${Array.from(usedActions).join(', ') || 'None yet'}
  * Previously used scenarios: ${Array.from(usedScenarios).join(', ') || 'None yet'}

- **SUGGESTED NEW VARIATIONS TO USE (try to incorporate some):**
  * Family members: ${variations.familyMembers || 'any unused family member'}
  * Objects: ${variations.objects || 'any unused object'}
  * Actions: ${variations.actions || 'any unused action'}
  * Locations: ${variations.locations || 'any unused location'}

- **Incorporate funny or slightly crude words like "uncle," "asscrack," "buttcrack," "nigga," "sausage," "crevace," "overbite," "thigh," "bellybutton," "toenail," "armpit," "earwax," "snot," "fart," "burp," "diaper," "booger," "gooch," or other similarly humorous terms, where appropriate to enhance the absurdity and punchline.**

- **Your task:** Generate ONE new, unique "pack" joke that has NEVER been seen before.
  * The joke must PERFECTLY match the style, cadence, and grammatical structure of the examples.
  * Avoid all previously used elements and try to use the suggested new variations.
  * Do NOT use any introductory phrases like "Here's a joke:".
  * Just output the raw joke text itself.`;
        }

        let configBlock = `// JOKE CONFIGURATION //
${povInstructions[pov]}
- **Absurdity Level:** ${absurdityLevel}/10.`;

        // Add existing UI controls to the config block
        const minWords = parseInt(params.minWords || 1);
        const maxWords = parseInt(params.maxWords || 100);
        if (minWords > 0 || maxWords < 100) {
            configBlock += `\n- **Length:** Between ${minWords} and ${maxWords} words.`;
        }
        const complexityLabelsMap = { 1: 'very simple', 2: 'simple', 3: 'basic', 4: 'casual', 5: 'medium', 6: 'standard', 7: 'advanced', 8: 'complex', 9: 'sophisticated', 10: 'highly academic' };
        configBlock += `\n- **Complexity/Vocabulary:** ${complexityLabelsMap[params.complexityLevel] || 'medium'}.`;
        if (params.jokeTone && params.jokeTone !== 'any') configBlock += `\n- **Tone/Mood:** ${params.jokeTone}.`;
        if (params.humorType && params.humorType !== 'any') configBlock += `\n- **Humor Type:** ${params.humorType}.`;
        if (params.targetAudience) configBlock += `\n- **Target Audience:** ${params.targetAudience}.`;
        
        const detailLevelLabels = { 1: 'very brief and concise', 2: 'brief', 3: 'standard', 4: 'detailed', 5: 'highly descriptive and elaborate' };
        configBlock += `\n- **Detail Level:** ${detailLevelLabels[params.detailLevel] || 'standard'}.`;

        if (params.jokeStructure && params.jokeStructure !== 'any') configBlock += `\n- **Joke Structure:** Must be a ${params.jokeStructure} format.`;
        const slangLevelLabelsMap = { 1: 'none', 2: 'light', 3: 'normal', 4: 'heavy', 5: 'maximum' };
        configBlock += `\n- **Slang/Jargon Level:** ${slangLevelLabelsMap[params.slangLevel] || 'normal'}.`;
        if (params.narratorPersona) configBlock += `\n- **Narrator Persona:** The joke should be told from the perspective of: "${params.narratorPersona}". This should influence the tone and word choice.`;

        if (params.guaranteedWords) configBlock += `\n- **Guaranteed Words:** MUST contain: ${params.guaranteedWords}.`;
        if (params.startsWith) configBlock += `\n- **Starts With:** MUST start with: "${params.startsWith}".`;
        if (params.scenario) configBlock += `\n- **Scenario:** Must be set in: "${params.scenario}".`;
        if (params.culturalContext) configBlock += `\n- **Cultural Context:** Must reference: "${params.culturalContext}".`;
        if (params.forbiddenConstraints) configBlock += `\n- **Forbidden Constraints:** MUST NOT mention: ${params.forbiddenConstraints}.`;
        if (params.excludedWords) configBlock += `\n- **Excluded Words:** MUST NOT contain: ${params.excludedWords}.`;
        if (params.excludedTopics) configBlock += `\n- **Excluded Topics:** MUST NOT be about: ${params.excludedTopics}.`;
        if (selectedTopics.length > 0) configBlock += `\n- **General Topics:** Should incorporate: ${selectedTopics.join(', ')}.`;

        // --- Incorporate NEW controls into the prompt ---

        // Generation Tab New Controls
        const pacingVariationLabels = { 1: 'very uniform', 2: 'uniform', 3: 'medium', 4: 'varied', 5: 'highly erratic' };
        if (params.pacingVariation) configBlock += `\n- **Pacing Variation:** ${pacingVariationLabels[params.pacingVariation] || 'medium'}.`;

        const unexpectednessLabels = { 1: 'very predictable', 2: 'somewhat predictable', 3: 'balanced', 4: 'unexpected', 5: 'highly unexpected/surprising' };
        if (params.unexpectedness) configBlock += `\n- **Unexpectedness Level:** ${unexpectednessLabels[params.unexpectedness] || 'balanced'}.`;

        if (params.antiHumorMode) configBlock += `\n- **Anti-Humor Mode:** Enabled. Attempt to be intentionally unfunny or subvert humor.`;

        if (params.jokeSourceAdherence && inspirationalSourceTextarea.value.trim()) { // Only if source exists
            configBlock += `\n- **Joke Source Adherence:** ${params.jokeSourceAdherence}%. Adhere to the style of the provided "Joke Source" text with this level of strictness.`;
        }

        // Topics Tab New Controls
        if (params.topicCombinationLogic) configBlock += `\n- **Topic Combination Logic:** ${params.topicCombinationLogic.replace("_", " ")}.`;

        const topicRelatednessLabels = { 1: 'very loose', 2: 'loose', 3: 'medium', 4: 'high', 5: 'strict lock' };
        if (params.topicRelatedness && (mode === 'story' || mode === 'remix')) { // Only for relevant modes
             configBlock += `\n- **Topic Relatedness to Previous (Chain/Remix):** ${topicRelatednessLabels[params.topicRelatedness] || 'high'}.`;
        }
        if (params.maxNewTopics >= 0) configBlock += `\n- **Max New Topics per Joke:** ${params.maxNewTopics}.`;

        // Content Tab New Controls
        if (params.characterTraitInjection) configBlock += `\n- **Character Trait Injection:** Incorporate traits like: ${params.characterTraitInjection}.`;
        if (params.emotionalToneShift && params.emotionalToneShift !== 'none') configBlock += `\n- **Emotional Tone Shift:** The joke should have an emotional shift: ${params.emotionalToneShift.replace("_", " to ")}.`;
        if (params.sensoryDetailFocus && params.sensoryDetailFocus !== 'any') configBlock += `\n- **Sensory Detail Focus:** Emphasize ${params.sensoryDetailFocus} details.`;

        const abstractLevelLabels = { 1: 'very concrete', 2: 'concrete', 3: 'balanced', 4: 'abstract', 5: 'very abstract' };
        if (params.abstractLevel) configBlock += `\n- **Abstract vs. Concrete Level:** ${abstractLevelLabels[params.abstractLevel] || 'balanced'}.`;

        if (params.popCultureSpecificity && params.popCultureSpecificity !== 'generic') configBlock += `\n- **Pop Culture Reference Specificity:** Use ${params.popCultureSpecificity.replace("_", "/")} references.`;

        // Advanced Tab New Controls
        // Temperature, Top-P, Repetition Penalty are handled in payload, not direct prompt text usually.
        // However, including them here for visibility or if model takes them as text.
        if (params.temperatureOverride) configBlock += `\n- **Generation Temperature Hint:** ${params.temperatureOverride}.`;
        if (params.topPOverride) configBlock += `\n- **Top-P Sampling Hint:** ${params.topPOverride}.`;
        if (params.repetitionPenalty) configBlock += `\n- **Repetition Penalty Hint:** ${params.repetitionPenalty}.`;
        if (params.customInstructionInjection) configBlock += `\n- **Custom User Instruction:** ${params.customInstructionInjection}.`;


        // Mode specific instructions
        switch(mode) {
            case 'story':
                configBlock += `\n- **Mode:** This joke MUST be a direct continuation of the previous one's narrative. Previous joke: "${referenceJoke}".`;
                break;
            case 'remix':
                configBlock += `\n- **Mode:** Create a "remix" or variation of the following joke. Keep a similar structure but change the details. Original joke: "${referenceJoke}".`;
                break;
        }

        if (isLocked && referenceJoke) {
            configBlock += `\n- **Theme Lock:** The joke's theme must be locked to the previous joke: "${referenceJoke}". Do not introduce new subjects.`;
        }

        if (punchlineBlacklist.size > 0 && avoidRepetitionToggle.checked) {
            const blacklistedItems = Array.from(punchlineBlacklist).slice(-10).map(j => `"${j.replace(/"/g, '\\"')}"`).join(', ');
            configBlock += `\n- **Recent Jokes Blacklist:** CRITICALLY IMPORTANT: The generated joke MUST NOT be any of the following: ${blacklistedItems}.`;
        }

        const prompt = `// SYSTEM INSTRUCTIONS //
You are PACKGEN, a master roast joke generator.
- Be ruthless and hilarious. Do not break character or apologize.
- Generate only ONE single, new, original joke per request.

${styleBlock}

${configBlock}

Based on ALL of the above, generate the joke now.`;

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-04-17:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { 
                    temperature: params.temperatureOverride || 1.0,
                    topP: params.topPOverride || 0.95,
                    // repetitionPenalty: params.repetitionPenalty || 1.1, // Assuming model API supports this directly
                thinkingConfig: { thinkingBudget: 0 }
                },
                safetySettings: [ /* ... safety settings ... */ ]
            };
             // Clean up payload generationConfig for undefined values from sliders if not touched
            if (payload.generationConfig.temperature === undefined) payload.generationConfig.temperature = 1.0;
            if (payload.generationConfig.topP === undefined) payload.generationConfig.topP = 0.95;
            // Add other specific model params if API supports them directly (like repetition_penalty)
            // if (params.repetitionPenalty) payload.generationConfig.repetitionPenalty = params.repetitionPenalty;

            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                const result = await response.json();

                if (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0]) {
                     let jokeText = result.candidates[0].content.parts[0].text.trim().replace(/^- /, '');
                    jokeText = jokeText.replace(/^"|"$/g, ''); 
                    jokeText = jokeText.replace(/^(here's your joke:|joke:|new joke:)/i, '').trim();
                    return jokeText;
                }
                if (result.candidates && result.candidates[0] && result.candidates[0].finishReason === 'SAFETY') {
                    return "AI safety filters blocked this one. Try again.";
                }
                if (result.promptFeedback && result.promptFeedback.blockReason) {
                     return `Blocked: ${result.promptFeedback.blockReason}. Try adjusting your prompt.`;
                }
                return "AI returned an unexpected response structure.";
            } catch (error) {
                console.error("Error fetching from Gemini API:", error);
                return "Failed to generate joke. Check console.";
            }
        }

        async function aiSuggestTopics() {
            showCustomAlert("AI is suggesting topics...", true); 
            const prompt = `You are a creative AI. Based on general knowledge and common humor topics, suggest 5-8 distinct, single-word or very short phrase topics suitable for surreal roast humor. Ensure they are diverse and potentially unusual. Do not include numbers or bullet points, just a comma-separated list of topics. Example: "Animals, Tech, History, Space, Sports, Music, Movies".

Suggested Topics:`;
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.8, 
                }
            };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                const result = await response.json();

                if (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0]) {
                    const suggestedText = result.candidates[0].content.parts[0].text.trim();
                    const newTopics = suggestedText.split(',').map(t => t.trim()).filter(t => t);
                    
                    newTopics.forEach(newTopicRaw => {
                        const newTopic = newTopicRaw.charAt(0).toUpperCase() + newTopicRaw.slice(1).toLowerCase();
                        if (!availableTopics.find(t => t.toLowerCase() === newTopic.toLowerCase())) {
                            availableTopics.push(newTopic);
                        }
                    });
                    renderTopics();
                    saveUIState();
                    hideCustomModal(document.querySelector('.modal.visible')); 
                    showCustomAlert("New topics suggested and added!");
                } else {
                    hideCustomModal(document.querySelector('.modal.visible'));
                    showCustomAlert("Failed to suggest topics. Unexpected AI response.");
                }
            }
            catch (error) {
                console.error("Error fetching AI topic suggestions:", error);
                hideCustomModal(document.querySelector('.modal.visible'));
                showCustomAlert("Failed to suggest topics. Please try again.");
            }
        }
        
        // --- UI ANIMATION FUNCTIONS ---
        function clearJokeArea() {
            jokeDisplayArea.innerHTML = '';
            const p = document.createElement('p');
            p.id = 'joke-display-text';
            jokeDisplayArea.appendChild(p);
            return p;
        }
        function renderTopics() {
            topicGrid.innerHTML = '';
            availableTopics.forEach(topic => {
                const topicBtn = document.createElement('button');
                topicBtn.className = 'topic-tag';
                topicBtn.textContent = topic;
                topicBtn.dataset.topic = topic;
                if (selectedTopics.includes(topic)) {
                    topicBtn.classList.add('active');
                }
                topicGrid.appendChild(topicBtn);
            });
        }

        function scrambleText(element, onComplete) {
            clearInterval(scrambleInterval);
            const chars = '!<>-_\\/[]{}=+*^?#_';
            const text = 'GENERATING...';
            let i = 0;
            scrambleInterval = setInterval(() => {
                element.textContent = text.split('').map((c, index) => (index < i ? c : chars[Math.floor(Math.random() * chars.length)])).join('');
                if (i >= text.length) {
                    clearInterval(scrambleInterval);
                    element.textContent = text;
                    if(onComplete) onComplete();
                }
                i++;
            }, 20); 
        }

        function deRezz(element, onComplete) {
            clearInterval(typewriterInterval); 
            clearInterval(scrambleInterval); 
            if (element) element.classList.remove('typewriter-text');
            const chars = 'â–ˆâ–“â–’â–‘';
            let text = element.textContent;
            if (text.length === 0) {
                if (onComplete) onComplete();
                return;
            }
            let i = text.length - 1;
            scrambleInterval = setInterval(() => {
                if (i >= 0) {
                    text = text.substring(0, i) + chars[Math.floor(Math.random() * chars.length)];
                    element.textContent = text;
                    i--;
                } else {
                    clearInterval(scrambleInterval);
                    element.textContent = '';
                    if(onComplete) onComplete();
                }
            }, 10); 
        }

        function typewriter(element, text, onComplete) {
            clearInterval(typewriterInterval);
            clearInterval(scrambleInterval); 
            if (!element) return;
            element.textContent = '';
            let i = 0;
            typewriterInterval = setInterval(() => {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                } else {
                    clearInterval(typewriterInterval);
                    element.classList.add('typewriter-text');
                    if(onComplete) onComplete();
                }
            }, 15); 
        }

        function updateModeControls() {
            const hasJoke = !!lastGeneratedJoke;
            modeSelector.querySelectorAll('[data-mode="story"], [data-mode="remix"]').forEach(btn => {
                btn.disabled = !hasJoke;
                btn.title = hasJoke ? '' : 'Generate a joke first to enable this mode';
            });
            themeLockToggle.disabled = !hasJoke;
            if (!hasJoke) {
                themeLockToggle.checked = false;
                isThemeLocked = false;
            }
        }

        // --- TEMPLATE MANAGEMENT ---
        function saveTemplate() {
            const category = templateCategorySelect.value;
            const name = templateNameInput.value.trim();
            if (!name) {
                showCustomAlert("Please enter a template name.");
                return;
            }

            const template = {
                guaranteedWords: guaranteedWordsInput.value,
                startsWith: startsWithTextarea.value,
                scenarioList: scenarioListTextarea.value,
                currentScenario: currentScenarioInput.value,
                culturalContext: culturalContextTextarea.value,
                inspirationalSource: inspirationalSourceTextarea.value, 
                forbiddenConstraints: forbiddenConstraintsTextarea.value,
                excludedWords: excludedWordsTextarea.value,
                minWords: minWordsInput.value,
                maxWords: maxWordsInput.value,
                complexityLevel: complexityLevelSlider.value,
                jokeTone: jokeToneSelect.value,
                humorType: humorTypeSelect.value,
                targetAudience: targetAudienceInput.value,
                detailLevel: detailLevelSlider.value,
                creativityLevel: creativityLevelSlider.value,
                avoidRepetition: avoidRepetitionToggle.checked,
                topicInfluence: topicInfluenceSlider.value,
                excludeTopics: excludeTopicsTextarea.value
            };

            if (!savedTemplates[category]) {
                savedTemplates[category] = {};
            }
            savedTemplates[category][name] = template;
            localStorage.setItem('packgenTemplates', JSON.stringify(savedTemplates));
            showCustomAlert(`Template "${name}" saved to category "${category}".`);
        }

        function loadTemplate() {
            const category = templateCategorySelect.value;
            showCustomPrompt(`Enter the name of the template to load from "${category}":`, (name) => {
                if (!name) return;

                if (savedTemplates[category] && savedTemplates[category][name]) {
                    const template = savedTemplates[category][name];
                    guaranteedWordsInput.value = template.guaranteedWords || '';
                    startsWithTextarea.value = template.startsWith || '';
                    scenarioListTextarea.value = template.scenarioList || '';
                    currentScenarioInput.value = template.currentScenario || '';
                    culturalContextTextarea.value = template.culturalContext || '';
                    inspirationalSourceTextarea.value = template.inspirationalSource || ''; 
                    forbiddenConstraintsTextarea.value = template.forbiddenConstraints || '';
                    excludedWordsTextarea.value = template.excludedWords || '';
                    minWordsInput.value = template.minWords || 5;
                    maxWordsInput.value = template.maxWords || 20;
                    complexityLevelSlider.value = template.complexityLevel || 5;
                    jokeToneSelect.value = template.jokeTone || 'any';
                    humorTypeSelect.value = template.humorType || 'any';
                    targetAudienceInput.value = template.targetAudience || '';
                    
                    detailLevelSlider.value = template.detailLevel || 3;
                    creativityLevelSlider.value = template.creativityLevel || 3;
                    avoidRepetitionToggle.checked = template.avoidRepetition || false;
                    topicInfluenceSlider.value = template.topicInfluence || 3;
                    excludeTopicsTextarea.value = template.excludeTopics || '';

                    updateComplexityValueDisplay(); 
                    updateDetailLevelDisplay();
                    updateCreativityLevelDisplay();
                    updateTopicInfluenceDisplay();

                    saveUIState(); 
                    showCustomAlert(`Template "${name}" loaded from category "${category}".`);
                } else {
                    showCustomAlert(`Template "${name}" not found in category "${category}".`);
                }
            });
        }

        // --- Custom Alert/Prompt System ---
        function createCustomModal(type) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            const closeBtn = document.createElement('span');
            closeBtn.className = 'modal-close';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => hideCustomModal(modal);
            modalContent.appendChild(closeBtn);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            return { modal, modalContent };
        }

        function showCustomAlert(message, isLoading = false) {
            const { modal, modalContent } = createCustomModal('alert');
            const p = document.createElement('p');
            p.textContent = message;
            p.className = 'text-center text-lg';
            modalContent.appendChild(p);

            if (!isLoading) {
                const okBtn = document.createElement('button');
                okBtn.textContent = 'OK';
                okBtn.className = 'btn-gradient mt-6 px-8 py-2 rounded-full';
                okBtn.onclick = () => hideCustomModal(modal);
                modalContent.appendChild(okBtn);
            } else {
                const spinnerDiv = document.createElement('div');
                spinnerDiv.className = 'spinner mt-4 mx-auto';
                modalContent.appendChild(spinnerDiv);
            }

            modal.classList.add('visible');
        }

        function showCustomPrompt(message, callback) {
            const { modal, modalContent } = createCustomModal('prompt');
            const p = document.createElement('p');
            p.textContent = message;
            p.className = 'text-center text-lg mb-4';
            modalContent.appendChild(p);

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'bg-slate-800 border border-slate-600 rounded p-2 w-full text-sm focus:ring-cyan-500 focus:border-cyan-500';
            modalContent.appendChild(input);

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex justify-center gap-4 mt-6';

            const okBtn = document.createElement('button');
            okBtn.textContent = 'OK';
            okBtn.className = 'btn-gradient px-8 py-2 rounded-full';
            okBtn.onclick = () => {
                callback(input.value);
                hideCustomModal(modal);
            };
            buttonContainer.appendChild(okBtn);

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'toggle-btn px-8 py-2 rounded-full';
            cancelBtn.onclick = () => hideCustomModal(modal);
            buttonContainer.appendChild(cancelBtn);

            modalContent.appendChild(buttonContainer);
            modal.classList.add('visible');
            input.focus();
        }

        function hideCustomModal(modalElement) {
            modalElement.classList.remove('visible');
            modalElement.classList.add('hidden');
            modalElement.addEventListener('transitionend', () => {
                if (modalElement.parentNode) {
                    modalElement.parentNode.removeChild(modalElement);
                }
            }, { once: true });
        }


        // --- KNOWLEDGE BASE MANAGEMENT (PLACEHOLDER) ---
        function manageKnowledgeBases() {
            document.getElementById('knowledgeBaseModal').classList.remove('hidden');
            document.getElementById('knowledgeBaseModal').classList.add('visible');
        }

        // --- REFERENCE LIBRARY (PLACEHOLDER) ---
        function openReferenceLibrary() {
            document.getElementById('referenceLibraryModal').classList.remove('hidden');
            document.getElementById('referenceLibraryModal').classList.add('visible');
        }

        // --- TOPIC CLUSTERS (PLACEHOLDER) ---
        function manageTopicClusters() {
            document.getElementById('topicClustersModal').classList.remove('hidden');
            document.getElementById('topicClustersModal').classList.add('visible');
        }

        createClusterBtn.addEventListener('click', () => {
            showCustomAlert("Placeholder: Create Topic Cluster functionality.");
        });
        // --- API REFERENCE SEARCH (PLACEHOLDER) ---
        async function searchApiForReferences() {
            const query = referenceApiQueryInput.value.trim();
            if (!query) return;
            const placeholderResults = [
                { title: "Reference 1", content: "Placeholder content 1" },
                { title: "Reference 2", content: "Placeholder content 2" },
            ];
            displayReferenceResults(placeholderResults);
        }

        function displayReferenceResults(results) {
            const resultsDiv = document.getElementById('reference-results');
            resultsDiv.innerHTML = '';
            if (results && results.length > 0) {
                results.forEach(ref => {
                    const refDiv = document.createElement('div');
                    refDiv.innerHTML = `<strong>${ref.title}</strong>: ${ref.content.substring(0, 100)}...`; 
                    resultsDiv.appendChild(refDiv); 
                });
            } else {
                resultsDiv.textContent = "No references found.";
            }
        }

        // --- UI STATE PERSISTENCE ---
        const persistentInputs = [
            { element: absurditySlider, type: 'value' },
            { element: themeLockToggle, type: 'checked' },
            { element: batchToggle, type: 'checked' },
            { element: batchSteps, type: 'value' },
            { element: guaranteedWordsInput, type: 'value' },
            { element: startsWithTextarea, type: 'value' },
            { element: scenarioListTextarea, type: 'value' },
            { element: currentScenarioInput, type: 'value' },
            { element: culturalContextTextarea, type: 'value' },
            { element: inspirationalSourceTextarea, type: 'value' }, 
            { element: forbiddenConstraintsTextarea, type: 'value' },
            { element: excludedWordsTextarea, type: 'value' },
            { element: themeColorPicker, type: 'value' },
            { element: minWordsInput, type: 'value' },
            { element: maxWordsInput, type: 'value' },
            { element: complexityLevelSlider, type: 'value' },
            { element: jokeToneSelect, type: 'value' },
            { element: humorTypeSelect, type: 'value' },
            { element: targetAudienceInput, type: 'value' },
            { element: jokeStructureSelect, type: 'value' },
            { element: slangLevelSlider, type: 'value' },
            { element: narratorPersonaInput, type: 'value' },
            { element: detailLevelSlider, type: 'value' },
            { element: creativityLevelSlider, type: 'value' },
            { element: avoidRepetitionToggle, type: 'checked' },
            { element: topicInfluenceSlider, type: 'value' },
            { element: excludeTopicsTextarea, type: 'value' },
            // New persistent inputs
            { element: pacingVariationSlider, type: 'value' },
            { element: unexpectednessSlider, type: 'value' },
            { element: antiHumorToggle, type: 'checked' },
            { element: jokeSourceAdherenceSlider, type: 'value' },
            { element: topicCombinationLogicSelect, type: 'value' },
            { element: topicRelatednessSlider, type: 'value' },
            { element: maxNewTopicsInput, type: 'value' },
            { element: characterTraitInjectionTextarea, type: 'value' },
            { element: emotionalToneShiftSelect, type: 'value' },
            { element: sensoryDetailFocusSelect, type: 'value' },
            { element: abstractLevelSlider, type: 'value' },
            { element: popCultureSpecificitySelect, type: 'value' },
            { element: temperatureOverrideSlider, type: 'value' },
            { element: topPOverrideSlider, type: 'value' },
            { element: repetitionPenaltySlider, type: 'value' },
            { element: customInstructionInjectionTextarea, type: 'value' }
        ];

        function saveUIState() {
            const state = {};
            persistentInputs.forEach(item => {
                if (item.element) { // Ensure element exists
                    state[item.element.id] = item.element[item.type];
                }
            });
            state.selectedPov = povSelector.querySelector('.toggle-btn.active').dataset.pov;
            state.currentMode = currentMode;
            state.selectedTopics = selectedTopics;
            state.activeTab = tabsNav.querySelector('.tab-btn.active').dataset.tab; 
            localStorage.setItem('packgenUIState', JSON.stringify(state));
        }

        function loadUIState() {
            const savedState = localStorage.getItem('packgenUIState');
            if (savedState) {
                const state = JSON.parse(savedState);
                
                persistentInputs.forEach(item => {
                    if (item.element && state[item.element.id] !== undefined) {
                        item.element[item.type] = state[item.element.id];
                        // Update display for sliders that had specific update logic
                        if (item.element.id === 'absurdity-slider') {
                            absurdityValue.textContent = state[item.element.id];
                            absurdity = state[item.element.id];
                        }
                        // Add similar updates for new sliders if they have display spans
                        if (item.element.id === 'pacing-variation-slider') pacingVariationValue.textContent = getPacingVariationLabel(state[item.element.id]);
                        if (item.element.id === 'unexpectedness-slider') unexpectednessValue.textContent = getUnexpectednessLabel(state[item.element.id]);
                        if (item.element.id === 'joke-source-adherence-slider') jokeSourceAdherenceValue.textContent = `${state[item.element.id]}%`;
                        if (item.element.id === 'topic-relatedness-slider') topicRelatednessValue.textContent = getTopicRelatednessLabel(state[item.element.id]);
                        if (item.element.id === 'abstract-level-slider') abstractLevelValue.textContent = getAbstractLevelLabel(state[item.element.id]);
                        if (item.element.id === 'temperature-override-slider') temperatureOverrideValue.textContent = parseFloat(state[item.element.id]).toFixed(1);
                        if (item.element.id === 'top-p-override-slider') topPOverrideValue.textContent = parseFloat(state[item.element.id]).toFixed(2);
                        if (item.element.id === 'repetition-penalty-slider') repetitionPenaltyValue.textContent = parseFloat(state[item.element.id]).toFixed(1);
                    }
                });

                if (state.selectedPov) {
                    povSelector.querySelectorAll('.toggle-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.pov === state.selectedPov) btn.classList.add('active');
                    });
                }

                if (state.currentMode) {
                    modeSelector.querySelectorAll('.toggle-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.mode === state.currentMode) {
                            btn.classList.add('active');
                            currentMode = state.currentMode;
                        }
                    });
                }
                
                if (state.selectedTopics) selectedTopics = state.selectedTopics;
                renderTopics(); 
                updateModeControls(); 
                batchControls.classList.toggle('hidden', !isBatchMode); 
                updateThemeColor(themeColorPicker.value); 

                // Call all display update functions
                updateComplexityValueDisplay(); 
                updateDetailLevelDisplay(); 
                updateSlangLevelDisplay();
                updateCreativityLevelDisplay(); 
                updateTopicInfluenceDisplay(); 
                // New display updates
                updatePacingVariationDisplay();
                updateUnexpectednessDisplay();
                updateJokeSourceAdherenceDisplay();
                updateTopicRelatednessDisplay();
                updateAbstractLevelDisplay();
                updateTemperatureOverrideDisplay();
                updateTopPOverrideDisplay();
                updateRepetitionPenaltyDisplay();


                if (state.activeTab) {
                    tabsNav.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    tabsContent.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                    const targetBtn = tabsNav.querySelector(`[data-tab="${state.activeTab}"]`);
                    if (targetBtn) {
                        targetBtn.classList.add('active');
                        document.getElementById(state.activeTab).classList.add('active');
                    }
                }
            }
        }

        // --- Helper functions for slider labels ---
        function getPacingVariationLabel(value) {
            const labels = { 1: 'Very Uniform', 2: 'Uniform', 3: 'Medium', 4: 'Varied', 5: 'Highly Erratic' };
            return labels[value] || 'Medium';
        }
        function getUnexpectednessLabel(value) {
            const labels = { 1: 'Very Predictable', 2: 'Predictable', 3: 'Balanced', 4: 'Unexpected', 5: 'Highly Unexpected' };
            return labels[value] || 'Balanced';
        }
        function getTopicRelatednessLabel(value) {
            const labels = { 1: 'Very Loose', 2: 'Loose', 3: 'Medium', 4: 'High', 5: 'Strict Lock' };
            return labels[value] || 'High';
        }
        function getAbstractLevelLabel(value) {
            const labels = { 1: 'Very Concrete', 2: 'Concrete', 3: 'Balanced', 4: 'Abstract', 5: 'Very Abstract' };
            return labels[value] || 'Balanced';
        }

        // --- Update display functions for new sliders ---
        function updatePacingVariationDisplay() { if(pacingVariationValue) pacingVariationValue.textContent = getPacingVariationLabel(pacingVariationSlider.value); }
        function updateUnexpectednessDisplay() { if(unexpectednessValue) unexpectednessValue.textContent = getUnexpectednessLabel(unexpectednessSlider.value); }
        function updateJokeSourceAdherenceDisplay() { if(jokeSourceAdherenceValue) jokeSourceAdherenceValue.textContent = `${jokeSourceAdherenceSlider.value}%`; }
        function updateTopicRelatednessDisplay() { if(topicRelatednessValue) topicRelatednessValue.textContent = getTopicRelatednessLabel(topicRelatednessSlider.value); }
        function updateAbstractLevelDisplay() { if(abstractLevelValue) abstractLevelValue.textContent = getAbstractLevelLabel(abstractLevelSlider.value); }
        function updateTemperatureOverrideDisplay() { if(temperatureOverrideValue) temperatureOverrideValue.textContent = parseFloat(temperatureOverrideSlider.value).toFixed(1); }
        function updateTopPOverrideDisplay() { if(topPOverrideValue) topPOverrideValue.textContent = parseFloat(topPOverrideSlider.value).toFixed(2); }
        function updateRepetitionPenaltyDisplay() { if(repetitionPenaltyValue) repetitionPenaltyValue.textContent = parseFloat(repetitionPenaltySlider.value).toFixed(1); }


        // --- Existing Clear All Content Inputs Functionality ---
        clearContentInputsBtn.addEventListener('click', () => {
            showCustomPrompt("Are you sure you want to clear all content-related input fields? This action cannot be undone.", (confirm) => {
                if (confirm) {
                    guaranteedWordsInput.value = '';
                    startsWithTextarea.value = '';
                    scenarioListTextarea.value = '';
                    currentScenarioInput.value = '';
                    culturalContextTextarea.value = '';
                    inspirationalSourceTextarea.value = ''; 
                    forbiddenConstraintsTextarea.value = '';
                    excludedWordsTextarea.value = '';
                    minWordsInput.value = 5; 
                    maxWordsInput.value = 20; 
                    complexityLevelSlider.value = 5; 
                    jokeToneSelect.value = 'any'; 
                    humorTypeSelect.value = 'any'; 
                    targetAudienceInput.value = ''; 
                    updateComplexityValueDisplay(); 
                    saveUIState(); 
                    showCustomAlert("Content inputs cleared.");
                }
            });
        });

        // --- Complexity Value Display Update ---
        const complexityLabels = {
            1: 'Very Simple', 2: 'Simple', 3: 'Basic', 4: 'Casual', 5: 'Medium',
            6: 'Standard', 7: 'Advanced', 8: 'Complex', 9: 'Sophisticated', 10: 'Highly Academic'
        };
        function updateComplexityValueDisplay() {
            complexityValueSpan.textContent = complexityLabels[complexityLevelSlider.value];
        }
        complexityLevelSlider.addEventListener('input', () => { updateComplexityValueDisplay(); saveUIState(); });


        // --- Slang Level Display Update ---
        const slangLevelLabels = {
            1: 'None', 2: 'Light', 3: 'Normal', 4: 'Heavy', 5: 'Maximum'
        };
        function updateSlangLevelDisplay() {
            slangLevelValueSpan.textContent = slangLevelLabels[slangLevelSlider.value];
        }
        slangLevelSlider.addEventListener('input', updateSlangLevelDisplay);

        // --- Detail Level Display Update ---
        const detailLevelLabels = {
            1: 'Very Brief', 2: 'Brief', 3: 'Standard', 4: 'Detailed', 5: 'Highly Descriptive'
        };
        function updateDetailLevelDisplay() {
            detailLevelValueSpan.textContent = detailLevelLabels[detailLevelSlider.value];
        }
        slangLevelSlider.addEventListener('input', () => { updateSlangLevelDisplay(); saveUIState(); });
        detailLevelSlider.addEventListener('input', () => { updateDetailLevelDisplay(); saveUIState(); });

        // --- Creativity Level Display Update ---
        const creativityLevelLabels = {
            1: 'Strict', 2: 'Balanced', 3: 'Creative', 4: 'Innovative', 5: 'Radical'
        };
        function updateCreativityLevelDisplay() {
            creativityLevelValueSpan.textContent = creativityLevelLabels[creativityLevelSlider.value];
        }
        creativityLevelSlider.addEventListener('input', () => { updateCreativityLevelDisplay(); saveUIState(); });

        // --- Topic Influence Display Update ---
        const topicInfluenceLabels = {
            1: 'Low', 2: 'Moderate', 3: 'Balanced', 4: 'High', 5: 'Absolute'
        };
        function updateTopicInfluenceDisplay() {
            topicInfluenceValueSpan.textContent = topicInfluenceLabels[topicInfluenceSlider.value];
        }
        topicInfluenceSlider.addEventListener('input', () => { updateTopicInfluenceDisplay(); saveUIState(); });


        // --- EVENT LISTENERS (Existing and New) ---
        themeColorPicker.addEventListener('input', (e) => { updateThemeColor(e.target.value); saveUIState(); });
        tabsNav.addEventListener('click', (e) => {
            const targetBtn = e.target.closest('.tab-btn');
            if (!targetBtn || targetBtn.classList.contains('active')) return;
            tabsNav.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            tabsContent.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            targetBtn.classList.add('active');
            const targetPanelId = targetBtn.dataset.tab;
            document.getElementById(targetPanelId).classList.add('active');
            if (synth) synth.triggerAttackRelease("F5", "16n", Tone.now());
            saveUIState(); 
        });

        document.querySelectorAll('.modal-close').forEach(el => {
            el.addEventListener('click', () => {
                const modal = el.closest('.modal');
                modal.classList.remove('visible');
                modal.classList.add('hidden');
            });
        });
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('visible');
                    modal.classList.add('hidden');
                }
            });
        });

        povSelector.addEventListener('click', (e) => {
            const targetBtn = e.target.closest('.toggle-btn');
            if (!targetBtn || targetBtn.classList.contains('active')) return;
            if (synth) synth.triggerAttackRelease("C5", "16n", Tone.now());
            povSelector.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            targetBtn.classList.add('active');
            saveUIState(); 
        });
        modeSelector.addEventListener('click', (e) => {
            const targetBtn = e.target.closest('.toggle-btn');
            if (!targetBtn || targetBtn.classList.contains('active') || targetBtn.disabled) return;
            if (synth) synth.triggerAttackRelease("C5", "16n", Tone.now());
            modeSelector.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            targetBtn.classList.add('active');
            currentMode = targetBtn.dataset.mode;
            saveUIState(); 
        });
        absurditySlider.addEventListener('input', (e) => {
            absurdity = e.target.value;
            absurdityValue.textContent = absurdity;
            saveUIState(); 
        });
        themeLockToggle.addEventListener('change', (e) => { isThemeLocked = e.target.checked; if (synth) synth.triggerAttackRelease(isThemeLocked ? "E5" : "C5", "16n", Tone.now()); saveUIState(); });
        batchToggle.addEventListener('change', (e) => { isBatchMode = e.target.checked; batchControls.classList.toggle('hidden', !isBatchMode); if (synth) synth.triggerAttackRelease(isBatchMode ? "E5" : "C5", "16n", Tone.now()); saveUIState(); });
        batchSteps.addEventListener('input', saveUIState); 
        avoidRepetitionToggle.addEventListener('change', saveUIState);
        aiTopicSuggestionBtn.addEventListener('click', aiSuggestTopics);

        topicGrid.addEventListener('click', (e) => {
            if (!e.target.classList.contains('topic-tag')) return;
            if (synth) synth.triggerAttackRelease("C6", "32n", Tone.now());
            const topic = e.target.dataset.topic;
            e.target.classList.toggle('active');
            if (selectedTopics.includes(topic)) {
                selectedTopics = selectedTopics.filter(t => t !== topic);
            } else {
                selectedTopics.push(topic);
            }
            saveUIState(); 
        });
        function addCustomTopic() {
            const newTopicRaw = customTopicInput.value.trim();
            if (newTopicRaw) {
                const newTopic = newTopicRaw.charAt(0).toUpperCase() + newTopicRaw.slice(1).toLowerCase();
                if (!availableTopics.find(t => t.toLowerCase() === newTopic.toLowerCase())) {
                    if (synth) synth.triggerAttackRelease("A5", "16n", Tone.now());
                    availableTopics.push(newTopic);
                    renderTopics();
                    customTopicInput.value = '';
                    saveUIState(); 
                } else { customTopicInput.value = ''; }
            }
        }
        addTopicBtn.addEventListener('click', addCustomTopic);
        customTopicInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); addCustomTopic(); } });
        selectAllTopicsBtn.addEventListener('click', () => { if (synth) synth.triggerAttackRelease("G4", "16n", Tone.now()); selectedTopics = [...availableTopics]; renderTopics(); saveUIState(); });
        deselectAllTopicsBtn.addEventListener('click', () => { if (synth) synth.triggerAttackRelease("E4", "16n", Tone.now()); selectedTopics = []; renderTopics(); saveUIState(); });
        randomizeTopicsBtn.addEventListener('click', () => { if (synth) synth.triggerAttackRelease("B4", "16n", Tone.now()); const shuffled = [...availableTopics].sort(() => 0.5 - Math.random()); selectedTopics = shuffled.slice(0, Math.min(3, availableTopics.length)); renderTopics(); saveUIState(); });
        randomScenarioBtn.addEventListener('click', () => { const scenarios = scenarioListTextarea.value.split('\n').map(s => s.trim()).filter(s => s); if (scenarios.length > 0) { currentScenarioInput.value = scenarios[Math.floor(Math.random() * scenarios.length)]; saveUIState(); } });
        clearScenarioBtn.addEventListener('click', () => { currentScenarioInput.value = ''; saveUIState(); });
        
        // Event listeners for existing text/select inputs to save state
        [guaranteedWordsInput, startsWithTextarea, scenarioListTextarea, currentScenarioInput, culturalContextTextarea, inspirationalSourceTextarea, forbiddenConstraintsTextarea, excludedWordsTextarea, minWordsInput, maxWordsInput, targetAudienceInput, narratorPersonaInput, excludeTopicsTextarea].forEach(el => el.addEventListener('input', saveUIState));
        [jokeToneSelect, humorTypeSelect, jokeStructureSelect].forEach(el => el.addEventListener('change', saveUIState));

        // Event listeners for NEW controls
        pacingVariationSlider.addEventListener('input', () => { updatePacingVariationDisplay(); saveUIState(); });
        unexpectednessSlider.addEventListener('input', () => { updateUnexpectednessDisplay(); saveUIState(); });
        antiHumorToggle.addEventListener('change', saveUIState);
        jokeSourceAdherenceSlider.addEventListener('input', () => { updateJokeSourceAdherenceDisplay(); saveUIState(); });
        topicCombinationLogicSelect.addEventListener('change', saveUIState);
        topicRelatednessSlider.addEventListener('input', () => { updateTopicRelatednessDisplay(); saveUIState(); });
        maxNewTopicsInput.addEventListener('input', saveUIState);
        characterTraitInjectionTextarea.addEventListener('input', saveUIState);
        emotionalToneShiftSelect.addEventListener('change', saveUIState);
        sensoryDetailFocusSelect.addEventListener('change', saveUIState);
        abstractLevelSlider.addEventListener('input', () => { updateAbstractLevelDisplay(); saveUIState(); });
        popCultureSpecificitySelect.addEventListener('change', saveUIState);
        temperatureOverrideSlider.addEventListener('input', () => { updateTemperatureOverrideDisplay(); saveUIState(); });
        topPOverrideSlider.addEventListener('input', () => { updateTopPOverrideDisplay(); saveUIState(); });
        repetitionPenaltySlider.addEventListener('input', () => { updateRepetitionPenaltyDisplay(); saveUIState(); });
        customInstructionInjectionTextarea.addEventListener('input', saveUIState);

        saveTemplateBtn.addEventListener('click', saveTemplate);
        loadTemplateBtn.addEventListener('click', loadTemplate);
        manageClustersBtn.addEventListener('click', manageTopicClusters);
        referenceLibraryBtn.addEventListener('click', openReferenceLibrary);
        searchReferencesBtn.addEventListener('click', () => { showCustomAlert("Local Reference Search (functionality not yet implemented)"); });
        searchApiBtn.addEventListener('click', searchApiForReferences);
        knowledgeBaseBtn.addEventListener('click', manageKnowledgeBases);
        hotkeysBtn.addEventListener('click', () => { hotkeysModal.classList.remove('hidden'); hotkeysModal.classList.add('visible'); });
        faqBtn.addEventListener('click', () => { faqModal.classList.remove('hidden'); faqModal.classList.add('visible'); });

        // --- INITIALIZE UI ---
        function initializeUI() {
            renderTopics();
            const storedTemplates = localStorage.getItem('packgenTemplates');
            if (storedTemplates) savedTemplates = JSON.parse(storedTemplates);

            loadUIState(); // This will call all necessary updateXYZDisplay functions internally
            updateModeControls();
        }

        async function handleGenerate() {
            if (generateBtn.disabled) return;
            if (membraneSynth) membraneSynth.triggerAttackRelease("A0", "8n", Tone.now());
            
            generateBtn.disabled = true; 
            spinner.style.display = 'inline-block'; 
            const allControls = document.querySelectorAll('#pov-selector button, .advanced-controls-panel button, .advanced-controls-panel input, .advanced-controls-panel select, .advanced-controls-panel textarea, .switch input');
            allControls.forEach(c => { if(c.id !== 'generate-btn') c.disabled = true; });

            // Get ALL config parameters, including new ones
            const generationParams = getGenerationConfig();
            // The 'contentParams' variable was a subset; now 'generationParams' holds everything.
            // We pass 'generationParams' directly to generateAIPack.

            canCopy = false;
            copyBtn.style.opacity = '0';

            if (currentMode === 'escalation' && !isBatchMode) {
                absurdity = Math.min(10, parseInt(absurdity) + 1);
                absurditySlider.value = absurdity;
                absurdityValue.textContent = absurdity;
            }

            if (isBatchMode) {
                const steps = parseInt(batchSteps.value);
                const jokeList = [];
                jokeDisplayArea.innerHTML = '<ul></ul><p id="batch-status" class="text-xs mt-2 text-slate-400"></p>';
                const ul = jokeDisplayArea.querySelector('ul');
                const statusP = document.getElementById('batch-status');

                for (let i = 0; i < steps; i++) {
                    statusP.textContent = `Generating pack ${i + 1} of ${steps}...`;
                    let currentAbsurdity = absurdity;
                    if (currentMode === 'escalation') {
                        currentAbsurdity = Math.round(1 + (9 / (steps - 1 || 1)) * i);
                    }
                    try {
                        const newJoke = await generateAIPack({
                            mode: currentMode,
                            referenceJoke: lastGeneratedJoke,
                            absurdityLevel: currentAbsurdity, // This specific absurdity is for batch escalation
                            isLocked: isThemeLocked,
                            ...generationParams, // Pass the comprehensive set of params
                        });
                        
                        if (newJoke && !newJoke.startsWith("AI safety filters") && !newJoke.startsWith("Failed to generate") && !newJoke.startsWith("Blocked:")) {
                            const li = document.createElement('li');
                            li.textContent = newJoke;
                            ul.appendChild(li);
                            jokeList.push(newJoke);
                            lastGeneratedJoke = newJoke; 
                            punchlineBlacklist.add(newJoke); 
                            trackUsedContent(newJoke);
                        } else {
                            const li = document.createElement('li');
                            li.textContent = newJoke || `Error on joke ${i+1}.`; 
                            ul.appendChild(li);
                        }

                    } catch (e) {
                        const li = document.createElement('li');
                        li.textContent = `Error on joke ${i+1}.`;
                        ul.appendChild(li);
                    }
                }
                statusP.textContent = `Batch generation complete.`;
                lastGeneratedJoke = jokeList[jokeList.length - 1] || lastGeneratedJoke;
                canCopy = true;
                copyBtn.style.opacity = '1';

            } else {
                const currentJokeDisplayElement = clearJokeArea();
                deRezz(currentJokeDisplayElement, () => {
                    scrambleText(currentJokeDisplayElement, async () => {
                        try {
                            const newJoke = await generateAIPack({
                                mode: currentMode,
                                referenceJoke: lastGeneratedJoke,
                                absurdityLevel: absurdity, // Use the main absurdity slider for single generations
                                isLocked: isThemeLocked,
                                ...generationParams, // Pass the comprehensive set of params
                            });
                            clearInterval(scrambleInterval);
                            
                            if (newJoke && !newJoke.startsWith("AI safety filters") && !newJoke.startsWith("Failed to generate") && !newJoke.startsWith("Blocked:")) {
                                if (synth) synth.triggerAttackRelease(["C3", "G3"], "8n", Tone.now());
                                typewriter(currentJokeDisplayElement, newJoke, () => {
                                   lastGeneratedJoke = newJoke;
                                   punchlineBlacklist.add(newJoke); 
                                    trackUsedContent(newJoke);
                                   canCopy = true;
                                   copyBtn.style.opacity = '1';
                                });
                            } else {
                                currentJokeDisplayElement.textContent = newJoke || 'An error occurred. Try again.';
                                canCopy = false; 
                                copyBtn.style.opacity = '0';
                            }
                        } catch (error) {
                            clearInterval(scrambleInterval);
                            currentJokeDisplayElement.textContent = 'An error occurred. Try again.';
                            console.error(error);
                        }
                    });
                });
            }
            
            generateBtn.disabled = false;
            spinner.style.display = 'none'; 
            allControls.forEach(c => { if(c.id !== 'generate-btn') c.disabled = false; });
            updateModeControls();
            saveUIState(); 
        }

        generateBtn.addEventListener('click', handleGenerate);

        // --- Hotkeys ---
        document.addEventListener('keydown', (event) => {
            // General generate hotkey (Ctrl/Cmd + Enter)
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                if (document.activeElement && (document.activeElement.tagName === 'TEXTAREA' || (document.activeElement.tagName === 'INPUT' && document.activeElement.type === 'text'))) {
                    return; 
                }
                event.preventDefault(); 
                if (!generateBtn.disabled) {
                    handleGenerate();
                }
            }

            // Global 'G' for Generate
            if (event.key.toLowerCase() === 'g' && !generateBtn.disabled && !event.ctrlKey && !event.metaKey && !event.altKey) {
                 if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'SELECT')) {
                    return; 
                }
                event.preventDefault();
                handleGenerate();
            }

            // Copy hotkey
            if (event.key === 'c' && canCopy && !event.altKey && !event.ctrlKey && !event.metaKey) {
                event.preventDefault();
                copyBtn.click();
            }

            // Tab navigation hotkeys (1, 2, 3, 4)
            if (['1', '2', '3', '4'].includes(event.key)) {
                event.preventDefault();
                const tabIndex = parseInt(event.key) - 1;
                const tabButtons = tabsNav.querySelectorAll('.tab-btn');
                if (tabButtons[tabIndex]) {
                    tabButtons[tabIndex].click();
                }
            }

            // Toggle Theme Lock (T)
            if (event.key.toLowerCase() === 't' && !themeLockToggle.disabled) {
                if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return; 
                event.preventDefault();
                themeLockToggle.checked = !themeLockToggle.checked;
                themeLockToggle.dispatchEvent(new Event('change')); 
            }

            // Toggle Batch Mode (B)
            if (event.key.toLowerCase() === 'b' && !batchToggle.disabled) {
                if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
                event.preventDefault();
                batchToggle.checked = !batchToggle.checked;
                batchToggle.dispatchEvent(new Event('change'));
            }

            // Toggle Avoid Repetition (L)
            if (event.key.toLowerCase() === 'l' && !avoidRepetitionToggle.disabled) {
                if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
                event.preventDefault();
                avoidRepetitionToggle.checked = !avoidRepetitionToggle.checked;
                avoidRepetitionToggle.dispatchEvent(new Event('change'));
            }

            // Increase Detail Level (I) - only works if not focused on input
            if (event.key.toLowerCase() === 'i' && !detailLevelSlider.disabled) {
                if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
                event.preventDefault();
                detailLevelSlider.value = Math.min(parseInt(detailLevelSlider.value) + 1, detailLevelSlider.max);
                detailLevelSlider.dispatchEvent(new Event('input')); 
            }

            // Increase Creativity Level (O) - only works if not focused on input
            if (event.key.toLowerCase() === 'o' && !creativityLevelSlider.disabled) {
                if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
                event.preventDefault();
                creativityLevelSlider.value = Math.min(parseInt(creativityLevelSlider.value) + 1, creativityLevelSlider.max);
                creativityLevelSlider.dispatchEvent(new Event('input'));
            }

            // Randomize Topics (R)
            if (event.key.toLowerCase() === 'r' && !randomizeTopicsBtn.disabled) {
                if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
                event.preventDefault();
                randomizeTopicsBtn.click();
            }

            // Select All Topics (A)
            if (event.key.toLowerCase() === 'a' && !selectAllTopicsBtn.disabled) {
                 if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
                event.preventDefault();
                selectAllTopicsBtn.click();
            }

            // Deselect All Topics (D)
            if (event.key.toLowerCase() === 'd' && !deselectAllTopicsBtn.disabled) {
                 if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
                event.preventDefault();
                deselectAllTopicsBtn.click();
            }

            // Focus Exclude Topics textarea (U)
            if (event.key.toLowerCase() === 'u' && !excludeTopicsTextarea.disabled) {
                event.preventDefault();
                excludeTopicsTextarea.focus();
            }

            // AI Suggest Topics (J)
            if (event.key.toLowerCase() === 'j' && !aiTopicSuggestionBtn.disabled) {
                event.preventDefault();
                aiTopicSuggestionBtn.click();
            }

            // Random Scenario (S)
            if (event.key.toLowerCase() === 's' && !randomScenarioBtn.disabled) {
                 if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
                event.preventDefault();
                randomScenarioBtn.click();
            }

            // Clear Current Scenario (E)
            if (event.key.toLowerCase() === 'e' && !clearScenarioBtn.disabled) {
                 if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
                event.preventDefault();
                clearScenarioBtn.click();
            }

            // Clear All Content Inputs (Alt + C)
            if (event.altKey && event.key.toLowerCase() === 'c' && !clearContentInputsBtn.disabled) {
                event.preventDefault();
                clearContentInputsBtn.click();
            }

            // Show Hotkeys (H)
            if (event.key.toLowerCase() === 'h' && !hotkeysBtn.disabled) {
                if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
                event.preventDefault();
                hotkeysBtn.click();
            }

            // Show FAQ (F)
            if (event.key.toLowerCase() === 'f' && !faqBtn.disabled) {
                if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
                event.preventDefault();
                faqBtn.click();
            }
        });


        copyBtn.addEventListener('click', () => {
            if (!canCopy) return;
            if (membraneSynth) membraneSynth.triggerAttackRelease("C2", "8n", Tone.now());
            
            let textToCopy = '';
            if (isBatchMode) {
                const jokes = Array.from(jokeDisplayArea.querySelectorAll('li'))
                                  .map(li => li.textContent)
                                  .filter(text => !text.startsWith("AI safety filters") && !text.startsWith("Failed to generate") && !text.startsWith("Blocked:") && !text.startsWith("Error on joke"));
                textToCopy = jokes.join('\n');
            } else {
                 const jokeP = jokeDisplayArea.querySelector('p');
                if (jokeP) {
                    const jokeText = jokeP.textContent || '';
                     if (!jokeText.startsWith("AI safety filters") && !jokeText.startsWith("Failed to generate") && !jokeText.startsWith("Blocked:") && !jokeText.startsWith("An error occurred")) {
                        textToCopy = jokeText;
                    }
                }
            }

            if (!textToCopy) return; 

            navigator.clipboard.writeText(textToCopy).then(() => {
                copyIcon.style.opacity = '0';
                copyFeedback.style.opacity = '1';
                setTimeout(() => {
                    copyIcon.style.opacity = '1';
                    copyFeedback.style.opacity = '0';
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = textToCopy;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                     copyIcon.style.opacity = '0';
                    copyFeedback.style.opacity = '1';
                    setTimeout(() => {
                        copyIcon.style.opacity = '1';
                        copyFeedback.style.opacity = '0';
                    }, 1500);
                } catch (err) {
                    console.error('Fallback: Could not copy text using execCommand: ', err);
                }
                document.body.removeChild(tempTextArea);
            });
        });
        
        // --- 3D BACKGROUND LOGIC ---
        let scene, camera, renderer, particles, particleSpeeds;
        const mouse = new THREE.Vector2();

        function init3D() {
            const canvas = document.getElementById('bg-canvas');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 50;

            renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            const particleCount = 8000; 
            const positions = new Float32Array(particleCount * 3);
            particleSpeeds = new Float32Array(particleCount);

            for (let i = 0; i < particleCount; i++) {
                positions[i * 3]     = (Math.random() - 0.5) * 200; 
                positions[i * 3 + 1] = (Math.random() - 0.5) * 200; 
                positions[i * 3 + 2] = (Math.random() - 0.5) * 200; 
                
                particleSpeeds[i] = Math.random() * 0.15 + 0.05; 
            }
            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const material = new THREE.PointsMaterial({
                color: 0x22d3ee, 
                size: 0.25,      
                sizeAttenuation: true, 
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            window.addEventListener('resize', onWindowResize, false);
            document.addEventListener('mousemove', onMouseMove, false);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            const time = Date.now() * 0.00005; 
            
            const positionsAttribute = particles.geometry.attributes.position;
            const pArray = positionsAttribute.array;

            for (let i = 0; i < particleSpeeds.length; i++) {
                pArray[i * 3 + 1] -= particleSpeeds[i];

                if (pArray[i * 3 + 1] < -100) { 
                    pArray[i * 3 + 1] = 100;    
                    pArray[i * 3]     = (Math.random() - 0.5) * 200; 
                    pArray[i * 3 + 2] = (Math.random() - 0.5) * 200; 
                }
            }
            positionsAttribute.needsUpdate = true; 

            particles.rotation.x = time * 0.2; 
            particles.rotation.y = time * 0.4;

            camera.position.x += (mouse.x * 5 - camera.position.x) * 0.05;
            camera.position.y += (mouse.y * 5 - camera.position.y) * 0.05;
            camera.lookAt(scene.position);

            renderer.render(scene, camera);
        }
        
        // --- BOOT UP ANIMATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const title = document.getElementById('title');
            const text = "OBLITERATE PACKGEN PRO";
            title.innerHTML = text.split('').map((char, i) => `<span class="cyber-flicker" style="animation-delay:${i * 50}ms">${char === ' ' ? '&nbsp;' : char}</span>`).join('');
            
            initializeUI();
            init3D();
            animate3D();
        });
    

// Extend generation logic to include new controls
function getGenerationConfig() {
    const timingSlider = document.getElementById('timing-slider');
    const verbosityStyle = document.getElementById('verbosity-style');
    const sarcasmLevelSlider = document.getElementById('sarcasm-level-slider');
    const visualImagerySlider = document.getElementById('visual-imagery-slider');
    // This function will be expanded in the next step to include all new controls
    return {
        // Existing controls
        pov: povSelector.querySelector('.toggle-btn.active')?.dataset?.pov || 'second',
        mode: modeSelector.querySelector('.toggle-btn.active')?.dataset?.mode || 'single',
        absurdity: +absurditySlider.value,
        detailLevel: +detailLevelSlider.value,
        creativityLevel: +creativityLevelSlider.value,
        avoidRepetition: avoidRepetitionToggle.checked,
        jokeLength: +jokeLengthSlider.value, // This influences min/max words
        timing: timingSlider ? +timingSlider.value : 3, // Default to 3 if not found
        verbosityStyle: verbosityStyle ? verbosityStyle.value : 'concise', // Default if not found
        sarcasmLevel: sarcasmLevelSlider ? +sarcasmLevelSlider.value : 3, // Default if not found
        realismSurrealism: document.getElementById('realism-vs-surrealism') ? document.getElementById('realism-vs-surrealism').value : 'balanced',
        visualImagery: +visualImagerySlider.value,
        logicalCoherence: document.getElementById('logical-coherence-toggle').value,
        exaggerationMode: document.getElementById('exaggeration-mode').value,

        themeRandomizer: document.getElementById('theme-randomizer-toggle').checked,
        preferredNounCount: parseInt(document.getElementById('noun-count').value),
        verbDensity: parseInt(document.getElementById('verb-density').value),
        sentenceRhythm: document.getElementById('sentence-rhythm').value,
        backstory: document.getElementById('backstory-injection').value.trim(),
        emotionArc: document.getElementById('emotion-arc').value,
        shockValue: parseInt(document.getElementById('shock-value').value),
        callbackCount: parseInt(document.getElementById('callback-count').value),
        conflictType: document.getElementById('conflict-type').value,
        generationSeed: document.getElementById('generation-seed').value.trim(),

        // Topics Tab
        topicPriorityMode: document.getElementById('topic-priority-mode').value,
        topicInfluence: +topicInfluenceSlider.value,
        excludeTopics: excludeTopicsTextarea.value.trim(),

        // Content Tab
        punchlineStyle: document.getElementById('punchline-style').value,
        sentenceStructure: document.getElementById('sentence-structure').value,
        guaranteedWords: guaranteedWordsInput.value.trim(),
        startsWith: startsWithTextarea.value.split('\n').map(p => p.trim()).filter(p => p).sort(() => 0.5 - Math.random())[0],
        scenario: currentScenarioInput.value.trim(),
        culturalContext: culturalContextTextarea.value.split('\n').map(c => c.trim()).filter(c => c).sort(() => 0.5 - Math.random())[0],
        minWords: minWordsInput.value.trim(),
        maxWords: maxWordsInput.value.trim(),
        complexityLevel: complexityLevelSlider.value,
        jokeTone: jokeToneSelect.value,
        humorType: humorTypeSelect.value,
        jokeStructure: jokeStructureSelect.value,
        slangLevel: slangLevelSlider.value,
        narratorPersona: narratorPersonaInput.value.trim(),
        targetAudience: targetAudienceInput.value.trim(),
        forbiddenConstraints: forbiddenConstraintsTextarea.value.trim(),
        excludedWords: excludedWordsTextarea.value.trim(),

        // Advanced Tab
        humorAlgorithmMode: document.getElementById('humor-algorithm-mode').value,
        entropyBias: +document.getElementById('entropy-bias').value, // Assuming entropyBias is defined
        inspirationalSource: inspirationalSourceTextarea.value.trim(),


        // Newly Added Controls
        pacingVariation: +pacingVariationSlider.value,
        unexpectedness: +unexpectednessSlider.value,
        antiHumorMode: antiHumorToggle.checked,
        jokeSourceAdherence: +jokeSourceAdherenceSlider.value,

        topicCombinationLogic: topicCombinationLogicSelect.value,
        topicRelatedness: +topicRelatednessSlider.value,
        maxNewTopics: +maxNewTopicsInput.value,

        characterTraitInjection: characterTraitInjectionTextarea.value.trim(),
        emotionalToneShift: emotionalToneShiftSelect.value,
        sensoryDetailFocus: sensoryDetailFocusSelect.value,
        abstractLevel: +abstractLevelSlider.value,
        popCultureSpecificity: popCultureSpecificitySelect.value,

        temperatureOverride: +temperatureOverrideSlider.value,
        topPOverride: +topPOverrideSlider.value,
        repetitionPenalty: +repetitionPenaltySlider.value,
        customInstructionInjection: customInstructionInjectionTextarea.value.trim(),
    };
}

// The debug generateBtn listener can be removed or kept for testing.
// It's not strictly part of the feature request but useful for development.

// The collectNewGenerationSettings function and its hook into generateBtn
// seem to be from a previous/parallel feature integration.
// For this task, we are focusing on integrating the new tab controls
// into the main `getGenerationConfig` and `generateAIPack` flow.
// I will leave them as they are, assuming they serve a purpose for other functionality.

// --- Bindings for shockValueSlider (already existed) ---
const shockValueSlider = document.getElementById('shock-value');
const shockValueLabel = document.getElementById('shock-value-label');
shockValueSlider.addEventListener('input', () => {
    shockValueLabel.textContent = shockValueSlider.value;
});

// Example integration object builder (can be sent to server)
function collectNewGenerationSettings() {
    return {
        themeRandomizer: document.getElementById('theme-randomizer-toggle').checked,
        preferredNounCount: parseInt(document.getElementById('noun-count').value),
        verbDensity: parseInt(document.getElementById('verb-density').value),
        sentenceRhythm: document.getElementById('sentence-rhythm').value,
        backstory: document.getElementById('backstory-injection').value.trim(),
        emotionArc: document.getElementById('emotion-arc').value,
        shockValue: parseInt(document.getElementById('shock-value').value),
        callbackCount: parseInt(document.getElementById('callback-count').value),
        conflictType: document.getElementById('conflict-type').value,
        generationSeed: document.getElementById('generation-seed').value.trim()
    };
}

// Hook into main generation button (can be sent to server or model)
generateBtn.addEventListener('click', () => {
    const extraSettings = collectNewGenerationSettings();
    console.log("Sending all settings to server:", extraSettings);
    // Optionally merge with other config and POST to server
    // fetch('/api/generate', { method: 'POST', body: JSON.stringify({ ...otherSettings, ...extraSettings }) })
});

</script>
</body>
</html>
