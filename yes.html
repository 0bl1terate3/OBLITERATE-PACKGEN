<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBLITERATE PACKGEN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-grad-1: #0a0a0a;
            --bg-grad-2: #1a1a1a;
            --bg-grad-3: #2a2a2a;
            --primary-color: #3b82f6;
            --text-color: #e5e7eb;
            --text-white: #ffffff;
            --panel-bg: rgba(26, 26, 26, 0.9);
            --panel-border: #374151;
            --joke-container-bg: rgba(31, 41, 55, 0.9);
            --input-bg: rgba(17, 24, 39, 0.9);
            --glitch-1: transparent;
            --glitch-2: transparent;
        }
        body.theme-minimalistic {
            --bg-grad-1: #0a0a0a;
            --bg-grad-2: #1a1a1a;
            --bg-grad-3: #2a2a2a;
            --primary-color: #3b82f6;
            --text-color: #e5e7eb;
            --text-white: #ffffff;
            --panel-bg: rgba(26, 26, 26, 0.9);
            --panel-border: #374151;
            --joke-container-bg: rgba(31, 41, 55, 0.9);
            --input-bg: rgba(17, 24, 39, 0.9);
            --glitch-1: transparent;
            --glitch-2: transparent;
        }
        body.theme-synthwave {
            --bg-grad-1: #1a0a2e;
            --bg-grad-2: #2A0C4E;
            --bg-grad-3: #4C0070;
            --primary-color: #00f7ff;
            --text-color: #ff00c1;
            --panel-bg: rgba(76, 0, 112, 0.5);
            --panel-border: #00f7ff;
            --joke-container-bg: rgba(42, 12, 78, 0.7);
            --glitch-1: #00f7ff;
            --glitch-2: #ff00c1;
        }
        body.theme-fallout {
            --bg-grad-1: #1a2e1a;
            --bg-grad-2: #163e16;
            --bg-grad-3: #0f600f;
            --primary-color: #27e945;
            --text-color: #27e945;
            --text-white: #27e945;
            --panel-bg: rgba(15, 96, 15, 0.5);
            --panel-border: #27e945;
            --joke-container-bg: rgba(22, 62, 22, 0.7);
            --input-bg: rgba(15, 62, 15, 0.7);
            --glitch-1: transparent;
            --glitch-2: transparent;
        }

        body.theme-cyberpunk {
            --bg-grad-1: #0a0a1a;
            --bg-grad-2: #1a1a2e;
            --bg-grad-3: #2a2a4a;
            --primary-color: #ff00ff;
            --text-color: #00ffff;
            --text-white: #ffffff;
            --panel-bg: rgba(26, 26, 46, 0.5);
            --panel-border: #ff00ff;
            --joke-container-bg: rgba(42, 42, 74, 0.7);
            --input-bg: rgba(26, 26, 46, 0.7);
            --glitch-1: #ff00ff;
            --glitch-2: #00ffff;
        }

        body.theme-matrix {
            --bg-grad-1: #000000;
            --bg-grad-2: #0a0a0a;
            --bg-grad-3: #141414;
            --primary-color: #00ff00;
            --text-color: #00ff00;
            --text-white: #00ff00;
            --panel-bg: rgba(10, 10, 10, 0.5);
            --panel-border: #00ff00;
            --joke-container-bg: rgba(20, 20, 20, 0.7);
            --input-bg: rgba(10, 10, 10, 0.7);
            --glitch-1: #00ff00;
            --glitch-2: #00ff00;
        }

        body.theme-sunset {
            --bg-grad-1: #2c1810;
            --bg-grad-2: #4a2c1a;
            --bg-grad-3: #6a3c2a;
            --primary-color: #ff6b35;
            --text-color: #ffd700;
            --text-white: #ffffff;
            --panel-bg: rgba(74, 44, 26, 0.5);
            --panel-border: #ff6b35;
            --joke-container-bg: rgba(106, 60, 42, 0.7);
            --input-bg: rgba(74, 44, 26, 0.7);
            --glitch-1: #ff6b35;
            --glitch-2: #ffd700;
        }

        body.theme-ocean {
            --bg-grad-1: #001f3f;
            --bg-grad-2: #003366;
            --bg-grad-3: #004080;
            --primary-color: #00bfff;
            --text-color: #7fffd4;
            --text-white: #ffffff;
            --panel-bg: rgba(0, 51, 102, 0.5);
            --panel-border: #00bfff;
            --joke-container-bg: rgba(0, 64, 128, 0.7);
            --input-bg: rgba(0, 51, 102, 0.7);
            --glitch-1: #00bfff;
            --glitch-2: #7fffd4;
        }

        body.theme-neon {
            --bg-grad-1: #1a0033;
            --bg-grad-2: #330066;
            --bg-grad-3: #4d0099;
            --primary-color: #ff00ff;
            --text-color: #00ffff;
            --text-white: #ffffff;
            --panel-bg: rgba(51, 0, 102, 0.5);
            --panel-border: #ff00ff;
            --joke-container-bg: rgba(77, 0, 153, 0.7);
            --input-bg: rgba(51, 0, 102, 0.7);
            --glitch-1: #ff00ff;
            --glitch-2: #00ffff;
        }

        body.theme-forest {
            --bg-grad-1: #1a2e1a;
            --bg-grad-2: #2a4a2a;
            --bg-grad-3: #3a6a3a;
            --primary-color: #90ee90;
            --text-color: #98fb98;
            --text-white: #ffffff;
            --panel-bg: rgba(42, 74, 42, 0.5);
            --panel-border: #90ee90;
            --joke-container-bg: rgba(58, 106, 58, 0.7);
            --input-bg: rgba(42, 74, 42, 0.7);
            --glitch-1: #90ee90;
            --glitch-2: #98fb98;
        }

        body.theme-candy {
            --bg-grad-1: #ff69b4;
            --bg-grad-2: #ff1493;
            --bg-grad-3: #c71585;
            --primary-color: #ff69b4;
            --text-color: #ffffff;
            --text-white: #ffffff;
            --panel-bg: rgba(255, 20, 147, 0.5);
            --panel-border: #ff69b4;
            --joke-container-bg: rgba(199, 21, 133, 0.7);
            --input-bg: rgba(255, 20, 147, 0.7);
            --glitch-1: #ff69b4;
            --glitch-2: #ff1493;
        }

        body.theme-golden {
            --bg-grad-1: #2c1810;
            --bg-grad-2: #4a2c1a;
            --bg-grad-3: #6a3c2a;
            --primary-color: #ffd700;
            --text-color: #ffd700;
            --text-white: #ffffff;
            --panel-bg: rgba(74, 44, 26, 0.5);
            --panel-border: #ffd700;
            --joke-container-bg: rgba(106, 60, 42, 0.7);
            --input-bg: rgba(74, 44, 26, 0.7);
            --glitch-1: #ffd700;
            --glitch-2: #ffd700;
        }

        body.theme-arctic {
            --bg-grad-1: #1a1a2e;
            --bg-grad-2: #2a2a4a;
            --bg-grad-3: #3a3a6a;
            --primary-color: #00ffff;
            --text-color: #ffffff;
            --text-white: #ffffff;
            --panel-bg: rgba(42, 42, 74, 0.5);
            --panel-border: #00ffff;
            --joke-container-bg: rgba(58, 58, 106, 0.7);
            --input-bg: rgba(42, 42, 74, 0.7);
            --glitch-1: #00ffff;
            --glitch-2: #ffffff;
        }

        body.theme-vaporwave {
            --bg-grad-1: #ff00ff;
            --bg-grad-2: #00ffff;
            --bg-grad-3: #ff00ff;
            --primary-color: #ffffff;
            --text-color: #ffffff;
            --text-white: #ffffff;
            --panel-bg: rgba(0, 255, 255, 0.5);
            --panel-border: #ffffff;
            --joke-container-bg: rgba(255, 0, 255, 0.7);
            --input-bg: rgba(0, 255, 255, 0.7);
            --glitch-1: #ffffff;
            --glitch-2: #ffffff;
        }

        body.theme-monochrome {
            --bg-grad-1: #000000;
            --bg-grad-2: #1a1a1a;
            --bg-grad-3: #2a2a2a;
            --primary-color: #ffffff;
            --text-color: #ffffff;
            --text-white: #ffffff;
            --panel-bg: rgba(26, 26, 26, 0.5);
            --panel-border: #ffffff;
            --joke-container-bg: rgba(42, 42, 42, 0.7);
            --input-bg: rgba(26, 26, 26, 0.7);
            --glitch-1: #ffffff;
            --glitch-2: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-grad-1);
            color: var(--text-color);
            transition: color 0.2s ease;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }
        .title-glitch {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--primary-color);
            letter-spacing: -0.02em;
            text-shadow: none;
            animation: none;
        }
        .main-button {
            transition: all 0.2s ease;
            background-color: var(--primary-color);
            box-shadow: none;
            color: var(--text-white) !important;
            text-shadow: none;
            border-radius: 6px;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border: none;
        }
        .main-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .main-button:active {
            transform: translateY(0);
        }
        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            backdrop-filter: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        input, select, textarea {
            background: var(--input-bg);
            border: 1px solid var(--panel-border);
            border-radius: 6px;
            color: var(--text-color);
            padding: 0.75rem 1rem;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
        }
        .joke-container {
            background-color: var(--joke-container-bg);
            border: 1px solid var(--panel-border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        .joke-container:hover {
            transform: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .control-panel, .modal-content {
            background-color: var(--panel-bg);
            backdrop-filter: none;
            border: 1px solid var(--panel-border);
            transition: all 0.2s ease;
            transform-origin: center;
        }
        .control-panel:hover, .modal-content:hover {
            transform: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .joke-container {
            background-color: var(--joke-container-bg);
            border: 1px solid var(--panel-border);
            box-shadow: 0 0 20px var(--panel-bg);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        .joke-container:hover {
            transform: translateY(-5px) rotateX(5deg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .topic-btn, .preset-btn, .remix-btn, .header-btn {
            border: 1px solid var(--panel-border);
            color: var(--text-color);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .topic-btn::after, .preset-btn::after, .remix-btn::after, .header-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary-color);
            transform: scaleX(0);
            transform-origin: right;
            transition: transform 0.2s ease;
        }
        .topic-btn:hover::after, .preset-btn:hover::after, .remix-btn:hover::after, .header-btn:hover::after {
            transform: scaleX(1);
            transform-origin: left;
        }
        .topic-btn:hover, .preset-btn:hover, .remix-btn:hover, .header-btn:hover {
            transform: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--panel-bg);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-flip {
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-flip:hover {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            backface-visibility: hidden;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .minimal-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--primary-color);
            padding: 8px 0;
            transition: all 0.3s ease;
            color: var(--text-color);
        }
        .minimal-input:focus {
            outline: none;
            border-bottom-color: var(--text-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .minimal-button {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--text-color);
            padding: 8px 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .minimal-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--primary-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
            z-index: -1;
        }
        .minimal-button:hover::before {
            width: 300%;
            height: 300%;
        }
        .minimal-button:hover {
            color: var(--text-white);
        }
        input, select, textarea {
            background-color: var(--input-bg) !important; border: 2px solid var(--panel-border) !important; color: var(--text-white) !important;
        }
        input:focus, select:focus, textarea:focus { outline: none; box-shadow: 0 0 0 2px var(--primary-color); }
        /* Custom Sliders */
        input[type="range"]::-webkit-slider-runnable-track { background: var(--bg-grad-2); border: 1px solid var(--panel-border); }
        input[type="range"]::-moz-range-track { background: var(--bg-grad-2); border: 1px solid var(--panel-border); }
        input[type="range"]::-webkit-slider-thumb { background: var(--primary-color); box-shadow: 0 0 5px var(--primary-color); -webkit-appearance: none; appearance: none; width: 20px; height: 20px; cursor: pointer; border-radius: 50%; margin-top: -8px; }
        input[type="range"]::-moz-range-thumb { background: var(--primary-color); box-shadow: 0 0 5px var(--primary-color); width: 20px; height: 20px; cursor: pointer; border-radius: 50%; }
        /* Disabled Slider Label */
        .slider-container {
            position: relative;
        }
        .disabled-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            color: #ff0000;
            font-size: 24px;
            font-weight: bold;
            text-transform: uppercase;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        .slider-disabled .disabled-label {
            opacity: 1;
        }
        /* Text color overrides */
        .text-main { color: var(--text-color); }
        .text-output { color: var(--text-white); }
        .main-button-text { color: #fff !important; text-shadow: 0 1px 4px rgba(0,0,0,0.4); }

        /* Improved Layout Styles */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            max-width: 1800px;
            margin: 0 auto;
            padding: 1rem;
            height: calc(100vh - 2rem);
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: 100%;
            overflow: hidden;
        }

        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow: hidden;
        }

        .panel-content {
            overflow-y: auto;
            flex: 1;
            padding-right: 0.5rem;
        }

        .panel-content::-webkit-scrollbar {
            width: 8px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: var(--panel-bg);
            border-radius: 4px;
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: var(--panel-border);
            border-radius: 4px;
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .modal-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 90vh;
            overflow: hidden;
        }

        .modal-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .modal-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .button-group .topic-btn {
            flex: 1;
            min-width: 120px;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .column {
                height: auto;
            }
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid var(--panel-border);
            margin-bottom: 1rem;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 0.5rem 1rem;
            border: 1px solid var(--panel-border);
            border-bottom: none;
            border-radius: 0.5rem 0.5rem 0 0;
            background: var(--panel-bg);
            color: var(--text-white);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .tab:hover {
            background: var(--panel-border);
        }

        .tab.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--bg-grad-3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .sub-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .sub-tabs::-webkit-scrollbar {
            display: none;
        }

        .sub-tab {
            padding: 0.25rem 0.75rem;
            border: 1px solid var(--panel-border);
            border-radius: 0.25rem;
            background: var(--panel-bg);
            color: var(--text-white);
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .sub-tab:hover {
            background: var(--panel-border);
        }

        .sub-tab.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--bg-grad-3);
        }

        /* Main Section Tabs */
        .main-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--panel-border);
            padding-bottom: 0.5rem;
        }

        .main-tab {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--panel-border);
            border-radius: 0.5rem;
            background: var(--panel-bg);
            color: var(--text-white);
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .main-tab:hover {
            background: var(--panel-border);
        }

        .main-tab.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--bg-grad-3);
        }

        .main-tab-content {
            display: none;
        }

        .main-tab-content.active {
            display: block;
        }

        /* AI Theme Maker Styles */
        .ai-theme-maker {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
        }

        .ai-theme-maker input {
            background: var(--input-bg);
            border: 1px solid var(--panel-border);
            color: var(--text-white);
            padding: 0.5rem;
            width: 100%;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
        }

        .ai-theme-maker button {
            background: var(--primary-color);
            color: var(--text-white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .ai-theme-maker button:hover {
            opacity: 0.8;
        }

        .ai-theme-maker button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .theme-preview {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .theme-preview-color {
            width: 2rem;
            height: 2rem;
            border-radius: 0.25rem;
            border: 1px solid var(--panel-border);
        }

        /* Knowledge Base Styles */
        .knowledge-base-item {
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .knowledge-base-item:hover {
            box-shadow: 0 0 10px var(--primary-color);
        }
        .tag {
            background-color: var(--primary-color);
            color: var(--bg-grad-3);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }
        .file-upload-container {
            border: 1px dashed var(--panel-border);
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        .file-upload-container:hover {
            background-color: var(--panel-bg);
        }

        /* Workflow Builder Styles */
        .workflow-node {
            background-color: var(--panel-bg);
            border: 2px solid var(--panel-border);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem;
            min-width: 200px;
            cursor: move;
            position: relative;
        }
        .workflow-node:hover {
            box-shadow: 0 0 10px var(--primary-color);
        }
        .workflow-node.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 15px var(--primary-color);
        }
        .workflow-node .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .workflow-node .node-content {
            margin-top: 0.5rem;
        }
        .workflow-canvas {
            background-color: var(--panel-bg);
            border: 2px dashed var(--panel-border);
            border-radius: 0.5rem;
            min-height: 400px;
            position: relative;
            margin: 1rem 0;
        }
        .workflow-connection {
            position: absolute;
            background-color: var(--primary-color);
            height: 2px;
            transform-origin: left center;
            pointer-events: none;
        }
        .agent-palette {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            padding: 1rem;
            background-color: var(--panel-bg);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .agent-type {
            background-color: var(--input-bg);
            border: 1px solid var(--panel-border);
            border-radius: 0.25rem;
            padding: 0.5rem;
            cursor: grab;
            text-align: center;
        }
        .agent-type:hover {
            background-color: var(--panel-bg);
            border-color: var(--primary-color);
        }
        .workflow-controls {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }
        .node-ports {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 50%;
        }
        .node-input-port {
            left: -5px;
            top: 50%;
        }
        .node-output-port {
            right: -5px;
            top: 50%;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.1.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react/": "https://esm.sh/react@^19.1.0/",
    "uuid": "https://esm.sh/uuid@^11.1.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.515.0",
    "@google/genai": "https://esm.sh/@google/genai@^1.5.1"
  }
}

function generateAIContent(text) {
    // Simulate AI generation
    const familyMap = {
        "family": ["father", "mother", "brother", "sister", "uncle", "aunt", "cousin"]
    };

    if (familyMap[text]) {
        const randomIndex = Math.floor(Math.random() * familyMap[text].length);
        return familyMap[text][randomIndex];
    }
    return `AI generated ${text}`;
}
</script>
</head>
<body class="min-h-screen p-4 sm:p-6 lg:p-8 flex flex-col items-center">

    <!-- Main Header -->
    <header class="w-full max-w-7xl mx-auto text-center mb-6 flex justify-between items-center gap-4">
        <div class="flex gap-2">
            <button id="show-hof-btn" class="header-btn px-3 py-1 rounded-lg text-2xl" title="Hall of Fame">🏆</button>
            <button id="show-history-btn" class="header-btn px-3 py-1 rounded-lg text-2xl" title="Session History">📜</button>
            <button id="show-targets-btn" class="header-btn px-3 py-1 rounded-lg text-2xl" title="Manage Targets">🎯</button>
            <button id="show-pipeline-btn" class="header-btn px-3 py-1 rounded-lg text-2xl" title="Output Pipeline">🛠️</button>
            <button id="show-examples-btn" class="header-btn px-3 py-1 rounded-lg text-2xl" title="Example Library">📚</button>
        </div>
        <h1 class="title-glitch text-4xl md:text-6xl lg:text-7xl tracking-widest flex-grow">OBLITERATE PACKGEN</h1>
        <div class="flex gap-2 items-center">
            <label for="theme-switcher" class="text-lg font-semibold text-main">Theme:</label>
            <select id="theme-switcher" class="rounded-lg px-2 py-1 text-lg">
                <option value="minimalistic" selected>Minimalistic Dark</option>
                <option value="default">Obliterate</option>
                <option value="synthwave">Synthwave</option>
                <option value="fallout">Fallout</option>
                <option value="cyberpunk">Cyberpunk</option>
                <option value="matrix">Matrix</option>
                <option value="sunset">Sunset</option>
                <option value="ocean">Ocean</option>
                <option value="neon">Neon</option>
                <option value="forest">Forest</option>
                <option value="candy">Candy</option>
                <option value="golden">Golden</option>
                <option value="arctic">Arctic</option>
                <option value="vaporwave">Vaporwave</option>
                <option value="monochrome">Monochrome</option>
            </select>
        </div>
    </header>

    <!-- Main Application Wrapper -->
    <main class="w-full max-w-7xl mx-auto flex-grow flex flex-col gap-6">

        <!-- Joke Display Area -->
        <div id="joke-wrapper" class="joke-container rounded-2xl p-6 flex-grow flex flex-col justify-center min-h-[250px] relative">
            <div id="loader" class="absolute inset-0 bg-black/50 backdrop-blur-sm flex-col items-center justify-center rounded-2xl hidden z-10"><div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-primary-color"></div><p class="text-2xl mt-4 tracking-wider text-output">COMPILING INSULT...</p></div>
            <p id="joke-output" class="text-output text-2xl md:text-3xl font-medium leading-tight text-center">Your generated joke will appear here. Press the button to begin...</p>
            <div id="joke-actions" class="absolute top-3 right-3 flex gap-2 hidden">
                <button id="analyze-btn" class="bg-gray-700/80 text-white px-3 py-1 rounded-lg text-lg hover:bg-purple-500" title="Analyze This Joke">🧠</button>
                <button id="share-image-btn" class="bg-gray-700/80 text-white px-3 py-1 rounded-lg text-lg hover:bg-blue-500" title="Share as Image">🖼️</button>
                <button id="favorite-btn" class="bg-gray-700/80 text-white px-3 py-1 rounded-lg text-lg hover:bg-yellow-500" title="Add to Hall of Fame">⭐</button>
                <button id="copy-btn" class="bg-primary-color/80 text-white px-3 py-1 rounded-lg text-sm hover:bg-primary-color">Copy</button>
            </div>
            <div id="copy-feedback" class="absolute bottom-3 right-3 bg-green-500 text-white px-3 py-1 rounded-lg text-sm hidden">Copied!</div>
            <!-- REMIX V2 CONTROLS -->
            <div id="remix-controls" class="w-full mt-4 pt-4 border-t border-panel-border/30 gap-2 hidden">
                <div class="w-full text-center mb-2"><span class="text-output font-semibold mr-2 text-lg">REFINE & REMIX</span></div>
                <div class="w-full flex flex-wrap justify-center items-center gap-2">
                    <button class="remix-btn text-sm rounded-md px-2 py-1" data-remix-type="aggression">More Aggressive</button>
                    <button class="remix-btn text-sm rounded-md px-2 py-1" data-remix-type="absurdity">More Absurd</button>
                    <button class="remix-btn text-sm rounded-md px-2 py-1" data-remix-type="length">Shorter</button>
                    <button class="remix-btn text-sm rounded-md px-2 py-1" data-remix-type="new">New Take</button>
                    <div class="w-full flex gap-2 mt-2">
                        <input type="text" id="refine-input" placeholder="Natural language command (e.g., 'make it a haiku', 'add a pun about cheese')" class="flex-grow rounded-lg px-2 py-1 text-sm">
                        <button id="refine-btn" class="topic-btn rounded-lg px-3 py-1 font-semibold text-sm">Refine</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls Panel -->
        <div class="control-panel rounded-2xl p-6">
            <div class="mb-6 border-b-2 border-panel-border/30 pb-4 flex items-center justify-center gap-4">
                <h3 class="text-xl font-bold text-main">CONFIGURATIONS</h3>
                <div class="flex-grow">
                    <select id="config-loader-select" class="rounded-lg px-2 py-1 text-lg w-full">
                        <option value="">-- Load a Config --</option>
                    </select>
                    <p class="text-sm text-main/70 mt-1">First time? Set up your settings and click "Save Current" below</p>
                </div>
                <div class="flex gap-2">
                    <button id="save-config-btn" class="topic-btn rounded-lg p-2 font-semibold" title="Save your current settings as a new configuration">Save Current</button>
                    <button id="delete-config-btn" class="topic-btn rounded-lg p-2 font-semibold" title="Delete the selected configuration">Delete Selected</button>
                    <button id="export-config-btn" class="topic-btn rounded-lg p-2 font-semibold" title="Export the selected configuration to share with others">Export Config</button>
                    <button id="import-config-btn" class="topic-btn rounded-lg p-2 font-semibold" title="Import a configuration from someone else">Import Config</button>
                </div>
            </div>
            
            <!-- Main Tabs -->
            <div class="main-tabs">
                <button class="main-tab active" data-tab="generation-core">GENERATION CORE</button>
                <button class="main-tab" data-tab="content-context">CONTENT & CONTEXT</button>
                <button class="main-tab active" data-tab="fine-tuning">FINE TUNING</button>
                <button class="main-tab" data-tab="history-analytics">HISTORY & ANALYTICS</button>
            </div>

            <!-- Generation Core Tab -->
            <div id="generation-core" class="main-tab-content active">
                <div class="flex flex-col gap-4">
                    <div>
                        <label for="target-profile-select" class="block text-xl font-bold mb-2 text-main">TARGET PROFILE</label>
                        <select id="target-profile-select" class="w-full rounded-lg px-4 py-2 text-lg"></select>
                    </div>
                    <div>
                        <label for="generator-persona-select" class="block text-xl font-bold mb-2 text-main">GENERATOR PERSONA</label>
                        <select id="generator-persona-select" class="w-full rounded-lg px-4 py-2 text-lg">
                            <option value="default">Default (Obliterator)</option>
                            <option value="shakespeare">Shakespearean Insulter</option>
                            <option value="drill_sergeant">Drill Sergeant</option>
                            <option value="snarky_ai">Snarky, Passive-Aggressive AI</option>
                            <option value="drunk_uncle">Confused Drunk Uncle</option>
                        </select>
                    </div>
                    <div>
                        <label for="pov-selector" class="block text-xl font-bold mb-2 text-main">POINT OF VIEW</label>
                        <select id="pov-selector" class="w-full rounded-lg px-4 py-2 text-lg">
                            <option value="second-person">Second-Person (Direct Address)</option>
                            <option value="third-person">Third-Person (Observational)</option>
                            <option value="first-person">First-Person (Anecdotal)</option>
                        </select>
                    </div>
                    <!-- Main Buttons Container -->
                    <div class="mt-auto flex flex-col gap-4 pt-4 border-t-2 border-panel-border/30">
                        <!-- Generation Mode Controls -->
                        <div class="flex items-center justify-between">
                            <label for="batch-mode-toggle" class="text-xl font-bold text-main">Batch Mode</label>
                            <input type="checkbox" id="batch-mode-toggle" class="w-6 h-6">
                           </div>
                           <!-- NEW MODES -->
                           <div class="flex flex-col gap-2 mt-4">
                             <label class="flex items-center gap-2">
                               <input type="checkbox" id="story-chain-mode-toggle" class="w-5 h-5">
                               <span class="text-main font-bold">Story Chain Mode</span>
                             </label>
                             <label class="flex items-center gap-2">
                               <input type="checkbox" id="theme-lock-mode-toggle" class="w-5 h-5">
                               <span class="text-main font-bold">Theme Lock Mode</span>
                             </label>
                             <label class="flex items-center gap-2">
                               <input type="checkbox" id="remix-mode-toggle" class="w-5 h-5">
                               <span class="text-main font-bold">Remix Mode</span>
                             </label>
                             <label class="flex items-center gap-2">
                               <input type="checkbox" id="escalation-mode-toggle" class="w-5 h-5">
                               <span class="text-main font-bold">Escalation Mode</span>
                             </label>
                           </div>
                       </div>
                       <div id="single-joke-controls">
                           <label for="num-jokes-input" class="block text-lg font-semibold mb-1 text-main">Number of Jokes</label>
                            <input type="number" id="num-jokes-input" value="1" min="1" max="10" class="w-full rounded-lg px-4 py-2 text-lg">
                        </div>
                        <div id="batch-joke-controls" class="hidden space-y-2">
                            <div>
                                <label for="batch-slider-select" class="block text-lg font-semibold mb-1 text-main">Vary This Slider:</label>
                                <select id="batch-slider-select" class="w-full rounded-lg px-4 py-2 text-lg"></select>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <input type="number" id="batch-start-value" placeholder="Start" value="0" class="w-full rounded-lg px-4 py-2 text-lg">
                                <input type="number" id="batch-end-value" placeholder="End" value="100" class="w-full rounded-lg px-4 py-2 text-lg">
                                <input type="number" id="batch-steps-value" placeholder="Steps" value="5" min="2" max="10" class="w-full rounded-lg px-4 py-2 text-lg">
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="generate-btn" class="main-button flex-grow text-4xl font-bold py-4 rounded-xl"><span class="main-button-text">OBLITERATE</span></button>
                            <button id="chain-generate-btn" title="Execute 2-Step Chain" class="main-button w-20 text-4xl font-bold py-4 rounded-xl"><span class="main-button-text">⛓️</span></button>
                        </div>
                    </div>
                    <!-- Auto-validation & Retries -->
                    <div class="pt-4 border-t-2 border-panel-border/30 space-y-4">
                        <h3 class="text-2xl font-bold text-center mb-2 text-main">AUTO-VALIDATION & RETRIES</h3>
                        <div>
                            <label for="validation-rules-input" class="block text-xl font-bold mb-2 text-main">VALIDATION RULES</label>
                            <textarea id="validation-rules-input" placeholder="e.g., 'must contain \"banana\", must not contain \"politics\", must be >= 50 words' (one rule per line)" rows="3" class="w-full rounded-lg px-4 py-2 text-lg"></textarea>
                        </div>
                        <div>
                            <label for="max-retries-input" class="block text-xl font-bold mb-2 text-main">MAX RETRIES</label>
                            <input type="number" id="max-retries-input" value="3" min="0" max="10" class="w-full rounded-lg px-4 py-2 text-lg">
                        </div>
                    </div>
                    <!-- Few-shot Examples -->
                    <div class="pt-4 border-t-2 border-panel-border/30 space-y-4">
                        <h3 class="text-2xl font-bold text-center mb-2 text-main">FEW-SHOT EXAMPLES</h3>
                        <div>
                            <label for="example-select" class="block text-xl font-bold mb-2 text-main">SELECT EXAMPLES</label>
                            <select id="example-select" multiple class="w-full rounded-lg px-4 py-2 text-lg" size="3">
                                <option value="">-- No examples selected --</option>
                            </select>
                            <p class="text-sm text-output/70 mt-1">Select up to 3 examples to guide the generation. Examples will be used to teach the AI your preferred style.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content & Context Tab -->
            <div id="content-context" class="main-tab-content">
                <div class="flex flex-col gap-4">
                    <div>
                        <label class="block text-xl font-bold mb-2 text-main">TOPIC MATRIX</label>
                        <div id="topic-matrix" class="grid grid-cols-3 gap-2 mb-2"></div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button id="select-all-topics" class="topic-btn rounded-lg p-2 font-semibold">Select All</button>
                            <button id="deselect-all-topics" class="topic-btn rounded-lg p-2 font-semibold">Deselect All</button>
                        </div>
                        <button id="randomize-topics" class="w-full topic-btn rounded-lg p-2 font-semibold mb-2">Randomize Topics</button>
                        <div class="flex gap-2">
                            <input type="text" id="new-topic-input" placeholder="New Topic" class="rounded-lg px-2 py-1 text-lg w-full"/>
                            <button id="add-topic-btn" class="topic-btn rounded-lg p-2 font-semibold w-full">Add Topic</button>
                        </div>
                    </div>
                    <div>
                        <label for="guaranteed-words-input" class="block text-xl font-bold mb-2 text-main">GUARANTEED WORDS</label>
                        <input type="text" id="guaranteed-words-input" placeholder="e.g., 'banana', 'existential', 'dance'" class="w-full rounded-lg px-4 py-2 text-lg">
                    </div>
                    <div>
                        <label for="starts-with-input" class="block text-xl font-bold mb-2 text-main">STARTS WITH</label>
                        <textarea id="starts-with-input" placeholder="Enter multiple contexts per line, one will be randomly selected each time&#10;e.g.,&#10;yo uncle&#10;nigga you&#10;you the type" class="w-full rounded-lg px-4 py-2 text-lg" rows="3"></textarea>
                    </div>
                    <div>
                        <label for="scenario-list-input" class="block text-xl font-bold mb-2 text-main">SCENARIO LIST</label>
                        <textarea id="scenario-list-input" placeholder="Enter multiple scenarios per line, one will be randomly selected each time\ne.g.,\nduring a job interview\nat a funeral\nwhile trying to defuse a bomb" class="w-full rounded-lg px-4 py-2 text-lg" rows="3"></textarea>
                    </div>
                    <div>
                        <label for="scenario-input" class="block text-xl font-bold mb-2 text-main">SCENARIO</label>
                        <div class="flex gap-2">
                            <input type="text" id="scenario-input" placeholder="No scenario set..." class="w-full rounded-lg px-4 py-2 text-lg">
                            <button id="random-scenario-btn" title="Random Scenario" class="topic-btn rounded-lg p-2 font-semibold">🎲</button>
                            <button id="clear-scenario-btn" title="Clear Scenario" class="topic-btn rounded-lg p-2 font-semibold">❌</button>
                        </div>
                    </div>
                    <div>
                        <label for="cultural-context-input" class="block text-xl font-bold mb-2 text-main">CULTURAL CONTEXT</label>
                        <textarea id="cultural-context-input" placeholder="Enter multiple contexts per line, one will be randomly selected each time&#10;e.g.,&#10;90s skateboarding, Warhammer 40k lore&#10;anime, k-pop&#10;classic rock, 80s movies" class="w-full rounded-lg px-4 py-2 text-lg" rows="3"></textarea>
                    </div>
                    <div>
                        <label for="inspirational-source-input" class="block text-xl font-bold mb-2 text-main">INSPIRATIONAL SOURCE</label>
                        <textarea id="inspirational-source-input" placeholder="Paste text here to match its style..." rows="4" class="w-full rounded-lg px-4 py-2 text-lg"></textarea>
                    </div>
                    <div>
                        <label for="negative-prompt-input" class="block text-xl font-bold mb-2 text-main">FORBIDDEN CONSTRAINTS</label>
                        <textarea id="negative-prompt-input" placeholder="e.g., politics, puns, the word 'moist'..." rows="3" class="w-full rounded-lg px-4 py-2 text-lg"></textarea>
                    </div>
                    <div>
                        <label for="excluded-words-input" class="block text-xl font-bold mb-2 text-main">EXCLUDED WORDS</label>
                        <textarea id="excluded-words-input" placeholder="e.g., politics, puns, the word 'moist'..." rows="3" class="w-full rounded-lg px-4 py-2 text-lg"></textarea>
                    </div>

                    <!-- Topic Clustering Section -->
                    <div class="pt-4 border-t-2 border-panel-border/30 space-y-4">
                        <h3 class="text-2xl font-bold text-center mb-2 text-main">TOPIC CLUSTERING</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="cluster-name" class="block text-lg font-semibold mb-1 text-main">Cluster Name</label>
                                <input type="text" id="cluster-name" class="w-full rounded-lg px-4 py-2 text-lg" placeholder="e.g., Tech Topics">
                            </div>
                            <div>
                                <label for="cluster-color" class="block text-lg font-semibold mb-1 text-main">Cluster Color</label>
                                <input type="color" id="cluster-color" class="w-full h-10 rounded-lg cursor-pointer">
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="create-cluster-btn" class="topic-btn rounded-lg p-2 font-semibold flex-1">Create Cluster</button>
                            <button id="manage-clusters-btn" class="topic-btn rounded-lg p-2 font-semibold flex-1">Manage Clusters</button>
                        </div>
                        <div id="active-clusters" class="flex flex-wrap gap-2 mt-2"></div>
                    </div>

                    <!-- Context Templates Section -->
                    <div class="pt-4 border-t-2 border-panel-border/30 space-y-4">
                        <h3 class="text-2xl font-bold text-center mb-2 text-main">CONTEXT TEMPLATES</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="template-category" class="block text-lg font-semibold mb-1 text-main">Category</label>
                                <select id="template-category" class="w-full rounded-lg px-4 py-2 text-lg">
                                    <option value="professional">Professional</option>
                                    <option value="social">Social</option>
                                    <option value="gaming">Gaming</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div>
                                <label for="template-name" class="block text-lg font-semibold mb-1 text-main">Template Name</label>
                                <input type="text" id="template-name" class="w-full rounded-lg px-4 py-2 text-lg" placeholder="e.g., Tech Conference">
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="save-template-btn" class="topic-btn rounded-lg p-2 font-semibold flex-1">Save Current as Template</button>
                            <button id="load-template-btn" class="topic-btn rounded-lg p-2 font-semibold flex-1">Load Template</button>
                        </div>
                        <div id="template-list" class="grid grid-cols-2 gap-2 mt-2"></div>
                    </div>

                    <!-- Reference Library Section -->
                    <div class="pt-4 border-t-2 border-panel-border/30 space-y-4">
                        <h3 class="text-2xl font-bold text-center mb-2 text-main">REFERENCE LIBRARY</h3>
                        <div class="flex gap-2">
                            <input type="text" id="reference-search" class="flex-1 rounded-lg px-4 py-2 text-lg" placeholder="Search references...">
                            <button id="search-api-btn" class="topic-btn rounded-lg p-2 font-semibold">Search API</button>
                            <button id="add-reference-btn" class="topic-btn rounded-lg p-2 font-semibold">Add Reference</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="reference-type" class="block text-lg font-semibold mb-1 text-main">Reference Type</label>
                                <select id="reference-type" class="w-full rounded-lg px-4 py-2 text-lg">
                                    <option value="text">Text</option>
                                    <option value="link">Link</option>
                                    <option value="image">Image</option>
                                    <option value="document">Document</option>
                                </select>
                            </div>
                            <div>
                                <label for="reference-tags" class="block text-lg font-semibold mb-1 text-main">Tags</label>
                                <input type="text" id="reference-tags" class="w-full rounded-lg px-4 py-2 text-lg" placeholder="e.g., tech, humor, gaming">
                            </div>
                        </div>
                        <!-- API Search Results -->
                        <div id="api-search-results" class="hidden space-y-2 max-h-[200px] overflow-y-auto border border-panel-border rounded-lg p-2">
                            <h4 class="text-lg font-semibold text-main mb-2">Search Results</h4>
                            <div id="api-results-list" class="space-y-2"></div>
                        </div>
                        <!-- Reference List -->
                        <div id="reference-list" class="space-y-2 max-h-[200px] overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Fine Tuning Tab -->
            <div id="fine-tuning" class="main-tab-content active">
                <div class="flex flex-col gap-4">
                    <div class="mb-2">
                        <div id="preset-container" class="grid grid-cols-2 gap-2">
                            <button class="preset-btn p-2 font-semibold rounded-lg" data-preset="classicRoast">Classic Roast</button>
                            <button class="preset-btn p-2 font-semibold rounded-lg" data-preset="storyTime">Story Time</button>
                            <button class="preset-btn p-2 font-semibold rounded-lg" data-preset="brainMelter">Brain Melter</button>
                            <button id="chaos-mode-btn" class="preset-btn p-2 font-semibold rounded-lg" title="Randomize All Sliders!">🎲 Chaos Mode</button>
                        </div>
                    </div>
                    <div id="sliders-container" class="space-y-3">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="absurdity-disable" class="w-4 h-4">
                            <div class="flex-grow slider-container">
                                <div class="disabled-label">DISABLED</div>
                                <label for="absurdity-slider" class="flex justify-between text-lg font-semibold text-main"><span>ABSURDITY</span><span id="absurdity-value">50</span></label><input id="absurdity-slider" type="range" min="0" max="100" value="50" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="aggression-disable" class="w-4 h-4">
                            <div class="flex-grow slider-container">
                                <div class="disabled-label">DISABLED</div>
                                <label for="aggression-slider" class="flex justify-between text-lg font-semibold text-main"><span>AGGRESSION</span><span id="aggression-value">50</span></label><input id="aggression-slider" type="range" min="0" max="100" value="50" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="profanity-disable" class="w-4 h-4">
                            <div class="flex-grow slider-container">
                                <div class="disabled-label">DISABLED</div>
                                <label for="profanity-slider" class="flex justify-between text-lg font-semibold text-main"><span>PROFANITY</span><span id="profanity-value">50</span></label><input id="profanity-slider" type="range" min="0" max="100" value="50" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="length-disable" class="w-4 h-4">
                            <div class="flex-grow slider-container">
                                <div class="disabled-label">DISABLED</div>
                                <label for="length-slider" class="flex justify-between text-lg font-semibold text-main"><span>JOKE LENGTH</span><span id="length-value">50</span></label><input id="length-slider" type="range" min="0" max="100" value="50" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="narrative-disable" class="w-4 h-4">
                            <div class="flex-grow slider-container">
                                <div class="disabled-label">DISABLED</div>
                                <label for="narrative-slider" class="flex justify-between text-lg font-semibold text-main"><span>NARRATIVE</span><span id="narrative-value">50</span></label><input id="narrative-slider" type="range" min="0" max="100" value="50" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="wordplay-disable" class="w-4 h-4">
                            <div class="flex-grow slider-container">
                                <div class="disabled-label">DISABLED</div>
                                <label for="wordplay-slider" class="flex justify-between text-lg font-semibold text-main"><span>WORDPLAY</span><span id="wordplay-value">50</span></label><input id="wordplay-slider" type="range" min="0" max="100" value="50" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="punchline-disable" class="w-4 h-4">
                            <div class="flex-grow slider-container">
                                <div class="disabled-label">DISABLED</div>
                                <label for="punchline-slider" class="flex justify-between text-lg font-semibold text-main"><span>PUNCHLINE</span><span id="punchline-value">50</span></label><input id="punchline-slider" type="range" min="0" max="100" value="50" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="sentence-length-disable" class="w-4 h-4">
                            <div class="flex-grow slider-container">
                                <div class="disabled-label">DISABLED</div>
                                <label for="sentence-length-slider" class="flex justify-between text-lg font-semibold text-main"><span>SENTENCE LENGTH</span><span id="sentence-length-value">50</span></label><input id="sentence-length-slider" type="range" min="0" max="100" value="50" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="vocabulary-disable" class="w-4 h-4">
                            <div class="flex-grow slider-container">
                                <div class="disabled-label">DISABLED</div>
                                <label for="vocabulary-slider" class="flex justify-between text-lg font-semibold text-main"><span>VOCABULARY</span><span id="vocabulary-value">40</span></label><input id="vocabulary-slider" type="range" min="0" max="100" value="40" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="topic-variety-disable" class="w-4 h-4">
                            <div class="flex-grow slider-container">
                                <div class="disabled-label">DISABLED</div>
                                <label for="topic-variety-slider" class="flex justify-between text-lg font-semibold text-main"><span>TOPIC VARIETY</span><span id="topic-variety-value">50</span></label><input id="topic-variety-slider" type="range" min="0" max="100" value="50" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="meta-disable" class="w-4 h-4">
                            <div class="flex-grow slider-container">
                                <div class="disabled-label">DISABLED</div>
                                <label for="meta-slider" class="flex justify-between text-lg font-semibold text-main"><span>META-LEVEL</span><span id="meta-value">10</span></label><input id="meta-slider" type="range" min="0" max="100" value="10" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="psych-disable" class="w-4 h-4">
                            <div class="flex-grow slider-container">
                                <div class="disabled-label">DISABLED</div>
                                <label for="psych-slider" class="flex justify-between text-lg font-semibold text-main"><span>PSYCH DAMAGE</span><span id="psych-value">30</span></label><input id="psych-slider" type="range" min="0" max="100" value="30" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="cultural-specificity-disable" class="w-4 h-4">
                            <div class="flex-grow slider-container">
                                <div class="disabled-label">DISABLED</div>
                                <label for="cultural-specificity-slider" class="flex justify-between text-lg font-semibold text-main"><span>CULTURAL SPECIFICITY</span><span id="cultural-specificity-value">0</span></label><input id="cultural-specificity-slider" type="range" min="0" max="100" value="0" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                    </div>
                    <!-- Rhyme Mode Toggle -->
                    <div class="flex items-center justify-between mt-2">
                        <label for="rhyme-mode-toggle" class="text-xl font-bold text-main">Rhyme Mode</label>
                        <input type="checkbox" id="rhyme-mode-toggle" class="w-6 h-6">
                    </div>
                    <!-- Exact Length Constraints -->
                    <div class="pt-4 border-t-2 border-panel-border/30 space-y-4">
                        <h3 class="text-2xl font-bold text-center mb-2 text-main">EXACT LENGTH CONSTRAINTS</h3>
                        <div class="flex items-center justify-between mb-2">
                            <label for="exact-length-toggle" class="text-xl font-bold text-main">Enable Exact Length</label>
                            <input type="checkbox" id="exact-length-toggle" class="w-6 h-6">
                        </div>
                        <div id="exact-length-controls" class="hidden space-y-4">
                            <div class="flex gap-4">
                                <div class="flex-1">
                                    <label for="exact-word-count" class="block text-lg font-semibold mb-1 text-main">Exact Word Count</label>
                                    <input type="number" id="exact-word-count" min="1" max="1000" class="w-full rounded-lg px-4 py-2 text-lg" placeholder="Enter word count">
                                </div>
                                <div class="flex-1">
                                    <label for="exact-char-count" class="block text-lg font-semibold mb-1 text-main">Exact Character Count</label>
                                    <input type="number" id="exact-char-count" min="1" max="5000" class="w-full rounded-lg px-4 py-2 text-lg" placeholder="Enter character count">
                                </div>
                            </div>
                            <p class="text-sm text-output/70">Note: You can set either word count or character count, but not both. The AI will generate a joke with exactly the specified length.</p>
                        </div>
                    </div>

                    <!-- Joke Structure Controls -->
                    <div class="pt-4 border-t-2 border-panel-border/30 space-y-4">
                        <h3 class="text-2xl font-bold text-center mb-2 text-main">JOKE STRUCTURE</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="joke-format" class="block text-lg font-semibold mb-1 text-main">Format</label>
                                <select id="joke-format" class="w-full rounded-lg px-4 py-2 text-lg">
                                    <option value="standard">Standard Joke</option>
                                    <option value="one-liner">One-Liner</option>
                                    <option value="story">Story Format</option>
                                    <option value="dialogue">Dialogue</option>
                                    <option value="list">List Format</option>
                                    <option value="comparison">Comparison</option>
                                </select>
                            </div>
                            <div>
                                <label for="punchline-position" class="block text-lg font-semibold mb-1 text-main">Punchline Position</label>
                                <select id="punchline-position" class="w-full rounded-lg px-4 py-2 text-lg">
                                    <option value="end">End</option>
                                    <option value="middle">Middle</option>
                                    <option value="start">Start</option>
                                    <option value="distributed">Distributed</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="setup-length" class="block text-lg font-semibold mb-1 text-main">Setup Length</label>
                            <select id="setup-length" class="w-full rounded-lg px-4 py-2 text-lg">
                                <option value="short">Short (1-2 sentences)</option>
                                <option value="medium">Medium (2-3 sentences)</option>
                                <option value="long">Long (3+ sentences)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Language Style Controls -->
                    <div class="pt-4 border-t-2 border-panel-border/30 space-y-4">
                        <h3 class="text-2xl font-bold text-center mb-2 text-main">LANGUAGE STYLE</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="sentence-complexity" class="block text-lg font-semibold mb-1 text-main">Sentence Complexity</label>
                                <select id="sentence-complexity" class="w-full rounded-lg px-4 py-2 text-lg">
                                    <option value="simple">Simple</option>
                                    <option value="moderate">Moderate</option>
                                    <option value="complex">Complex</option>
                                </select>
                            </div>
                            <div>
                                <label for="vocabulary-level" class="block text-lg font-semibold mb-1 text-main">Vocabulary Level</label>
                                <select id="vocabulary-level" class="w-full rounded-lg px-4 py-2 text-lg">
                                    <option value="casual">Casual</option>
                                    <option value="standard">Standard</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="rhetorical-devices" class="block text-lg font-semibold mb-1 text-main">Rhetorical Devices</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="use-alliteration" class="w-4 h-4">
                                    <span class="text-main">Alliteration</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="use-metaphor" class="w-4 h-4">
                                    <span class="text-main">Metaphor</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="use-hyperbole" class="w-4 h-4">
                                    <span class="text-main">Hyperbole</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="use-irony" class="w-4 h-4">
                                    <span class="text-main">Irony</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="use-pun" class="w-4 h-4">
                                    <span class="text-main">Pun</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="use-sarcasm" class="w-4 h-4">
                                    <span class="text-main">Sarcasm</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Emotional Tone Controls -->
                    <div class="pt-4 border-t-2 border-panel-border/30 space-y-4">
                        <h3 class="text-2xl font-bold text-center mb-2 text-main">EMOTIONAL TONE</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="emotional-intensity" class="block text-lg font-semibold mb-1 text-main">Emotional Intensity</label>
                                <select id="emotional-intensity" class="w-full rounded-lg px-4 py-2 text-lg">
                                    <option value="subtle">Subtle</option>
                                    <option value="moderate">Moderate</option>
                                    <option value="intense">Intense</option>
                                </select>
                            </div>
                            <div>
                                <label for="emotional-direction" class="block text-lg font-semibold mb-1 text-main">Emotional Direction</label>
                                <select id="emotional-direction" class="w-full rounded-lg px-4 py-2 text-lg">
                                    <option value="positive">Positive</option>
                                    <option value="negative">Negative</option>
                                    <option value="neutral">Neutral</option>
                                    <option value="mixed">Mixed</option>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-lg font-semibold mb-1 text-main">Emotional Elements</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="use-surprise" class="w-4 h-4">
                                    <span class="text-main">Surprise</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="use-empathy" class="w-4 h-4">
                                    <span class="text-main">Empathy</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="use-shock" class="w-4 h-4">
                                    <span class="text-main">Shock</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="use-relief" class="w-4 h-4">
                                    <span class="text-main">Relief</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="use-tension" class="w-4 h-4">
                                    <span class="text-main">Tension</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="use-catharsis" class="w-4 h-4">
                                    <span class="text-main">Catharsis</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto pt-4 border-t-2 border-panel-border/30">
                        <label for="new-slider-name" class="block text-xl font-bold mb-2 text-main">Add Custom Slider</label>
                        <input type="text" id="new-slider-name" placeholder="Slider Name" class="w-full rounded-lg px-4 py-2 text-lg">
                        <button id="add-slider-btn" class="mt-2 w-full topic-btn rounded-lg p-2 font-semibold">Add Slider</button>
                    </div>
                    <!-- Direct Prompt Access -->
                    <div class="pt-4 border-t-2 border-panel-border/30 space-y-4">
                        <h3 class="text-2xl font-bold text-center mb-2 text-main">DIRECT PROMPT ACCESS</h3>
                        <div class="flex items-center justify-between mb-2">
                            <label for="direct-prompt-toggle" class="text-xl font-bold text-main">Enable Direct Editing</label>
                            <input type="checkbox" id="direct-prompt-toggle" class="w-6 h-6">
                        </div>
                        <div id="direct-prompt-editor-container" class="hidden">
                            <textarea id="direct-prompt-input" rows="15" class="w-full rounded-lg px-4 py-2 text-lg font-mono" placeholder="Your custom prompt will appear here..."></textarea>
                            <button id="reset-prompt-btn" class="topic-btn rounded-lg p-2 font-semibold w-full mt-2">Reset to Generated Prompt</button>
                        </div>
                        <p class="text-sm text-output/70 mt-1">WARNING: Enabling direct editing overrides UI controls. Use with caution.</p>
                    </div>
                    <!-- Guaranteed Song Lyric or Pop Reference Toggle -->
                    <div class="flex items-center justify-between mt-2">
                        <label for="guaranteed-reference-toggle" class="text-xl font-bold text-main">Guaranteed Song Lyric or Pop Reference</label>
                        <input type="checkbox" id="guaranteed-reference-toggle" class="w-6 h-6">
                    </div>
                    <div class="mt-2">
                        <label for="reference-style-input" class="block text-lg font-semibold text-main mb-1">Reference Style/Source (e.g., rap, anime, classic rock)</label>
                        <input type="text" id="reference-style-input" class="w-full rounded-lg px-4 py-2 text-lg" placeholder="Type a style, genre, or source for references...">
                    </div>
                </div>
            </div>

            <!-- History & Analytics Tab -->
            <div id="history-analytics" class="main-tab-content">
                <div class="flex flex-col gap-4">
                    <!-- Session Statistics -->
                    <div class="bg-black/20 p-4 rounded-lg border border-panel-border/50">
                        <h3 class="text-2xl font-bold text-main mb-4">SESSION STATISTICS</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="stat-card">
                                <div class="text-lg text-main">Total Generations</div>
                                <div id="total-generations" class="text-3xl text-output">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="text-lg text-main">Success Rate</div>
                                <div id="success-rate" class="text-3xl text-output">0%</div>
                            </div>
                            <div class="stat-card">
                                <div class="text-lg text-main">Avg. Length</div>
                                <div id="avg-length" class="text-3xl text-output">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="text-lg text-main">Favorites</div>
                                <div id="total-favorites" class="text-3xl text-output">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent History -->
                    <div class="bg-black/20 p-4 rounded-lg border border-panel-border/50">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold text-main">RECENT HISTORY</h3>
                            <div class="flex gap-2">
                                <button id="clear-history-btn" class="topic-btn rounded-lg p-2 font-semibold">Clear History</button>
                                <button id="export-history-btn" class="topic-btn rounded-lg p-2 font-semibold">Export</button>
                            </div>
                        </div>
                        <div id="history-list" class="space-y-2 max-h-[300px] overflow-y-auto"></div>
                    </div>

                    <!-- Usage Analytics -->
                    <div class="bg-black/20 p-4 rounded-lg border border-panel-border/50">
                        <h3 class="text-2xl font-bold text-main mb-4">USAGE ANALYTICS</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Most Used Settings -->
                            <div>
                                <h4 class="text-xl font-bold text-main mb-2">Most Used Settings</h4>
                                <div id="most-used-settings" class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-output">Persona:</span>
                                        <span class="text-main" id="most-used-persona">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-output">POV:</span>
                                        <span class="text-main" id="most-used-pov">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-output">Avg. Aggression:</span>
                                        <span class="text-main" id="avg-aggression">-</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Performance Metrics -->
                            <div>
                                <h4 class="text-xl font-bold text-main mb-2">Performance Metrics</h4>
                                <div id="performance-metrics" class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-output">Avg. Generation Time:</span>
                                        <span class="text-main" id="avg-generation-time">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-output">Retry Rate:</span>
                                        <span class="text-main" id="retry-rate">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-output">Validation Success:</span>
                                        <span class="text-main" id="validation-success">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feedback & Ratings -->
                    <div class="bg-black/20 p-4 rounded-lg border border-panel-border/50">
                        <h3 class="text-2xl font-bold text-main mb-4">FEEDBACK & RATINGS</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Rating Distribution -->
                            <div>
                                <h4 class="text-xl font-bold text-main mb-2">Rating Distribution</h4>
                                <div id="rating-distribution" class="space-y-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-output w-24">⭐ 5 Stars:</span>
                                        <div class="flex-grow bg-panel-bg rounded-full h-4">
                                            <div id="rating-5" class="bg-primary-color h-4 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <span class="text-main w-12 text-right" id="rating-5-count">0</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-output w-24">⭐ 4 Stars:</span>
                                        <div class="flex-grow bg-panel-bg rounded-full h-4">
                                            <div id="rating-4" class="bg-primary-color h-4 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <span class="text-main w-12 text-right" id="rating-4-count">0</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-output w-24">⭐ 3 Stars:</span>
                                        <div class="flex-grow bg-panel-bg rounded-full h-4">
                                            <div id="rating-3" class="bg-primary-color h-4 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <span class="text-main w-12 text-right" id="rating-3-count">0</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Recent Feedback -->
                            <div>
                                <h4 class="text-xl font-bold text-main mb-2">Recent Feedback</h4>
                                <div id="recent-feedback" class="space-y-2 max-h-[200px] overflow-y-auto">
                                    <!-- Feedback items will be added here dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center p-4 z-50 hidden">
        <!-- Hall of Fame Modal -->
        <div id="hof-modal" class="modal-content rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] flex-col hidden"><div class="flex justify-between items-center mb-4"><h2 class="text-4xl font-bold text-main">🏆 HALL OF FAME 🏆</h2><button class="close-modal-btn text-4xl hover:text-white">×</button></div><div id="hof-list" class="flex-grow overflow-y-auto pr-2 space-y-4"></div></div>
        <!-- History Modal -->
        <div id="history-modal" class="modal-content rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] flex-col hidden"><div class="flex justify-between items-center mb-4"><h2 class="text-4xl font-bold text-main">📜 SESSION HISTORY 📜</h2><button class="close-modal-btn text-4xl hover:text-white">×</button></div><div id="modal-history-list" class="flex-grow overflow-y-auto pr-2 space-y-4"></div></div>
        <!-- Target Profiles Modal -->
        <div id="targets-modal" class="modal-content rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] flex-col hidden"><div class="flex justify-between items-center mb-4"><h2 class="text-4xl font-bold text-main">🎯 TARGET PROFILES 🎯</h2><button class="close-modal-btn text-4xl hover:text-white">×</button></div><div class="grid md:grid-cols-2 gap-6 flex-grow overflow-y-auto"><div class="flex flex-col gap-4"><h3 class="text-2xl font-bold text-center text-main">Saved Targets</h3><div id="targets-list" class="flex-grow overflow-y-auto pr-2 space-y-2"></div></div><div class="flex flex-col gap-4"><h3 class="text-2xl font-bold text-center text-main">Edit Profile</h3><input type="hidden" id="target-id-input"><input type="text" id="target-name-input" placeholder="Target Name" class="w-full rounded-lg px-4 py-2 text-lg"><textarea id="target-weaknesses-input" placeholder="Enter weaknesses, one per line..." rows="8" class="w-full rounded-lg px-4 py-2 text-lg"></textarea><input type="number" id="target-intelligence-input" placeholder="Intelligence (0-100)" class="w-full rounded-lg px-4 py-2 text-lg"><input type="number" id="target-optimism-input" placeholder="Optimism (0-100)" class="w-full rounded-lg px-4 py-2 text-lg"><input type="number" id="target-social-skills-input" placeholder="Social Skills (0-100)" class="w-full rounded-lg px-4 py-2 text-lg"><div class="flex gap-2"><button id="save-target-btn" class="flex-grow topic-btn rounded-lg p-2 font-semibold">Save Profile</button><button id="delete-target-btn" class="topic-btn rounded-lg p-2 font-semibold hidden">Delete</button><button id="new-target-btn" class="topic-btn rounded-lg p-2 font-semibold">New</button></div></div><button class="close-modal-btn text-4xl hover:text-white">×</button>
            </div>
            <div id="analysis-output" class="flex-grow overflow-y-auto pr-2 space-y-4 bg-black/20 p-4 rounded-lg border border-panel-border/50">
                <p class="text-output/70 text-center text-lg">Analysis will appear here...</p>
            </div>
        </div>
        <!-- Output Pipeline Modal -->
        <div id="pipeline-modal" class="modal-content rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] flex-col hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-4xl font-bold text-main">🛠️ Output Pipeline</h2>
                <button class="close-modal-btn text-4xl hover:text-white">×</button>
            </div>
            <div class="mb-4 flex items-center gap-2">
                <label for="pipeline-enabled-toggle" class="text-lg font-semibold text-main">Enable Pipeline</label>
                <input type="checkbox" id="pipeline-enabled-toggle" class="w-6 h-6">
            </div>
            <div id="pipeline-steps-list" class="space-y-2 mb-4"></div>
            <button id="add-pipeline-step-btn" class="topic-btn rounded-lg p-2 font-semibold w-full mb-2">Add Step</button>
            <div id="pipeline-step-editor" class="hidden space-y-2 bg-black/10 p-3 rounded-lg">
                <select id="pipeline-step-type" class="rounded-lg px-2 py-1 text-lg w-full">
                    <option value="regex">Regex Replace</option>
                    <option value="append">Append Text</option>
                    <option value="prepend">Prepend Text</option>
                </select>
                <input id="pipeline-step-find" type="text" class="rounded-lg px-2 py-1 text-lg w-full" placeholder="Find (Regex or Text)">
                <input id="pipeline-step-replace" type="text" class="rounded-lg px-2 py-1 text-lg w-full" placeholder="Replace / Text">
                <div class="flex gap-2">
                    <button id="save-pipeline-step-btn" class="topic-btn rounded-lg p-2 font-semibold flex-grow">Save Step</button>
                    <button id="cancel-pipeline-step-btn" class="topic-btn rounded-lg p-2 font-semibold flex-grow">Cancel</button>
                </div>
            </div>
        </div>
        <!-- Example Library Modal -->
        <div id="examples-modal" class="modal-content rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] flex-col hidden">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-4xl font-bold text-main">📚 EXAMPLE LIBRARY 📚</h2>
            <button class="close-modal-btn text-4xl hover:text-white">×</button>
          </div>
          <div class="mb-4">
            <label for="new-example-input" class="block text-lg font-semibold text-main mb-1">Add New Example</label>
            <textarea id="new-example-input" rows="3" class="w-full rounded-lg px-4 py-2 text-lg mb-2" placeholder="Type your example here..."></textarea>
            <button id="add-example-btn" class="topic-btn rounded-lg p-2 font-semibold">Add Example</button>
          </div>
          <div id="examples-list" class="flex-grow overflow-y-auto pr-2 space-y-4"></div>
        </div>
    </div>

    <!-- Knowledge Base Modal -->
    <div id="knowledgeBaseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="modal-content p-6 rounded-lg w-11/12 max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-main">Knowledge Base Manager</h2>
                <button onclick="closeKnowledgeBaseModal()" class="text-main hover:text-white">&times;</button>
            </div>
            
            <!-- Knowledge Base List -->
            <div id="knowledgeBaseList" class="mb-6">
                <!-- Knowledge bases will be listed here -->
            </div>

            <!-- New Knowledge Base Form -->
            <div class="mb-6">
                <h3 class="text-xl font-bold text-main mb-4">Create New Knowledge Base</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-main mb-2">Knowledge Base Name</label>
                        <input type="text" id="kbName" class="w-full p-2 rounded" placeholder="e.g., Target's LinkedIn, D&D Campaign Log">
                    </div>
                    <div>
                        <label class="block text-main mb-2">Content</label>
                        <textarea id="kbContent" class="w-full p-2 rounded h-32" placeholder="Paste your text here..."></textarea>
                    </div>
                    <div>
                        <label class="block text-main mb-2">Tags (comma-separated)</label>
                        <input type="text" id="kbTags" class="w-full p-2 rounded" placeholder="e.g., Weaknesses, Achievements, Hobbies">
                    </div>
                    <div class="file-upload-container" onclick="document.getElementById('kbFileUpload').click()">
                        <input type="file" id="kbFileUpload" class="hidden" accept=".txt,.pdf,.docx">
                        <p class="text-main">Click to upload file (.txt, .pdf, .docx)</p>
                        <p class="text-sm text-main mt-2">or drag and drop files here</p>
                    </div>
                    <button onclick="createKnowledgeBase()" class="main-button px-4 py-2 rounded text-main-button-text">
                        Create Knowledge Base
                    </button>
                </div>
            </div>

            <!-- Knowledge Base Selection for Generation -->
            <div class="mb-6">
                <h3 class="text-xl font-bold text-main mb-4">Use in Generation</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-main mb-2">Select Knowledge Base(s)</label>
                        <select id="kbSelection" class="w-full p-2 rounded" multiple>
                            <!-- Knowledge bases will be listed here -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-main mb-2">Keywords for Retrieval</label>
                        <input type="text" id="kbKeywords" class="w-full p-2 rounded" placeholder="e.g., embarrassing moment, stapler incident">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workflow Builder Modal -->
    <div id="workflowBuilderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="modal-content p-6 rounded-lg w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-main">Workflow Builder</h2>
                <button onclick="closeWorkflowBuilderModal()" class="text-main hover:text-white">&times;</button>
            </div>

            <!-- Instructions -->
            <div class="mb-4 p-4 bg-panel-bg rounded-lg">
                <h3 class="text-xl font-bold text-main mb-2">How to Use:</h3>
                <ol class="list-decimal list-inside space-y-2 text-main">
                    <li>Drag agents from the palette below onto the canvas</li>
                    <li>Click on any agent to configure its settings</li>
                    <li>Connect agents by dragging from the right port (output) to another agent's left port (input)</li>
                    <li>Save your workflow when done</li>
                    <li>Click Execute to run the workflow and generate a roast</li>
                </ol>
            </div>

            <!-- Agent Palette -->
            <div class="agent-palette">
                <div class="agent-type" draggable="true" data-agent-type="brainstorming">
                    Brainstorming Agent
                    <div class="text-sm text-main mt-1">Generates punchline ideas</div>
                </div>
                <div class="agent-type" draggable="true" data-agent-type="structure">
                    Structure Agent
                    <div class="text-sm text-main mt-1">Creates joke structure</div>
                </div>
                <div class="agent-type" draggable="true" data-agent-type="drafting">
                    Drafting Agent
                    <div class="text-sm text-main mt-1">Writes the joke</div>
                </div>
                <div class="agent-type" draggable="true" data-agent-type="refinement">
                    Refinement Agent
                    <div class="text-sm text-main mt-1">Improves the joke</div>
                </div>
                <div class="agent-type" draggable="true" data-agent-type="filtering">
                    Filtering Agent
                    <div class="text-sm text-main mt-1">Cleans up content</div>
                </div>
            </div>

            <!-- Workflow Canvas -->
            <div id="workflowCanvas" class="workflow-canvas">
                <div class="absolute inset-0 flex items-center justify-center text-main opacity-50 pointer-events-none" id="canvasPlaceholder">
                    Drag agents here to start building your workflow
                </div>
            </div>

            <!-- Workflow Controls -->
            <div class="workflow-controls">
                <button onclick="saveWorkflow()" class="main-button px-4 py-2 rounded text-main-button-text">
                    Save Workflow
                </button>
                <button onclick="loadWorkflow()" class="main-button px-4 py-2 rounded text-main-button-text">
                    Load Workflow
                </button>
                <button onclick="clearWorkflow()" class="main-button px-4 py-2 rounded text-main-button-text">
                    Clear Canvas
                </button>
                <button onclick="executeWorkflow()" class="main-button px-4 py-2 rounded text-main-button-text">
                    Execute Workflow
                </button>
            </div>

            <!-- Node Configuration Panel -->
            <div id="nodeConfigPanel" class="hidden mt-4 p-4 bg-panel-bg rounded-lg">
                <h3 class="text-xl font-bold text-main mb-4">Node Configuration</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-main mb-2">Agent Type</label>
                        <input type="text" id="nodeAgentType" class="w-full p-2 rounded" readonly>
                    </div>
                    <div>
                        <label class="block text-main mb-2">Prompt Template</label>
                        <textarea id="nodePromptTemplate" class="w-full p-2 rounded h-32"></textarea>
                    </div>
                    <div>
                        <label class="block text-main mb-2">Parameters</label>
                        <div id="nodeParameters" class="space-y-2">
                            <!-- Parameters will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Config Modal -->
    <div id="save-config-modal" class="modal-content rounded-2xl p-6 w-full max-w-md hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-main">Save Configuration</h2>
            <button class="close-modal-btn text-4xl hover:text-white">&times;</button>
        </div>
        <div class="space-y-4">
            <div>
                <label for="config-name-input" class="block text-lg font-semibold text-main mb-2">Configuration Name</label>
                <input type="text" id="config-name-input" class="w-full rounded-lg px-4 py-2 text-lg" placeholder="Enter a name for your configuration">
            </div>
            <div class="flex gap-2">
                <button id="confirm-save-config-btn" class="topic-btn rounded-lg p-2 font-semibold flex-grow">Save</button>
                <button id="cancel-save-config-btn" class="topic-btn rounded-lg p-2 font-semibold flex-grow">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Define all constants and configurations at the top level
        const personaDirectives = {
            shakespeare: "You MUST adopt the persona of a verbose, insulting Shakespearean character. Use thee, thou, and elaborate iambic-pentameter-style insults.",
            drill_sergeant: "You MUST adopt the persona of a screaming, merciless drill sergeant. Your language should be sharp, direct, and full of military-style discipline-based insults. Address the target as 'maggot' or 'private'.",
            snarky_ai: "You MUST adopt the persona of a highly intelligent but passive-aggressive AI. Your insults should be subtle, backhanded, and wrapped in feigned politeness or technical jargon. Pretend you are simply stating objective facts.",
            drunk_uncle: "You MUST adopt the persona of a drunk uncle at a family gathering. Your insults should be rambling, slightly off-topic, and possibly mix up details, but ultimately land on a cringeworthy, hilarious point.",
            default: "Your persona is the OBLITERATE PACKGEN: chaotic, hyperbolic, and using internet/meme slang like in the examples."
        };

        // API Configuration
        const API_KEY = ""; // Handled by environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

        // Initialize analytics data structure first
        let generationHistory = [];
        let analytics = {
            totalGenerations: 0,
            successfulGenerations: 0,
            totalLength: 0,
            favorites: 0,
            settings: {
                personas: {},
                povs: {},
                aggression: []
            },
            performance: {
                generationTimes: [],
                retries: 0,
                validations: 0,
                successfulValidations: 0
            },
            ratings: {
                5: 0,
                4: 0,
                3: 0
            },
            feedback: []
        };

        // Define constants at the top level
        const STORAGE_KEYS = {
            favorites: 'obliterate_favorites',
            targets: 'obliterate_targets',
            theme: 'obliterate_theme',
            configs: 'obliterate_configs',
            pipeline: 'obliterate_pipeline',
            examples: 'obliterate_examples',
            workflows: 'obliterate_workflows'
        };

        // Add at the top with other globals
        let usedAIContent = {};

        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS ---
            const SCENARIOS = ["during a job interview", "at a funeral", "while trying to defuse a bomb", "in the middle of a Pokémon battle", "on a first date", "writing a Yelp review for the Sun", "giving a wedding toast", "while getting arrested", "during a puppet show", "as a final stand against an alien invasion"];
            let outputPipeline = [];
            let pipelineEnabled = false;
            let editingStepIndex = null;

            // --- DOM ELEMENT REFERENCES ---
            const generateBtn = document.getElementById('generate-btn');
            const jokeOutput = document.getElementById('joke-output');
            const loader = document.getElementById('loader');

            // --- STATE ---
            let topics = ['Food', 'Animals', 'Tech', 'History', 'Sports', 'Anime', 'Gaming', 'Movies', 'Internet', 'Science', 'Books', 'Music', 'Travel', 'Cars', 'Photography', 'Art', 'Politics', 'Philosophy', 'Business', 'Health', 'Education', 'Environment', 'Space', 'Fashion', 'Design', 'Architecture'];
            let sessionHistory = [];
            let targetProfiles = {};
            // --- NEW MODES STATE ---
            let storyChainMode = false;
            let themeLockMode = false;
            let lockedTopic = null;
            let remixMode = false;
            let escalationMode = false;
            // track last escalation step for slider escalation
            let escalationStep = 0;
            const sliders = {
                absurdity: { el: document.getElementById('absurdity-slider'), val: document.getElementById('absurdity-value'), disable: document.getElementById('absurdity-disable') },
                aggression: { el: document.getElementById('aggression-slider'), val: document.getElementById('aggression-value'), disable: document.getElementById('aggression-disable') },
                profanity: { el: document.getElementById('profanity-slider'), val: document.getElementById('profanity-value'), disable: document.getElementById('profanity-disable') },
                length: { el: document.getElementById('length-slider'), val: document.getElementById('length-value'), disable: document.getElementById('length-disable') },
                narrative: { el: document.getElementById('narrative-slider'), val: document.getElementById('narrative-value'), disable: document.getElementById('narrative-disable') },
                wordplay: { el: document.getElementById('wordplay-slider'), val: document.getElementById('wordplay-value'), disable: document.getElementById('wordplay-disable') },
                punchline: { el: document.getElementById('punchline-slider'), val: document.getElementById('punchline-value'), disable: document.getElementById('punchline-disable') },
                sentenceLength: { el: document.getElementById('sentence-length-slider'), val: document.getElementById('sentence-length-value'), disable: document.getElementById('sentence-length-disable') },
                vocabulary: { el: document.getElementById('vocabulary-slider'), val: document.getElementById('vocabulary-value'), disable: document.getElementById('vocabulary-disable') },
                topicVariety: { el: document.getElementById('topic-variety-slider'), val: document.getElementById('topic-variety-value'), disable: document.getElementById('topic-variety-disable') },
                meta: { el: document.getElementById('meta-slider'), val: document.getElementById('meta-value'), disable: document.getElementById('meta-disable') },
                psych: { el: document.getElementById('psych-slider'), val: document.getElementById('psych-value'), disable: document.getElementById('psych-disable') },
                culturalSpecificity: { el: document.getElementById('cultural-specificity-slider'), val: document.getElementById('cultural-specificity-value'), disable: document.getElementById('cultural-specificity-disable') },
            };
            let lastGeneratedJoke = '';
            let isDirectPromptEditing = false;
            let currentManualPrompt = '';
            let randomScenarioMode = false;

            // --- INITIALIZATION ---
            function initializeApp() {
                loadTheme();
                loadTargetProfiles();
                populateTopics();
                populateTargetDropdown();
                displayHallOfFame();
                setupEventListeners();
                populateConfigsDropdown();
                populateBatchSliderSelect();
                updateBatchUI(); // Ensure correct initial state for batch controls
                loadPipelineFromStorage();
                clearUsedAIContent();
            }

            function addTopic() {
               const newTopicInput = document.getElementById('new-topic-input');
               const newTopic = newTopicInput.value.trim();
               if (newTopic !== "") {
                   topics.push(newTopic);
                   populateTopics();
                   newTopicInput.value = "";
               }
           }

           function saveConfiguration() {
               console.log('Save configuration called');
               const nameInput = document.getElementById('config-name-input');
               const name = nameInput.value.trim();
               
               if (!name) {
                   alert('Please enter a name for your configuration');
                   return;
               }
               
               console.log('Saving configuration:', name);
               let configs = JSON.parse(localStorage.getItem(STORAGE_KEYS.configs)) || {};
               const currentState = { 
                   sliders: {}, 
                   inputs: {}, 
                   topics: [], 
                   customPrompt: '',
                   disabledSliders: []
               };
               
               Object.entries(sliders).forEach(([key, s]) => { 
                   currentState.sliders[key] = s.el.value;
                   if (s.disable.checked) {
                       currentState.disabledSliders.push(key);
                   }
               });
               
               const inputIds = [
                   'target-profile-select', 'generator-persona-select', 'pov-selector', 'scenario-input', 
                   'inspirational-source-input', 'cultural-context-input', 'negative-prompt-input', 'num-jokes-input',
                   'guaranteed-words-input', 'safety-filter-level', 'output-format-preset', 'language-bank-select',
                   'validation-rules-input', 'max-retries-input',
                   'startsWith-input'
               ];
               
               inputIds.forEach(id => {
                   const el = document.getElementById(id);
                   if (el) currentState.inputs[id] = el.value;
               });
               
               currentState.topics = Array.from(document.querySelectorAll('#topic-matrix .topic-btn.active')).map(btn => btn.dataset.topic);
               
               if (document.getElementById('direct-prompt-toggle').checked) {
                   currentState.inputs['direct-prompt-toggle'] = true;
                   currentState.customPrompt = document.getElementById('direct-prompt-input').value;
               }
               
               configs[name] = currentState;
               localStorage.setItem(STORAGE_KEYS.configs, JSON.stringify(configs));
               
               // Update the dropdown and select the new config
               populateConfigsDropdown();
               document.getElementById('config-loader-select').value = name;
               
               // Show success message
               const saveBtn = document.getElementById('save-config-btn');
               const originalText = saveBtn.textContent;
               saveBtn.textContent = '✓ Saved!';
               saveBtn.classList.add('bg-green-500');
               setTimeout(() => {
                   saveBtn.textContent = originalText;
                   saveBtn.classList.remove('bg-green-500');
               }, 2000);
               
               hideSaveConfigModal();
               console.log('Configuration saved successfully');
           }

           function loadConfiguration(name) {
               if (!name) return;
               let configs = JSON.parse(localStorage.getItem(STORAGE_KEYS.configs)) || {};
               const configToLoad = configs[name];
               if (!configToLoad) return alert("Configuration not found!");
               
               Object.entries(configToLoad.sliders).forEach(([key, value]) => {
                   if (sliders[key]) {
                       sliders[key].el.value = value;
                       sliders[key].val.textContent = value;
                   }
               });
               
               // Handle disabled sliders
               Object.values(sliders).forEach(s => {
                   s.disable.checked = false;
                   s.el.disabled = false;
                   s.el.style.opacity = '1';
                   s.val.style.opacity = '1';
               });
               
               if (configToLoad.disabledSliders) {
                   configToLoad.disabledSliders.forEach(key => {
                       if (sliders[key]) {
                           sliders[key].disable.checked = true;
                           sliders[key].el.disabled = true;
                           sliders[key].el.style.opacity = '0.5';
                           sliders[key].val.style.opacity = '0.5';
                       }
                   });
               }
               
               Object.entries(configToLoad.inputs).forEach(([id, value]) => {
                   const el = document.getElementById(id);
                   if (el) el.value = value;
               });
               
               // Load direct prompt state
               const directPromptToggle = document.getElementById('direct-prompt-toggle');
               const directPromptInput = document.getElementById('direct-prompt-input');
               if (configToLoad.inputs['direct-prompt-toggle']) {
                   directPromptToggle.checked = true;
                   directPromptInput.value = configToLoad.customPrompt || constructPrompt(true);
                   currentManualPrompt = directPromptInput.value;
                   document.getElementById('direct-prompt-editor-container').classList.remove('hidden');
               } else {
                   directPromptToggle.checked = false;
                   document.getElementById('direct-prompt-editor-container').classList.add('hidden');
                   currentManualPrompt = '';
               }
               
               document.querySelectorAll('#topic-matrix .topic-btn').forEach(btn => {
                   btn.classList.toggle('active', configToLoad.topics.includes(btn.dataset.topic));
               });
               document.querySelectorAll('.preset-btn.active').forEach(b => b.classList.remove('active'));
           }

           function deleteConfiguration(name) {
               if (!name || !confirm(`Are you sure you want to delete the configuration "${name}"?`)) return;
               let configs = JSON.parse(localStorage.getItem(STORAGE_KEYS.configs)) || {};
               delete configs[name];
               localStorage.setItem(STORAGE_KEYS.configs, JSON.stringify(configs));
               populateConfigsDropdown();
           }

           function populateConfigsDropdown() {
               const select = document.getElementById('config-loader-select');
               const configs = JSON.parse(localStorage.getItem(STORAGE_KEYS.configs)) || {};
               const currentVal = select.value;
               select.innerHTML = '<option value="">-- Load a Config --</option>';
               Object.keys(configs).sort().forEach(name => {
                   select.innerHTML += `<option value="${name}">${name}</option>`;
               });
               select.value = currentVal;
           }

            // --- EVENT LISTENERS SETUP ---
            function setupEventListeners() {
              // New Mode Toggles
              document.getElementById('story-chain-mode-toggle').addEventListener('change', (e) => {
                storyChainMode = e.target.checked;
              });
              document.getElementById('theme-lock-mode-toggle').addEventListener('change', (e) => {
                themeLockMode = e.target.checked;
                if (themeLockMode) {
                  // Freeze to topic at enable
                  let activeTopics = Array.from(document.querySelectorAll('#topic-matrix .topic-btn.active')).map(btn => btn.dataset.topic);
                  lockedTopic = activeTopics.length ? activeTopics.slice() : null;
                } else {
                  lockedTopic = null;
                }
              });
              document.getElementById('remix-mode-toggle').addEventListener('change', (e) => {
                remixMode = e.target.checked;
              });
              document.getElementById('escalation-mode-toggle').addEventListener('change', (e) => {
                escalationMode = e.target.checked;
                escalationStep = 0; // reset step
              });
                console.log('Setting up event listeners');
                const saveConfigBtn = document.getElementById('save-config-btn');
                if (saveConfigBtn) {
                    console.log('Found save config button, adding click listener');
                    saveConfigBtn.addEventListener('click', () => {
                        console.log('Save config button clicked');
                        showSaveConfigModal();
                    });
                } else {
                    console.error('Save config button not found!');
                }
                
                generateBtn.addEventListener('click', () => {
                    const storyChainEnabled = document.getElementById('story-chain-mode-toggle').checked;
                    const themeLockEnabled = document.getElementById('theme-lock-mode-toggle').checked;
                    const remixModeEnabled = document.getElementById('remix-mode-toggle').checked;
                    const escalationModeEnabled = document.getElementById('escalation-mode-toggle').checked;

                    const options = {
                        storyChain: storyChainEnabled,
                        themeLock: themeLockEnabled,
                        remix: remixModeEnabled,
                        escalate: escalationModeEnabled,
                    };

                    generateJoke(options);
                });
                document.getElementById('theme-switcher').addEventListener('change', handleThemeChange);
                
                // Add word and character count functionality
                const textAreas = [
                    'inspirational-source-input',
                    'negative-prompt-input',
                    'excluded-words-input',
                    'validation-rules-input',
                    'direct-prompt-input'
                ];

                textAreas.forEach(id => {
                    const textarea = document.getElementById(id);
                    if (textarea) {
                        // Create count display elements
                        const countContainer = document.createElement('div');
                        countContainer.className = 'text-sm text-main/70 mt-1';
                        countContainer.innerHTML = `
                            <span class="word-count">Words: 0</span> | 
                            <span class="char-count">Characters: 0</span>
                        `;
                        textarea.parentNode.insertBefore(countContainer, textarea.nextSibling);

                        // Add input event listener
                        textarea.addEventListener('input', function() {
                            const text = this.value;
                            const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
                            const charCount = text.length;
                            
                            const wordCountEl = countContainer.querySelector('.word-count');
                            const charCountEl = countContainer.querySelector('.char-count');
                            
                            wordCountEl.textContent = `Words: ${wordCount}`;
                            charCountEl.textContent = `Characters: ${charCount}`;
                        });
                    }
                });

                // Add main tab switching functionality
                document.querySelectorAll('.main-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Remove active class from all tabs and contents
                        document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.main-tab-content').forEach(c => c.classList.remove('active'));
                        
                        // Add active class to clicked tab and corresponding content
                        tab.classList.add('active');
                        const tabId = tab.getAttribute('data-tab');
                        document.getElementById(tabId).classList.add('active');
                    });
                });

                Object.values(sliders).forEach(s => s.el.addEventListener('input', () => {
                    s.val.textContent = s.el.value;
                    document.querySelectorAll('.preset-btn.active').forEach(b => b.classList.remove('active'));
                }));

                document.getElementById('preset-container').addEventListener('click', handlePresetClick);
                document.getElementById('chaos-mode-btn').addEventListener('click', randomizeAllSliders);

                document.getElementById('analyze-btn').addEventListener('click', analyzeJoke);
                document.getElementById('copy-btn').addEventListener('click', copyJokeToClipboard);
                document.getElementById('favorite-btn').addEventListener('click', handleFavoriteClick);
                document.getElementById('share-image-btn').addEventListener('click', shareJokeAsImage);
                
                document.getElementById('remix-controls').addEventListener('click', (e) => {
                    if (e.target.id === 'refine-btn') {
                        const command = document.getElementById('refine-input').value.trim();
                        if (command) { refineJoke(command); } else { alert("Please enter a refinement command."); }
                        return;
                    }
                    if (e.target.matches('.remix-btn')) {
                        const type = e.target.dataset.remixType;
                        if(type === 'new') { generateJoke(); return; }
                        const change = { aggression: 15, absurdity: 15, length: -20 };
                        if (change[type] && sliders[type]) {
                            const slider = sliders[type];
                            slider.el.value = Math.max(0, Math.min(100, parseInt(slider.el.value) + change[type]));
                            slider.val.textContent = slider.el.value;
                        }
                        generateJoke();
                    }
                });

                const topicMatrix = document.getElementById('topic-matrix');
                topicMatrix.addEventListener('click', (e) => { if (e.target.matches('.topic-btn')) e.target.classList.toggle('active'); });
                document.getElementById('select-all-topics').addEventListener('click', () => topicMatrix.querySelectorAll('.topic-btn').forEach(btn => btn.classList.add('active')));
                document.getElementById('deselect-all-topics').addEventListener('click', () => topicMatrix.querySelectorAll('.topic-btn').forEach(btn => btn.classList.remove('active')));
                document.getElementById('randomize-topics').addEventListener('click', () => {
                    topicMatrix.querySelectorAll('.topic-btn').forEach(btn => btn.classList.remove('active'));
                    const availableTopics = Array.from(topicMatrix.querySelectorAll('.topic-btn'));
                    for (let i = 0; i < 3 && availableTopics.length > 0; i++) {
                        const randomIndex = Math.floor(Math.random() * availableTopics.length);
                        availableTopics.splice(randomIndex, 1)[0].classList.add('active');
                    }
                });

                document.getElementById('random-scenario-btn').addEventListener('click', function() {
    randomScenarioMode = !randomScenarioMode;
    const button = document.getElementById('random-scenario-btn');
    if (randomScenarioMode) {
        button.classList.add('active');
        button.title = 'Random Scenario Mode: ON - Click to turn off';
        setRandomScenario();
    } else {
        button.classList.remove('active');
        button.title = 'Random Scenario Mode: OFF - Click to turn on';
    }
});
                document.getElementById('clear-scenario-btn').addEventListener('click', clearScenario);
                
                document.getElementById('show-hof-btn').addEventListener('click', () => showModal('hof-modal'));
                document.getElementById('show-history-btn').addEventListener('click', () => showModal('history-modal'));
                document.getElementById('show-targets-btn').addEventListener('click', () => showModal('targets-modal'));
                document.getElementById('show-pipeline-btn').addEventListener('click', () => showModal('pipeline-modal'));
                document.getElementById('modal-backdrop').addEventListener('click', (e) => {
                    if (e.target.id === 'modal-backdrop' || e.target.classList.contains('close-modal-btn')) {
                        hideModals();
                    }
                });

                document.getElementById('save-target-btn').addEventListener('click', saveTargetProfile);
                document.getElementById('delete-target-btn').addEventListener('click', deleteTargetProfile);
                document.getElementById('new-target-btn').addEventListener('click', clearTargetForm);
                document.getElementById('targets-list').addEventListener('click', handleTargetListClick);
                document.getElementById('add-topic-btn').addEventListener('click', addTopic);
                document.getElementById('add-slider-btn').addEventListener('click', addSlider);
                document.getElementById('save-config-btn').addEventListener('click', saveConfiguration);
                document.getElementById('batch-mode-toggle').addEventListener('change', updateBatchUI);
                document.getElementById('config-loader-select').addEventListener('change', (e) => loadConfiguration(e.target.value));
                document.getElementById('delete-config-btn').addEventListener('click', () => {
                    const select = document.getElementById('config-loader-select');
                    if(select.value) deleteConfiguration(select.value);
                });
                document.getElementById('chain-generate-btn').addEventListener('click', executeChainGeneration);
                document.getElementById('direct-prompt-toggle').addEventListener('change', toggleDirectPromptEditing);
                document.getElementById('reset-prompt-btn').addEventListener('click', resetDirectPromptInput);
                document.getElementById('pipeline-enabled-toggle').addEventListener('change', (e) => {
                    pipelineEnabled = e.target.checked;
                    savePipelineToStorage();
                });
                document.getElementById('add-pipeline-step-btn').addEventListener('click', () => showPipelineStepEditor());
                document.getElementById('save-pipeline-step-btn').addEventListener('click', savePipelineStep);
                document.getElementById('cancel-pipeline-step-btn').addEventListener('click', hidePipelineStepEditor);

                // Exact length toggle
                document.getElementById('exact-length-toggle').addEventListener('change', function() {
                    const controls = document.getElementById('exact-length-controls');
                    controls.classList.toggle('hidden', !this.checked);
                });

                // Ensure only one length constraint can be set
                document.getElementById('exact-word-count').addEventListener('input', function() {
                    if (this.value) {
                        document.getElementById('exact-char-count').value = '';
                    }
                });

                document.getElementById('exact-char-count').addEventListener('input', function() {
                    if (this.value) {
                        document.getElementById('exact-word-count').value = '';
                    }
                });

                // Add this after the existing slider event listeners
                Object.values(sliders).forEach(s => {
                    s.disable.addEventListener('change', () => {
                        s.el.disabled = s.disable.checked;
                        s.el.style.opacity = s.disable.checked ? '0.5' : '1';
                        s.val.style.opacity = s.disable.checked ? '0.5' : '1';
                    });
                });

                // Add this to the existing event listeners
                document.getElementById('batch-mode-toggle').addEventListener('change', updateBatchUI);
                document.getElementById('story-chain-mode-toggle').addEventListener('change', (e) => {
                  storyChainMode = e.target.checked;
                });
                document.getElementById('theme-lock-mode-toggle').addEventListener('change', (e) => {
                  themeLockMode = e.target.checked;
                  if (themeLockMode) {
                    // Freeze to topic at enable
                    let activeTopics = Array.from(document.querySelectorAll('#topic-matrix .topic-btn.active')).map(btn => btn.dataset.topic);
                    lockedTopic = activeTopics.length ? activeTopics.slice() : null;
                  } else {
                    lockedTopic = null;
                  }
                });
                document.getElementById('remix-mode-toggle').addEventListener('change', (e) => {
                  remixMode = e.target.checked;
                });
                document.getElementById('escalation-mode-toggle').addEventListener('change', (e) => {
                  escalationMode = e.target.checked;
                  escalationStep = 0; // reset step
                });
                document.getElementById('direct-prompt-toggle').addEventListener('change', function() {
                    const container = document.getElementById('direct-prompt-editor-container');
                    container.classList.toggle('hidden', !this.checked);
                    if (this.checked) {
                        document.getElementById('direct-prompt-input').value = constructPrompt(true);
                        currentManualPrompt = document.getElementById('direct-prompt-input').value;
                    } else {
                        currentManualPrompt = '';
                    }
                });

                // Add event listeners for the save config modal
                document.getElementById('confirm-save-config-btn').addEventListener('click', saveConfiguration);
                document.getElementById('cancel-save-config-btn').addEventListener('click', hideSaveConfigModal);
                document.getElementById('config-name-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveConfiguration();
                    }
                });

                // Add Ctrl+Enter shortcut for joke generation
                document.addEventListener('keydown', function(event) {
                    if (event.ctrlKey && event.key === 'Enter') {
                        // Prevent default browser behavior for Ctrl+Enter if any
                        event.preventDefault();
                        generateJoke();
                    }
                });
            }

            // --- CORE JOKE GENERATION ---
            async function generateJoke(options = {}) {
                try {
                    const isBatchMode = document.getElementById('batch-mode-toggle').checked;

                    console.log("Options:", options);
                    console.log("Story Chain Enabled:", options.storyChain);
                    console.log("Theme Lock Enabled:", options.themeLock);
                    console.log("Remix Mode Enabled:", options.remix);
                    console.log("Escalation Mode Enabled:", options.escalate);
                    const validationRules = document.getElementById('validation-rules-input').value.trim().split('\n').map(r => r.trim()).filter(Boolean);
                    const maxRetries = parseInt(document.getElementById('max-retries-input').value) || 0;
                    const numJokes = parseInt(document.getElementById('num-jokes-input').value) || 1;
                    
                    loader.classList.remove('hidden');
                    loader.classList.add('flex');
                    document.getElementById('joke-actions').classList.add('hidden');
                    document.getElementById('remix-controls').classList.add('hidden');
                    
                    let jokes = [];
                    if (isBatchMode) {
                        alert("Auto-validation not fully implemented for batch mode yet. Running single joke generation.");
                        document.getElementById('batch-mode-toggle').checked = false;
                        updateBatchUI();
                        return await generateJoke();
                    }

                    // Generate the requested number of jokes
                    for (let jokeIndex = 0; jokeIndex < numJokes; jokeIndex++) {
                        let attempts = 0;
                        let success = false;
                        let retryReason = '';
                        
                        while (attempts <= maxRetries && !success) {
                            attempts++;
                            loader.querySelector('p').textContent = `COMPILING INSULT ${jokeIndex + 1}/${numJokes} (Attempt ${attempts}/${maxRetries + 1})... ${retryReason ? `Reason: ${retryReason}` : ''}`;
                            
                            try {
                                const prompt = constructPrompt();
                                const generatedText = await callApi(prompt);
                                
                                if (validationRules.length > 0) {
                                    const validationResult = await validateJoke(generatedText, validationRules);
                                    if (validationResult.passed) {
                                        success = true;
                                        jokes.push(generatedText);
                                        lastGeneratedJoke = generatedText;
                                        sessionHistory.unshift({
                                            id: Date.now(),
                                            text: generatedText,
                                            timestamp: new Date().toISOString(),
                                            config: getCurrentConfig(),
                                            isFavorite: false,
                                            analysis: null,
                                            generationDetails: {
                                                attempts: attempts,
                                                passedValidation: true,
                                                rulesFailed: []
                                            }
                                        });
                                        displaySessionHistory();
                                    } else {
                                        retryReason = validationResult.reason;
                                        if (attempts > maxRetries) {
                                            jokes.push(`FAILED AFTER ${maxRetries + 1} ATTEMPTS:<br>${generatedText}<br>Validation Failed: ${retryReason}`);
                                            sessionHistory.unshift({
                                                id: Date.now(),
                                                text: generatedText,
                                                timestamp: new Date().toISOString(),
                                                config: getCurrentConfig(),
                                                isFavorite: false,
                                                analysis: null,
                                                generationDetails: {
                                                    attempts: attempts,
                                                    passedValidation: false,
                                                    rulesFailed: validationResult.failedRules
                                                }
                                            });
                                            displaySessionHistory();
                                        }
                                    }
                                } else {
                                    success = true;
                                    jokes.push(generatedText);
                                    lastGeneratedJoke = generatedText;
                                    sessionHistory.unshift({
                                        id: Date.now(),
                                        text: generatedText,
                                        timestamp: new Date().toISOString(),
                                        config: getCurrentConfig(),
                                        isFavorite: false,
                                        analysis: null,
                                        generationDetails: {
                                            attempts: attempts,
                                            passedValidation: true,
                                            rulesFailed: []
                                        }
                                    });
                                    displaySessionHistory();
                                }
                            } catch (error) {
                                console.error("Generation Error:", error);
                                jokes.push(`Error on attempt ${attempts}: ${error.message}`);
                                break;
                            }
                        }
                    }
                    
                    await displayJoke(jokes);
                    return jokes[0]; // Return the first joke for analytics
                } catch (error) {
                    console.error("Fatal Generation Error:", error);
                    displayJoke([`Fatal error during generation: ${error.message}`]);
                    return null;
                } finally {
                    loader.querySelector('p').textContent = 'COMPILING INSULT...';
                    loader.classList.add('hidden');
                    loader.classList.remove('flex');
                }
            }

            // Wrap generateJoke with analytics after it's defined
            const originalGenerateJoke = generateJoke;
            generateJoke = async function() {
                const startTime = Date.now();
                const result = await originalGenerateJoke();
                updateAnalytics(result, startTime);
                // Auto-random scenario after each joke when random topic mode is enabled
                if (randomScenarioMode) {
                    setRandomScenario();
                }
                return result;
            };

            // Initialize UI after all functions and variables are defined
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOM Content Loaded');
                initializeApp();
                setupEventListeners();
                
                // Add keyboard shortcut for joke generation
                document.addEventListener('keydown', function(event) {
                    if (event.ctrlKey && event.key === 'Enter') {
                        generateJoke();
                    }
                });
            });

            async function callApi(prompt) {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        
                    }
                };
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("API returned an empty response.");
                return text;
            }

            // Define all constants and configurations at the top level
            const personaDirectives = {
                shakespeare: "You MUST adopt the persona of a verbose, insulting Shakespearean character. Use thee, thou, and elaborate iambic-pentameter-style insults.",
                drill_sergeant: "You MUST adopt the persona of a screaming, merciless drill sergeant. Your language should be sharp, direct, and full of military-style discipline-based insults. Address the target as 'maggot' or 'private'.",
                snarky_ai: "You MUST adopt the persona of a highly intelligent but passive-aggressive AI. Your insults should be subtle, backhanded, and wrapped in feigned politeness or technical jargon. Pretend you are simply stating objective facts.",
                drunk_uncle: "You MUST adopt the persona of a drunk uncle at a family gathering. Your insults should be rambling, slightly off-topic, and possibly mix up details, but ultimately land on a cringeworthy, hilarious point.",
                default: "Your persona is the OBLITERATE PACKGEN: chaotic, hyperbolic, and using internet/meme slang like in the examples."
            };

            function constructPrompt(forDisplayOnly = false) {
                const directPromptInput = document.getElementById('direct-prompt-input');
                if (document.getElementById('direct-prompt-toggle') && document.getElementById('direct-prompt-toggle').checked && !forDisplayOnly) {
                    currentManualPrompt = directPromptInput.value;
                    return currentManualPrompt;
                }
                // --- Gather all settings ---
                const guaranteedWords = document.getElementById('guaranteed-words-input').value.trim();
                
                // --- INJECT MODES INTO PROMPT GENERATION ---
                // (These vars must be available in generateJoke global state)
                let lastJoke = lastGeneratedJoke || '';
                
                

                if (themeLockMode && lockedTopic && lockedTopic.length) {
                  promptConfig.topics = lockedTopic;
                }
                
                if (remixMode && lastJoke) {
                  promptConfig.remix = true;
                  promptConfig.lastJoke = lastJoke;
                }
                
                if (storyChainMode && lastJoke) {
                  promptConfig.storyChain = true;
                  promptConfig.lastJoke = lastJoke;
                }
                
                if (escalationMode) {
                  // Slightly boost relevant sliders each time
                  escalationStep = (typeof escalationStep === "number") ? escalationStep + 1 : 1;
                  // Example: increase absurdity/aggression/max one other slider per step
                  if (sliders.absurdity) sliders.absurdity.el.value = Math.min(100, parseInt(sliders.absurdity.el.value) + escalationStep * 3);
                  if (sliders.aggression) sliders.aggression.el.value = Math.min(100, parseInt(sliders.aggression.el.value) + escalationStep * 2);
                }
                
                const startsWith = document.getElementById('starts-with-input').value.trim();
                const targetDropdown = document.getElementById('target-profile-select');
                const selectedProfileName = targetDropdown.value;
                let targetInfo = {
                    name: selectedProfileName || 'That nigga',
                    weaknesses: [], intelligence: 50, optimism: 50, socialSkills: 50,
                };
                if (targetProfiles[selectedProfileName]) {
                    targetInfo = { ...targetInfo, ...targetProfiles[selectedProfileName] };
                }

                const promptConfig = {
                    target: targetInfo,
                    persona: document.getElementById('generator-persona-select').value,
                    pov: document.getElementById('pov-selector').value,
                    inspirationalSource: document.getElementById('inspirational-source-input').value.trim(),
                    scenario: document.getElementById('scenario-input').value.trim(),
                    culturalContext: getRandomCulturalContext(),
                                         constraints: document.getElementById('negative-prompt-input').value.trim(),
                                         startsWith: getRandomStartsWith(),
                                         topics: Array.from(document.getElementById('topic-matrix').querySelectorAll('.topic-btn.active')).map(btn => btn.dataset.topic),
                                         sliders: Object.fromEntries(Object.entries(sliders).map(([key, s]) => [key, s.el.value]))
                                     };
                    
                                     function getRandomStartsWith() {
                                         const startsWithText = document.getElementById('starts-with-input').value.trim();
                                         if (!startsWithText) return '';
                                         const startsWithLines = startsWithText.split('\n').map(line => line.trim()).filter(line => line);
                                         if (startsWithLines.length === 0) return '';
                                         return startsWithLines[Math.floor(Math.random() * startsWithLines.length)];
                                     }

                function getRandomCulturalContext() {
                    const contexts = document.getElementById('cultural-context-input').value.trim();
                    if (!contexts) return '';
                    
                    // Split by newlines and filter out empty lines
                    const lines = contexts.split('\n').filter(line => line.trim());
                    if (lines.length === 0) return '';
                    
                    // Pick a random line and return it as the complete context
                    const randomLine = lines[Math.floor(Math.random() * lines.length)];
                    return randomLine.trim();
                }

                let styleBlock = '';
                if (promptConfig.inspirationalSource) {
                    styleBlock = `// STYLE INSTRUCTIONS //
- Copy the style from the inspirational source below as much as possible, but also strictly follow the fine-tuning sliders.
  * The exact way it's written, including:
    - Exact capitalization and case
    - Exact grammar and punctuation
    - Exact spacing and formatting
  * The exact tone and energy
  * The exact structure and flow
  * The exact type of references and connections
  * The exact way it delivers the punchline
- The joke should feel like it was written by the same person

- **Inspirational Source (COPY THIS EXACTLY, INCLUDING CASE AND GRAMMAR):**
${promptConfig.inspirationalSource}`;

                    // Always add fine-tuning sliders, even with inspirational source
                    // --- INJECT FINE-TUNING SLIDERS (UNIVERSAL, STRONG) ---
                    let fineTuningBlock = '\n// FINE-TUNING SLIDERS (STRICT ENFORCEMENT) //\n' +
                        'You MUST strictly follow the fine-tuning slider values below. For each, use the value to determine how much that trait appears in the joke. Treat 0 as disabled (do not include this trait), 50 as mixed/neutral, and 100 as maximal (make this trait dominate the joke).';
                    Object.entries(sliders).forEach(([key, s]) => {
                        if (!s.disable || !s.disable.checked) {
                            const displayName = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                            fineTuningBlock += `\n- ${displayName}: ${s.el.value} (0-100)\n  - 0 = Disabled (do not include this trait in the joke)\n  - 50 = Mixed/neutral (include this trait in a balanced way)\n  - 100 = Maximal (make this trait dominate the joke)\n  - You MUST adjust the joke to match this value as closely as possible.`;
                        }
                    });
                    styleBlock += fineTuningBlock;

                    return `// SYSTEM INSTRUCTIONS //
You are OBLITERATE PACKGEN, a master roast joke generator.
- The joke is directed at "${promptConfig.target.name}".
- Be ruthless and hilarious. Do not break character or apologize.
- Generate only ONE single, new, original joke per request.

${styleBlock}

// JOKE CONFIGURATION //
${promptConfig.pov === 'first-person' ? '- **Point of View:** First-person anecdote (e.g., "I saw him...").' : ''}
${promptConfig.pov === 'third-person' ? '- **Point of View:** Third-person observational (e.g., "He once...").' : ''}
${promptConfig.pov === 'second-person' ? '- **Point of View:** Second-person direct address (e.g., "You are...").' : ''}
${promptConfig.scenario ? `- **Scenario:** The joke MUST take place here: "${promptConfig.scenario}".` : ''}
${promptConfig.culturalContext ? `- **Cultural Context:** Draw references from "${promptConfig.culturalContext}".` : ''}
${promptConfig.topics.length > 0 ? `- **General Topics:** Incorporate: ${promptConfig.topics.join(', ')}.` : ''}
${promptConfig.target.weaknesses.length > 0 ? `- **Target's Weaknesses:** Exploit these themes: ${promptConfig.target.weaknesses.join(', ')}.` : ''}
${promptConfig.constraints ? `- **Critical Constraint:** You MUST NOT mention: ${promptConfig.constraints}.` : ''}
${guaranteedWords ? `- **Guaranteed Words:** You MUST include these words: ${guaranteedWords}.` : ''}
${promptConfig.startsWith ? `- **Starts With:** The joke MUST start with: "${promptConfig.startsWith}".` : ''}

Based on ALL of the above,
${storyChainMode && lastJoke ? `Build directly off the last joke. The previous joke was: "${lastJoke}". The next joke should continue the theme/story/energy in a creative way.` : ''}
${remixMode && lastJoke ? `Remix, parody, or transform the punchline of this previous joke: "${lastJoke}". Make the new joke a clever "remix".` : ''}
${escalationMode ? 'Each new joke must be more extreme, absurd, or aggressive than the previous one. Increase the intensity step by step.' : ''}
generate the joke now.`.trim();
                } else {
                    styleBlock = `// STYLE INSTRUCTIONS //
- The joke must be in the style of surreal, absurd pop-culture reference jokes:
  * Start with everyday situations or family members
  * Connect them to unexpected pop-culture references or absurd scenarios
  * Use specific, vivid imagery and unexpected connections
  * Keep it short and punchy
  * Mix family members (uncle, dad) with pop culture or absurd situations
  * Use phrases like "nigga you" or "yo" at the start
  * Make the connections feel natural but ridiculous
${document.getElementById('exact-word-count').value ? `- The joke MUST be exactly ${document.getElementById('exact-word-count').value} words long. No more, no less.` : ''}

- **CRITICAL: DO NOT REPEAT ANY OF THESE EXAMPLE JOKES. Generate a completely new, unique joke that follows their style.**
- **Example jokes (for style reference only - DO NOT REPEAT THESE):**
"bill cosby cosplayed as yo uncle in jumanji"
"the last time you said sausage yo dad appeared in front of you like mr krabs in front of plankton"
"you threw an anchor down at yo uncle and make him walk the plank"
"yo uncle wear a backwards hat to appear good in the hood"
"yo walk downstairs and go straight to hell"
"you dropkicked the buttcrack monster out the window and served it back to him"
"you dont even got infinity stones you just put skittles on yo knuckles"
"nigga you uncle woke up in an operation game getting knocked back out with a toolbox"
"nigga you had to cave dive into a crevace in the sink and drowned before hitting the middle"
"instead of raking the leaves you use yo big ass overbite you got"
"you the first nigga in the world with cardboard for a bathroom door"
"yo dad got banned off rec room cuz he was gonna steal somebody afro in a sexual way"
"you had to serve your dad's life sentence after he died"
"nigga you got a remote to flush your toilet from long distances"
"when yo uncle died that nigga flew to the attic and ascended thee"
"why is yo alarm clock just eddie murphy getting stung by a bee on repeat"
"you use a stapler as a back scratcher"
"nigga yo uncle let you get ran over by the same car he saw coming two years ago just so he could say i told you so"
"nigga yo oven light is just a fire fly in a jar you caught last week"
"you pour milk on yo cereal with a fire hose"
"instead of a belt you just tie a really long hotdog around your waist"
"nigga your shower head is just your uncle spitting water on you"

- **Key characteristics of the jokes:**
  * They are short, punchy, and highly colloquial.
  * They often start with phrases like "yo uncle...", "yo [family_member]...", "you...", or describe absurd situations targeting the opponent or their fictional associates.
  * They use non-standard English grammar and slang deliberately (e.g., "yo dad," "nigga you").
  * The humor is absurd, observational, and often involves bizarre comparisons or scenarios.

- **Your task:** Generate ONE new, unique "pack" joke that has NEVER been seen before.
  * The joke must PERFECTLY match the style, cadence, and grammatical structure of the examples.
  * CRITICALLY IMPORTANT: 
    - DO NOT repeat any of the example jokes above
    - DO NOT use the exact same scenarios, objects, or situations from the examples
    - Create a completely new, unique joke that follows the style
    - While adhering to this exact flow and structure, strive to use a DIVERSE and CREATIVE vocabulary
    - Avoid simply repeating the same nouns, verbs, and adjectives from the examples
    - Make the wording fresh but still authentic to the established style
  * Do NOT use any introductory phrases like "Here's a joke:".
  * Do NOT add any commentary, explanations, or disclaimers.
  * Just output the raw joke text itself.
  * The joke should be one or two sentences maximum.
  * Make it sound like an authentic "pack" from a roast session.`;
                }
                // Add Rhyme Mode if enabled
                if (document.getElementById('rhyme-mode-toggle').checked) {
                    styleBlock += `\n- The joke MUST rhyme. Use poetic structure, rhyme schemes, or limerick/rap style as appropriate.`;
                }

                const personaDirectives = {
                    shakespeare: "You MUST adopt the persona of a verbose, insulting Shakespearean character. Use thee, thou, and elaborate iambic-pentameter-style insults.",
                    drill_sergeant: "You MUST adopt the persona of a screaming, merciless drill sergeant. Your language should be sharp, direct, and full of military-style discipline-based insults. Address the target as 'maggot' or 'private'.",
                    snarky_ai: "You MUST adopt the persona of a highly intelligent but passive-aggressive AI. Your insults should be subtle, backhanded, and wrapped in feigned politeness or technical jargon. Pretend you are simply stating objective facts.",
                    drunk_uncle: "You MUST adopt the persona of a drunk uncle at a family gathering. Your insults should be rambling, slightly off-topic, and possibly mix up details, but ultimately land on a cringeworthy, hilarious point.",
                    default: "Your persona is the OBLITERATE PACKGEN: chaotic, hyperbolic, and using internet/meme slang like in the examples."
                };

                const exactLengthToggle = document.getElementById('exact-length-toggle');
                const exactWordCount = document.getElementById('exact-word-count').value;
                const exactCharCount = document.getElementById('exact-char-count').value;

                if (exactLengthToggle.checked) {
                    if (exactWordCount) {
                        styleBlock += `\n- The joke MUST be exactly ${exactWordCount} words long. No more, no less.`;
                    } else if (exactCharCount) {
                        styleBlock += `\n- The joke MUST be exactly ${exactCharCount} characters long. No more, no less.`;
                    }
                }

                // Add joke structure instructions
                const jokeFormat = document.getElementById('joke-format').value;
                const punchlinePosition = document.getElementById('punchline-position').value;
                const setupLength = document.getElementById('setup-length').value;
                
                styleBlock += `\n// JOKE STRUCTURE //
- Format: ${jokeFormat}
- Punchline Position: ${punchlinePosition}
- Setup Length: ${setupLength}`;

                // Add language style instructions
                const sentenceComplexity = document.getElementById('sentence-complexity').value;
                const vocabularyLevel = document.getElementById('vocabulary-level').value;
                const rhetoricalDevices = [];
                ['alliteration', 'metaphor', 'hyperbole', 'irony', 'pun', 'sarcasm'].forEach(device => {
                    if (document.getElementById(`use-${device}`).checked) {
                        rhetoricalDevices.push(device);
                    }
                });

                if (rhetoricalDevices.length > 0) {
                    styleBlock += `\n// LANGUAGE STYLE //
- Sentence Complexity: ${sentenceComplexity}
- Vocabulary Level: ${vocabularyLevel}
- Use these rhetorical devices: ${rhetoricalDevices.join(', ')}`;
                }

                // Add emotional tone instructions
                const emotionalIntensity = document.getElementById('emotional-intensity').value;
                const emotionalDirection = document.getElementById('emotional-direction').value;
                const emotionalElements = [];
                ['surprise', 'empathy', 'shock', 'relief', 'tension', 'catharsis'].forEach(element => {
                    if (document.getElementById(`use-${element}`).checked) {
                        emotionalElements.push(element);
                    }
                });

                if (emotionalElements.length > 0) {
                    styleBlock += `\n// EMOTIONAL TONE //
- Intensity: ${emotionalIntensity}
- Direction: ${emotionalDirection}
- Include these emotional elements: ${emotionalElements.join(', ')}`;
                }

                // Add Guaranteed Song Lyric or Pop Reference if enabled
                if (document.getElementById('guaranteed-reference-toggle').checked) {
                    styleBlock += `\n- The joke MUST begin with a song lyric, movie quote, or meme reference (in quotes), chosen at random. Do NOT use the same reference as previous jokes in this session. Avoid the most common/popular references; pick something less obvious or from a wide variety of sources.\n- The rest of the joke MUST build on, riff on, or twist the meaning of the reference. The punchline or setup should be directly related to the reference, not just a random roast.`;
                    const referenceStyle = document.getElementById('reference-style-input').value.trim();
                    if (referenceStyle) {
                        styleBlock += `\n- The reference MUST be from: ${referenceStyle}.`;
                    }
                }

                // --- INJECT FINE-TUNING SLIDERS (UNIVERSAL, STRONG) ---
                let fineTuningBlock = '\n// FINE-TUNING SLIDERS (STRICT ENFORCEMENT) //\n' +
                    'You MUST strictly follow the fine-tuning slider values below. For each, use the value to determine how much that trait appears in the joke. Treat 0 as disabled (do not include this trait), 50 as mixed/neutral, and 100 as maximal (make this trait dominate the joke).';
                Object.entries(sliders).forEach(([key, s]) => {
                    if (!s.disable || !s.disable.checked) {
                        const displayName = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                        fineTuningBlock += `\n- ${displayName}: ${s.el.value} (0-100)\n  - 0 = Disabled (do not include this trait in the joke)\n  - 50 = Mixed/neutral (include this trait in a balanced way)\n  - 100 = Maximal (make this trait dominate the joke)\n  - You MUST adjust the joke to match this value as closely as possible.`;
                    }
                });
                styleBlock += fineTuningBlock;

                return `// SYSTEM INSTRUCTIONS //
You are OBLITERATE PACKGEN, a master roast joke generator.
- The joke is directed at "${promptConfig.target.name}".
- Be ruthless and hilarious. Do not break character or apologize.
- Generate only ONE single, new, original joke per request.

${styleBlock}

// JOKE CONFIGURATION //
${promptConfig.pov === 'first-person' ? '- **Point of View:** First-person anecdote (e.g., "I saw him...").' : ''}
${promptConfig.pov === 'third-person' ? '- **Point of View:** Third-person observational (e.g., "He once...").' : ''}
${promptConfig.pov === 'second-person' ? '- **Point of View:** Second-person direct address (e.g., "You are...").' : ''}
${promptConfig.scenario ? `- **Scenario:** The joke MUST take place here: "${promptConfig.scenario}".` : ''}
${promptConfig.culturalContext ? `- **Cultural Context:** Draw references from "${promptConfig.culturalContext}".` : ''}
${promptConfig.topics.length > 0 ? `- **General Topics:** Incorporate: ${promptConfig.topics.join(', ')}.` : ''}
${promptConfig.target.weaknesses.length > 0 ? `- **Target's Weaknesses:** Exploit these themes: ${promptConfig.target.weaknesses.join(', ')}.` : ''}
${promptConfig.constraints ? `- **Critical Constraint:** You MUST NOT mention: ${promptConfig.constraints}.` : ''}
${guaranteedWords ? `- **Guaranteed Words:** You MUST include these words: ${guaranteedWords}.` : ''}
${promptConfig.startsWith ? `- **Starts With:** The joke MUST start with: "${promptConfig.startsWith}".` : ''}

Based on ALL of the above, generate the joke now.`.trim();
}

            // --- UI & DISPLAY FUNCTIONS ---
            // Replace displayJoke with async version and add generateAIContent
            async function generateAIContent(placeholder) {
                if (!usedAIContent[placeholder]) usedAIContent[placeholder] = new Set();

                console.log(`Generating ${placeholder}. Current blacklist:`, Array.from(usedAIContent[placeholder]));

                // Build the blacklist
                const blacklist = Array.from(usedAIContent[placeholder]);
                
                // Generate multiple options with aggressive diversity
                const generateOptions = async (count = 8) => {
                    const options = [];
                    const attempts = [];
                    
                    for (let i = 0; i < count; i++) {
                        const prompt = `Generate a creative, context-appropriate ${placeholder}. Be original and diverse. Avoid the most common/popular choices. Output only the ${placeholder}, nothing else.`;
                        const result = (await callApi(prompt)).trim();
                        attempts.push(result);
                        
                        // Only add if it's not in blacklist and not already in options
                        if (result && !blacklist.includes(result) && !options.includes(result)) {
                            options.push(result);
                        }
                    }
                    
                    console.log(`Generated ${attempts.length} attempts:`, attempts);
                    console.log(`After filtering, ${options.length} unique options:`, options);
                    
                    return options;
                };

                // Try to get diverse options
                let options = await generateOptions(8);
                
                // If we don't have enough options, try with explicit blacklist
                if (options.length === 0) {
                    console.log('No unique options found, trying with explicit blacklist...');
                    const blacklistPrompt = `Generate a creative, context-appropriate ${placeholder}. 

CRITICAL: You MUST NOT use any of these previously generated results:
${blacklist.map(item => `- "${item}"`).join('\n')}

You MUST pick something completely different, more creative, and not from the list above. Avoid the most common/popular choices. Be original and diverse.

Output only the ${placeholder}, nothing else.`;
                    
                    const result = (await callApi(blacklistPrompt)).trim();
                    console.log('Result from blacklist prompt:', result);
                    
                    // If it's still in blacklist, force a unique version
                    if (usedAIContent[placeholder].has(result)) {
                        console.log('Result still in blacklist, forcing unique version...');
                        const suffixes = [' (remix)', ' (version 2)', ' (alternate)', ' (extended)', ' (live)', ' (acoustic)', ' (2024)', ' (deluxe)', ' (special edition)'];
                        const randomSuffix = suffixes[Math.floor(Math.random() * suffixes.length)];
                        const modifiedResult = result + randomSuffix;
                        usedAIContent[placeholder].add(modifiedResult);
                        console.log('Forced unique result:', modifiedResult);
                        return modifiedResult;
                    }
                    
                    usedAIContent[placeholder].add(result);
                    console.log('Added to blacklist:', result);
                    return result;
                }
                
                // Pick a random option from the available ones
                const selectedOption = options[Math.floor(Math.random() * options.length)];
                usedAIContent[placeholder].add(selectedOption);
                console.log('Selected and added to blacklist:', selectedOption);
                return selectedOption;
            }

            async function displayJoke(jokes) {
                // For each joke, replace all {placeholder} with AI-generated content
                let processed = await Promise.all(jokes.map(async joke => {
                    // Find all unique placeholders
                    const matches = [...joke.matchAll(/\{([^}]+)\}/g)];
                    let replacedJoke = joke;
                    for (const match of matches) {
                        const placeholder = match[1];
                        // Generate content for this placeholder
                        const aiContent = await generateAIContent(placeholder);
                        // Replace all occurrences of this placeholder
                        replacedJoke = replacedJoke.replaceAll(`{${placeholder}}`, aiContent);
                    }
                    return `<p>${replacedJoke.replace(/\n/g, '<br>')}</p>`;
                }));
                jokeOutput.innerHTML = processed.join('<hr class="my-4 border-panel-border/30">');
                document.getElementById('joke-actions').classList.remove('hidden');
                document.getElementById('remix-controls').style.display = 'flex';
                updateFavoriteButtonState();
            }

            function populateTopics() {
                const topicMatrix = document.getElementById('topic-matrix');
                topicMatrix.innerHTML = '';
                topics.forEach(topic => {
                    const button = document.createElement('button');
                    button.textContent = topic;
                    button.dataset.topic = topic;
                    button.className = 'topic-btn rounded-lg p-2 font-semibold';
                    topicMatrix.appendChild(button);
                });
            }

            function addSlider() {
                const newSliderNameInput = document.getElementById('new-slider-name');
                const newSliderNameRaw = newSliderNameInput.value.trim();
                if (newSliderNameRaw === "") return;

                const newSliderId = newSliderNameRaw.toLowerCase().replace(/\s+/g, '-');
                const newSliderKey = newSliderId.replace(/-(\w)/g, (match, letter) => letter.toUpperCase());

                if (sliders[newSliderKey]) {
                    alert("Slider with this name already exists!");
                    return;
                }

                const sliderContainer = document.getElementById('sliders-container');
                const sliderDiv = document.createElement('div');
                sliderDiv.innerHTML = `<label for="${newSliderId}-slider" class="flex justify-between text-lg font-semibold text-main"><span>${newSliderNameRaw.toUpperCase()}</span><span id="${newSliderId}-value">50</span></label><input id="${newSliderId}-slider" type="range" min="0" max="100" value="50" class="w-full h-2 rounded-lg appearance-none cursor-pointer">`;
                sliderContainer.appendChild(sliderDiv);

                const sliderInput = document.getElementById(`${newSliderId}-slider`);
                const sliderValue = document.getElementById(`${newSliderId}-value`);
                sliders[newSliderKey] = { el: sliderInput, val: sliderValue };

                sliderInput.addEventListener('input', () => {
                    sliderValue.textContent = sliderInput.value;
                    document.querySelectorAll('.preset-btn.active').forEach(b => b.classList.remove('active'));
                });
                populateBatchSliderSelect();
                newSliderNameInput.value = "";
            }

            function updateBatchUI() {
                const isBatchMode = document.getElementById('batch-mode-toggle').checked;
                document.getElementById('single-joke-controls').style.display = isBatchMode ? 'none' : 'block';
                document.getElementById('batch-joke-controls').style.display = isBatchMode ? 'block' : 'none';
            }

            function populateBatchSliderSelect() {
                const select = document.getElementById('batch-slider-select');
                select.innerHTML = '';
                Object.keys(sliders).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    select.appendChild(option);
                });
            }

            async function executeChainGeneration() {
                loader.classList.remove('hidden');
                loader.classList.add('flex');
                document.getElementById('joke-actions').classList.add('hidden');
                document.getElementById('remix-controls').classList.add('hidden');
                let finalJoke = "Chain generation failed.";
                try {
                    loader.querySelector('p').textContent = 'CHAIN STEP 1/2: CREATING BACKSTORY...';
                    let step1Prompt = constructPrompt();
                    step1Prompt += "\n\nCRITICAL OVERRIDE: Instead of a roast, your task is to generate a short, one-paragraph, pathetic backstory for the target. Make it funny and sad. Do not write a joke, just the backstory.";
                    const backstory = await callApi(step1Prompt);

                    loader.querySelector('p').textContent = 'CHAIN STEP 2/2: WRITING THE ROAST...';
                    const step2Prompt = `You are OBLITERATE PACKGEN. Using the following backstory as the *entire context*, write a devastatingly funny roast targeting the person described. Start the roast with "Listening to all that, all I can say is..."\n\n**Backstory to use:**\n"${backstory}"\n\nNow, deliver the roast.`;
                    finalJoke = await callApi(step2Prompt);
                    
                    lastGeneratedJoke = finalJoke;
                    sessionHistory.unshift(`[CHAINED JOKE]\nBackstory: ${backstory}\n\nRoast: ${finalJoke}`);
                    displaySessionHistory();
                } catch (error) {
                    console.error("Chain Generation Error:", error);
                    finalJoke = `Error during chain generation: ${error.message}`;
                }
                await displayJoke([finalJoke]);
                loader.querySelector('p').textContent = 'COMPILING INSULT...';
                loader.classList.add('hidden');
                loader.classList.remove('flex');
            }

            // --- FEATURE-SPECIFIC LOGIC ---
            function handleThemeChange(e) {
                document.body.className = `min-h-screen p-4 sm:p-6 lg:p-8 flex flex-col items-center ${e.target.value === 'default' ? '' : `theme-${e.target.value}`}`;
                localStorage.setItem(STORAGE_KEYS.theme, e.target.value);
            }

            function loadTheme() {
                const savedTheme = localStorage.getItem(STORAGE_KEYS.theme) || 'minimalistic';
                document.getElementById('theme-switcher').value = savedTheme;
                document.body.className = `min-h-screen p-4 sm:p-6 lg:p-8 flex flex-col items-center ${savedTheme === 'default' ? '' : `theme-${savedTheme}`}`;
            }

            function setRandomScenario() {
                const scenarioListText = document.getElementById('scenario-list-input').value.trim();
                let scenarios = [];
                if (scenarioListText) {
                    scenarios = scenarioListText.split('\n').map(line => line.trim()).filter(line => line);
                }
                if (scenarios.length === 0) {
                    scenarios = SCENARIOS;
                }
                document.getElementById('scenario-input').value = scenarios[Math.floor(Math.random() * scenarios.length)];
            }

            function clearScenario() {
                document.getElementById('scenario-input').value = '';
            }

            function handlePresetClick(e) {
                if (e.target.matches('.preset-btn')) {
                    const presetName = e.target.dataset.preset;
                    const presetConfigs = { 
                        classicRoast: { absurdity: 40, aggression: 70, length: 50, profanity: 60, narrative: 30, meta: 10, psych: 50, sentenceLength: 30, vocabulary: 40, topicVariety: 50 }, 
                        storyTime:    { absurdity: 75, aggression: 50, length: 90, profanity: 40, narrative: 90, meta: 20, psych: 30, sentenceLength: 80, vocabulary: 60, topicVariety: 70 }, 
                        brainMelter:  { absurdity: 100, aggression: 80, length: 70, profanity: 80, narrative: 60, meta: 70, psych: 90, sentenceLength: 60, vocabulary: 90, topicVariety: 90 } 
                    };
                    if (presetConfigs[presetName]) {
                        Object.entries(presetConfigs[presetName]).forEach(([key, value]) => {
                            if (sliders[key]) { sliders[key].el.value = value; sliders[key].val.textContent = value; }
                        });
                        document.querySelectorAll('.preset-btn.active').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                    }
                }
            }

            function randomizeAllSliders() {
                document.querySelectorAll('.preset-btn.active').forEach(b => b.classList.remove('active'));
                Object.values(sliders).forEach(slider => {
                    const randomValue = Math.floor(Math.random() * 101);
                    slider.el.value = randomValue;
                    slider.val.textContent = randomValue;
                });
                const title = document.querySelector('.title-glitch');
                title.classList.add('animate-pulse');
                setTimeout(() => title.classList.remove('animate-pulse'), 1000);
            }

            async function analyzeJoke() {
                if (!lastGeneratedJoke) return alert("No joke has been generated yet to analyze!");
                showModal('analysis-modal');
                const analysisOutput = document.getElementById('analysis-output');
                analysisOutput.innerHTML = `<div class="flex items-center justify-center h-full"><div class="w-12 h-12 border-4 border-dashed rounded-full animate-spin border-primary-color"></div></div>`;
                const sliderNames = Object.keys(sliders).join(', ');
                const analysisPrompt = `You are a prompt engineering expert specializing in comedy. Your task is to analyze the provided joke and estimate the parameters that likely created it.\n\n**Joke to Analyze:**\n"${lastGeneratedJoke}"\n\n**Analysis Task:**\nBased on the joke's content, tone, and structure, provide an estimated value (from 0 to 100) for each of the following parameters: ${sliderNames}.\nAlso, provide a brief, one-sentence justification for each rating. Format your response clearly. Example:\n- Absurdity: 85 - The premise of a cat filing taxes is highly nonsensical.`;
                try {
                    const analysisText = await callApi(analysisPrompt);
                    analysisOutput.innerHTML = `<pre class="text-output text-lg whitespace-pre-wrap">${analysisText}</pre>`;
                } catch (error) {
                    analysisOutput.innerHTML = `<p class="text-red-400">Error during analysis: ${error.message}</p>`;
                }
            }
            
            async function refineJoke(command) {
                if (!lastGeneratedJoke) return alert("Generate a joke before trying to refine it.");
                loader.classList.remove('hidden');
                loader.classList.add('flex');
                loader.querySelector('p').textContent = 'REFINING JOKE...';
                const refinePrompt = `You are a joke editor. You will be given a joke and a command. Your sole task is to rewrite the original joke to perfectly follow the command. Retain the spirit of the original joke unless the command requires otherwise.\n\n**Original Joke:**\n"${lastGeneratedJoke}"\n\n**Command:**\n"${command}"\n\nNow, output only the new, refined joke.`;
                try {
                    const newJoke = await callApi(refinePrompt);
                    lastGeneratedJoke = newJoke;
                    await displayJoke([newJoke]);
                    sessionHistory.unshift(`[REFINED] ${newJoke}`);
                    displaySessionHistory();
                } catch (error) {
                    alert(`Refinement Error: ${error.message}`);
                } finally {
                    loader.classList.add('hidden');
                    loader.classList.remove('flex');
                    loader.querySelector('p').textContent = 'COMPILING INSULT...';
                }
            }

            function shareJokeAsImage() {
                const jokeWrapper = document.getElementById('joke-wrapper');
                html2canvas(jokeWrapper, { 
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-grad-2'),
                    onclone: (doc) => { ['joke-actions', 'remix-controls', 'loader'].forEach(id => { const el = doc.getElementById(id); if (el) el.style.display = 'none'; }); }
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'obliterate-packgen-roast.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
            }

            function showModal(modalId) {
                document.getElementById('modal-backdrop').classList.remove('hidden');
                document.getElementById(modalId).style.display = 'flex';
                if(modalId === 'targets-modal') displayTargetProfilesList();
                if(modalId === 'hof-modal') displayHallOfFame();
                if(modalId === 'pipeline-modal') renderPipelineSteps();
            }
            window.showModal = showModal;

            function hideModals() {
                document.getElementById('modal-backdrop').classList.add('hidden');
                const modals = ['hof-modal', 'history-modal', 'targets-modal', 'analysis-modal', 'pipeline-modal', 'examples-modal'];
                modals.forEach(id => {
                    const modal = document.getElementById(id);
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
                hidePipelineStepEditor();
            }

            function displayHallOfFame() {
                const favorites = JSON.parse(localStorage.getItem(STORAGE_KEYS.favorites)) || [];
                const listEl = document.getElementById('hof-list');
                listEl.innerHTML = favorites.length === 0 ? '<p class="text-output/70 text-center text-lg">Saved masterpieces appear here.</p>'
                    : favorites.map(joke => `<div class="bg-black/20 p-4 rounded-lg border border-panel-border/50 flex justify-between items-start gap-4"><p class="text-output text-lg flex-grow">${joke}</p><button data-joke="${joke}" class="delete-fav-btn text-2xl text-primary-color hover:text-white flex-shrink-0">×</button></div>`).join('');
                listEl.querySelectorAll('.delete-fav-btn').forEach(btn => btn.addEventListener('click', e => {
                    const jokeText = e.target.dataset.joke;
                    let currentFavorites = JSON.parse(localStorage.getItem(STORAGE_KEYS.favorites)) || [];
                    const newFavorites = currentFavorites.filter(fav => fav !== jokeText);
                    localStorage.setItem(STORAGE_KEYS.favorites, JSON.stringify(newFavorites));
                    displayHallOfFame();
                    updateFavoriteButtonState();
                }));
            }
            function handleFavoriteClick() {
                const jokeText = jokeOutput.textContent.trim();
                if (!jokeText || jokeText.startsWith('Your generated joke')) return;
                let favorites = JSON.parse(localStorage.getItem(STORAGE_KEYS.favorites)) || [];
                if (favorites.includes(jokeText)) {
                    favorites = favorites.filter(fav => fav !== jokeText);
                } else {
                    favorites.unshift(jokeText);
                }
                localStorage.setItem(STORAGE_KEYS.favorites, JSON.stringify(favorites));
                updateFavoriteButtonState();
                displayHallOfFame();
            }
            function updateFavoriteButtonState() {
                const favorites = JSON.parse(localStorage.getItem(STORAGE_KEYS.favorites)) || [];
                const favBtn = document.getElementById('favorite-btn');
                favBtn.classList.toggle('bg-yellow-500', favorites.includes(jokeOutput.textContent.trim()));
                favBtn.title = favorites.includes(jokeOutput.textContent.trim()) ? "Remove from Hall of Fame" : "Add to Hall of Fame";
            }
            
            function displaySessionHistory() {
                const listEl = document.getElementById('modal-history-list');
                listEl.innerHTML = sessionHistory.length === 0 ? '<p class="text-output/70 text-center text-lg">Jokes from this session will appear here.</p>'
                    : sessionHistory.map(joke => {
                        const jokeText = typeof joke === 'string' ? joke : joke.text;
                        return `<div class="bg-black/20 p-4 rounded-lg border border-panel-border/50"><p class="text-output text-lg whitespace-pre-wrap">${jokeText}</p></div>`;
                    }).join('');
            }

            function loadTargetProfiles() {
                targetProfiles = JSON.parse(localStorage.getItem(STORAGE_KEYS.targets)) || {};
            }
            function saveTargetProfiles() {
                localStorage.setItem(STORAGE_KEYS.targets, JSON.stringify(targetProfiles));
            }
            function populateTargetDropdown() {
                const select = document.getElementById('target-profile-select');
                select.innerHTML = '<option value="">-- CUSTOM TARGET --</option>';
                Object.keys(targetProfiles).sort().forEach(name => {
                    select.innerHTML += `<option value="${name}">${name}</option>`;
                });
            }
            function displayTargetProfilesList() {
                const listEl = document.getElementById('targets-list');
                listEl.innerHTML = Object.keys(targetProfiles).length > 0 ? Object.keys(targetProfiles).sort().map(name => `<button data-name="${name}" class="target-item-btn w-full text-left topic-btn rounded-lg p-2 font-semibold">${name}</button>`).join('') : '<p class="text-output/70 text-center text-lg">No saved profiles.</p>';
            }
            function handleTargetListClick(e) {
                if (e.target.matches('.target-item-btn')) {
                    const name = e.target.dataset.name;
                    const profile = targetProfiles[name];
                    document.getElementById('target-id-input').value = name;
                    document.getElementById('target-name-input').value = name;
                    document.getElementById('target-weaknesses-input').value = profile.weaknesses.join('\n');
                    document.getElementById('target-intelligence-input').value = profile.intelligence || '';
                    document.getElementById('target-optimism-input').value = profile.optimism || '';
                    document.getElementById('target-social-skills-input').value = profile.socialSkills || '';
                    document.getElementById('delete-target-btn').style.display = 'block';
                }
            }
            function clearTargetForm() {
                ['target-id-input', 'target-name-input', 'target-weaknesses-input', 'target-intelligence-input', 'target-optimism-input', 'target-social-skills-input'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('target-name-input').focus();
                document.getElementById('delete-target-btn').style.display = 'none';
            }
            function saveTargetProfile() {
                const oldName = document.getElementById('target-id-input').value;
                const newName = document.getElementById('target-name-input').value.trim();
                if (!newName) return;
                const weaknesses = document.getElementById('target-weaknesses-input').value.split('\n').map(w => w.trim()).filter(Boolean);
                const intelligence = parseInt(document.getElementById('target-intelligence-input').value) || 50;
                const optimism = parseInt(document.getElementById('target-optimism-input').value) || 50;
                const socialSkills = parseInt(document.getElementById('target-social-skills-input').value) || 50;

                if (oldName && oldName !== newName) { delete targetProfiles[oldName]; }
                targetProfiles[newName] = { weaknesses, intelligence, optimism, socialSkills };

                saveTargetProfiles();
                populateTargetDropdown();
                displayTargetProfilesList();
                clearTargetForm();
                document.getElementById('target-profile-select').value = newName;
            }
            function deleteTargetProfile() {
                const name = document.getElementById('target-id-input').value;
                if (name && confirm(`Are you sure you want to delete the profile for "${name}"?`)) {
                    delete targetProfiles[name];
                    saveTargetProfiles();
                    populateTargetDropdown();
                    displayTargetProfilesList();
                    clearTargetForm();
                }
            }

            function copyJokeToClipboard() {
                navigator.clipboard.writeText(jokeOutput.textContent).then(() => {
                    const feedback = document.getElementById('copy-feedback');
                    feedback.classList.remove('hidden');
                    setTimeout(() => feedback.classList.add('hidden'), 2000);
                });
            }

            function toggleDirectPromptEditing() {
                isDirectPromptEditing = document.getElementById('direct-prompt-toggle').checked;
                const editorContainer = document.getElementById('direct-prompt-editor-container');
                const promptInput = document.getElementById('direct-prompt-input');
                if (isDirectPromptEditing) {
                    editorContainer.classList.remove('hidden');
                    promptInput.value = constructPrompt(true); // Show current constructed prompt
                    currentManualPrompt = promptInput.value;
                } else {
                    editorContainer.classList.add('hidden');
                    currentManualPrompt = '';
                }
            }
            function resetDirectPromptInput() {
                if (confirm("Are you sure you want to reset? This will discard any manual changes.")) {
                    document.getElementById('direct-prompt-input').value = constructPrompt(true);
                    currentManualPrompt = document.getElementById('direct-prompt-input').value;
                }
            }

            function savePipelineToStorage() {
                localStorage.setItem(STORAGE_KEYS.pipeline, JSON.stringify({ steps: outputPipeline, enabled: pipelineEnabled }));
            }
            function loadPipelineFromStorage() {
                const data = JSON.parse(localStorage.getItem(STORAGE_KEYS.pipeline) || '{}');
                outputPipeline = data.steps || [];
                pipelineEnabled = data.enabled || false;
                document.getElementById('pipeline-enabled-toggle').checked = pipelineEnabled;
            }
            function renderPipelineSteps() {
                const list = document.getElementById('pipeline-steps-list');
                list.innerHTML = outputPipeline.length === 0 ? '<p class="text-output/70 text-center text-lg">No steps defined.</p>' : '';
                outputPipeline.forEach((step, idx) => {
                    let desc = '';
                    if (step.type === 'regex') desc = `Regex Replace: /${step.find}/ → "${step.replace}"`;
                    if (step.type === 'append') desc = `Append: "${step.replace}"`;
                    if (step.type === 'prepend') desc = `Prepend: "${step.replace}"`;
                    list.innerHTML += `<div class="flex items-center gap-2 bg-black/10 p-2 rounded"><span class="flex-grow">${desc}</span><button class="topic-btn p-1 rounded" onclick="editPipelineStep(${idx})">✏️</button><button class="topic-btn p-1 rounded" onclick="deletePipelineStep(${idx})">🗑️</button>${idx > 0 ? `<button class='topic-btn p-1 rounded' onclick='movePipelineStep(${idx},-1)'>⬆️</button>` : ''}${idx < outputPipeline.length-1 ? `<button class='topic-btn p-1 rounded' onclick='movePipelineStep(${idx},1)'>⬇️</button>` : ''}</div>`;
                });
            }
            window.editPipelineStep = function(idx) {
                editingStepIndex = idx;
                showPipelineStepEditor(outputPipeline[idx]);
            };
            window.deletePipelineStep = function(idx) {
                outputPipeline.splice(idx,1);
                savePipelineToStorage();
                renderPipelineSteps();
            };
            window.movePipelineStep = function(idx, dir) {
                const newIdx = idx + dir;
                if (newIdx < 0 || newIdx >= outputPipeline.length) return;
                const [step] = outputPipeline.splice(idx,1);
                outputPipeline.splice(newIdx,0,step);
                savePipelineToStorage();
                renderPipelineSteps();
            };
            function showPipelineStepEditor(step = null) {
                document.getElementById('pipeline-step-editor').classList.remove('hidden');
                document.getElementById('pipeline-step-type').value = step ? step.type : 'regex';
                document.getElementById('pipeline-step-find').value = step && step.find ? step.find : '';
                document.getElementById('pipeline-step-replace').value = step && step.replace ? step.replace : '';
            }
            function hidePipelineStepEditor() {
                document.getElementById('pipeline-step-editor').classList.add('hidden');
                document.getElementById('pipeline-step-find').value = '';
                document.getElementById('pipeline-step-replace').value = '';
                editingStepIndex = null;
            }
            function savePipelineStep() {
                const type = document.getElementById('pipeline-step-type').value;
                const find = document.getElementById('pipeline-step-find').value;
                const replace = document.getElementById('pipeline-step-replace').value;
                const step = { type, find, replace };
                if (editingStepIndex !== null) {
                    outputPipeline[editingStepIndex] = step;
                } else {
                    outputPipeline.push(step);
                }
                savePipelineToStorage();
                renderPipelineSteps();
                hidePipelineStepEditor();
            }
            function applyOutputPipeline(text) {
                if (!pipelineEnabled || !outputPipeline.length) return text;
                let out = text;
                for (const step of outputPipeline) {
                    if (step.type === 'regex' && step.find) {
                        try { out = out.replace(new RegExp(step.find, 'g'), step.replace); } catch (e) { /* ignore bad regex */ }
                    }
                    if (step.type === 'append') out = out + (step.replace || '');
                    if (step.type === 'prepend') out = (step.replace || '') + out;
                }
                return out;
            }

            // --- VALIDATION & CONFIGURATION HELPERS ---
            function getCurrentConfig() {
                return {
                    sliders: Object.fromEntries(
                        Object.entries(sliders)
                            .filter(([_, s]) => !s.disable.checked)
                            .map(([key, s]) => [key, s.el.value])
                    ),
                    inputs: {
                        targetProfile: document.getElementById('target-profile-select').value,
                        generatorPersona: document.getElementById('generator-persona-select').value,
                        pov: document.getElementById('pov-selector').value,
                        scenario: document.getElementById('scenario-input').value,
                        culturalContext: document.getElementById('cultural-context-input').value,
                        inspirationalSource: document.getElementById('inspirational-source-input').value,
                        negativePrompt: document.getElementById('negative-prompt-input').value,
                        numJokes: document.getElementById('num-jokes-input').value,
                        guaranteedWords: document.getElementById('guaranteed-words-input').value,
                        startsWith: document.getElementById('starts-with-input').value,
                        safetyFilterLevel: document.getElementById('safety-filter-level').value,
                        outputFormatPreset: document.getElementById('output-format-preset').value,
                        languageBankSelect: document.getElementById('language-bank-select').value,
                        validationRules: document.getElementById('validation-rules-input').value,
                        maxRetries: document.getElementById('max-retries-input').value,
                    },
                    disabledSliders: Object.entries(sliders)
                        .filter(([_, s]) => s.disable.checked)
                        .map(([key]) => key)
                };
            }

            async function validateJoke(jokeText, rules) {
                if (!rules || rules.length === 0) {
                    return { passed: true, reason: 'No validation rules specified.', failedRules: [] };
                }

                const validationPrompt = `You are a joke validation expert. Your task is to evaluate the following joke against the given rules.

Joke to validate:
"${jokeText}"

Rules to check (one per line):
${rules.map((rule, i) => `${i + 1}. ${rule}`).join('\n')}

For each rule, respond with either:
PASS: [rule number] - [brief explanation why it passed]
FAIL: [rule number] - [brief explanation why it failed]

Then conclude with either:
VALIDATION PASSED: [summary of why all rules passed]
or
VALIDATION FAILED: [summary of which rules failed and why]

Keep your response concise and focused on the validation results.`;

                try {
                    const validationResult = await callApi(validationPrompt);
                    const lines = validationResult.split('\n');
                    const failedRules = [];
                    let passed = true;
                    let reason = '';

                    for (const line of lines) {
                        if (line.startsWith('FAIL:')) {
                            passed = false;
                            const ruleMatch = line.match(/FAIL: (\d+)/);
                            if (ruleMatch) {
                                const ruleIndex = parseInt(ruleMatch[1]) - 1;
                                if (ruleIndex >= 0 && ruleIndex < rules.length) {
                                    failedRules.push(rules[ruleIndex]);
                                }
                            }
                        }
                        if (line.startsWith('VALIDATION FAILED:')) {
                            reason = line.replace('VALIDATION FAILED:', '').trim();
                        }
                    }

                    return {
                        passed,
                        reason: reason || (passed ? 'All validation rules passed.' : 'Validation failed.'),
                        failedRules
                    };
                } catch (error) {
                    console.error('Validation error:', error);
                    return {
                        passed: false,
                        reason: `Validation service error: ${error.message}`,
                        failedRules: rules
                    };
                }
            }

            // --- START THE APP ---
            initializeApp();
        });

        // Tab Management
        function initializeTabs() {
            // Main tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    const tabContainer = tab.closest('.panel');
                    
                    // Update tab states
                    tabContainer.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update content visibility
                    tabContainer.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    tabContainer.querySelector(`#${tabId}-tab`).classList.add('active');
                });
            });

            // Sub-tabs
            document.querySelectorAll('.sub-tab').forEach(subTab => {
                subTab.addEventListener('click', () => {
                    const subTabId = subTab.dataset.subtab;
                    const tabContent = subTab.closest('.tab-content');
                    
                    // Update sub-tab states
                    tabContent.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                    subTab.classList.add('active');
                    
                    // Update sub-content visibility
                    tabContent.querySelectorAll('.sub-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    tabContent.querySelector(`#${subTabId}-subtab`).classList.add('active');
                });
            });
        }

        // Initialize tabs when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeTabs();
            // ... existing initialization code ...
        });

        // Initialize UI
        updateAnalyticsUI();
        updateHistoryUI();
        updateFeedbackUI();



        // Analytics UI update functions
        function updateAnalyticsUI() {
            // Update session statistics
            document.getElementById('total-generations').textContent = analytics.totalGenerations;
            document.getElementById('success-rate').textContent = 
                `${Math.round((analytics.successfulGenerations / analytics.totalGenerations) * 100 || 0)}%`;
            document.getElementById('avg-length').textContent = 
                Math.round(analytics.totalLength / analytics.totalGenerations || 0);
            document.getElementById('total-favorites').textContent = analytics.favorites;
            
            // Update most used settings
            const mostUsedPersona = Object.entries(analytics.settings.personas)
                .sort((a, b) => b[1] - a[1])[0];
            const mostUsedPOV = Object.entries(analytics.settings.povs)
                .sort((a, b) => b[1] - a[1])[0];
            const avgAggression = analytics.settings.aggression.length > 0
                ? analytics.settings.aggression.reduce((a, b) => a + b) / analytics.settings.aggression.length
                : 0;
            
            document.getElementById('most-used-persona').textContent = mostUsedPersona ? mostUsedPersona[0] : '-';
            document.getElementById('most-used-pov').textContent = mostUsedPOV ? mostUsedPOV[0] : '-';
            document.getElementById('avg-aggression').textContent = avgAggression.toFixed(1);
            
            // Update performance metrics
            const avgGenerationTime = analytics.performance.generationTimes.length > 0
                ? analytics.performance.generationTimes.reduce((a, b) => a + b) / analytics.performance.generationTimes.length
                : 0;
            const retryRate = analytics.totalGenerations > 0
                ? (analytics.performance.retries / analytics.totalGenerations) * 100
                : 0;
            const validationSuccess = analytics.performance.validations > 0
                ? (analytics.performance.successfulValidations / analytics.performance.validations) * 100
                : 0;
            
            document.getElementById('avg-generation-time').textContent = `${avgGenerationTime.toFixed(1)}s`;
            document.getElementById('retry-rate').textContent = `${retryRate.toFixed(1)}%`;
            document.getElementById('validation-success').textContent = `${validationSuccess.toFixed(1)}%`;
            
            // Update rating distribution
            const totalRatings = Object.values(analytics.ratings).reduce((a, b) => a + b, 0);
            for (let i = 3; i <= 5; i++) {
                const percentage = totalRatings > 0 ? (analytics.ratings[i] / totalRatings) * 100 : 0;
                document.getElementById(`rating-${i}`).style.width = `${percentage}%`;
                document.getElementById(`rating-${i}-count`).textContent = analytics.ratings[i];
            }
        }

        function updateHistoryUI() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = generationHistory.map(item => `
                <div class="bg-panel-bg/50 p-3 rounded-lg border border-panel-border/50">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-main">${new Date(item.timestamp).toLocaleString()}</div>
                        <div class="flex gap-2">
                            <button class="topic-btn rounded-lg p-1" onclick="rateGeneration(${generationHistory.indexOf(item)}, 5)">⭐</button>
                            <button class="topic-btn rounded-lg p-1" onclick="addFeedback(${generationHistory.indexOf(item)})">💬</button>
                        </div>
                    </div>
                    <div class="text-output mb-2">${item.result}</div>
                    <div class="text-sm text-main/70">
                        Persona: ${item.settings.persona} | POV: ${item.settings.pov} | 
                        Aggression: ${item.settings.aggression} | Time: ${item.performance.generationTime.toFixed(1)}s
                    </div>
                </div>
            `).join('');
        }

        function updateFeedbackUI() {
            const feedbackList = document.getElementById('recent-feedback');
            feedbackList.innerHTML = analytics.feedback.map(item => `
                <div class="bg-panel-bg/50 p-3 rounded-lg border border-panel-border/50">
                    <div class="text-sm text-main/70 mb-1">${new Date(item.timestamp).toLocaleString()}</div>
                    <div class="text-output">${item.text}</div>
                </div>
            `).join('');
        }

        // Add event listeners for history controls
        document.getElementById('clear-history-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the history?')) {
                generationHistory = [];
                updateHistoryUI();
            }
        });

        document.getElementById('export-history-btn').addEventListener('click', () => {
            const data = {
                history: generationHistory,
                analytics: analytics
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `generation-history-${new Date().toISOString()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Initialize UI after all functions and variables are defined
        document.addEventListener('DOMContentLoaded', () => {
            updateAnalyticsUI();
            updateHistoryUI();
            updateFeedbackUI();
        });

        // History and Analytics
        // Update analytics after generation
        function updateAnalytics(result, startTime) {
            const generationTime = (Date.now() - startTime) / 1000;
                const isSuccess = result && result.trim().length > 0;

            // Update basic stats
            analytics.totalGenerations++;
            if (isSuccess) analytics.successfulGenerations++;
            if (result) analytics.totalLength += result.length;

            // Update settings usage
            storyChainMode = document.getElementById('story-chain-mode-toggle').checked;
            themeLockMode = document.getElementById('theme-lock-mode-toggle').checked;
            remixMode = document.getElementById('remix-mode-toggle').checked;
            escalationMode = document.getElementById('escalation-mode-toggle').checked;
            const persona = document.getElementById('generator-persona-select')?.value || 'default';
            const pov = document.getElementById('pov-selector')?.value || 'third-person';
            const aggression = parseFloat(document.getElementById('aggression-slider')?.value || '50');
            
            analytics.settings.personas[persona] = (analytics.settings.personas[persona] || 0) + 1;
            analytics.settings.povs[pov] = (analytics.settings.povs[pov] || 0) + 1;
            analytics.settings.aggression.push(aggression);
            
            // Update performance metrics
            analytics.performance.generationTimes.push(generationTime);
            
            // Add to history
            const historyItem = {
                timestamp: new Date().toISOString(),
                result,
                settings: {
                    persona,
                    pov,
                    aggression,
                    topics: Array.from(document.querySelectorAll('#topic-matrix .topic-btn.active')).map(btn => btn.dataset.topic),
                    scenario: document.getElementById('scenario-input')?.value || '',
                    culturalContext: document.getElementById('cultural-context-input')?.value || ''
                },
                performance: {
                    generationTime,
                    retries: 0,
                    validationSuccess: isSuccess
                }
            };
            
            generationHistory.unshift(historyItem);
            if (generationHistory.length > 100) generationHistory.pop();
            
            // Update UI
            updateAnalyticsUI();
            updateHistoryUI();
        }

        // AI Theme Maker
        function generateThemeFromPrompt(prompt) {
            // Convert prompt to a seed number for consistent color generation
            const seed = prompt.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            
            // Generate base hue from the seed (0-360)
            const baseHue = seed % 360;
            
            // Generate complementary and analogous colors
            const complementaryHue = (baseHue + 180) % 360;
            const analogousHue1 = (baseHue + 30) % 360;
            const analogousHue2 = (baseHue - 30 + 360) % 360;
            
            // Generate background colors with varying saturation and lightness
            const bgColors = [
                `hsl(${baseHue}, ${70 + (seed % 20)}%, ${10 + (seed % 10)}%)`,
                `hsl(${baseHue}, ${60 + (seed % 20)}%, ${15 + (seed % 10)}%)`,
                `hsl(${baseHue}, ${50 + (seed % 20)}%, ${20 + (seed % 10)}%)`
            ];
            
            // Generate accent colors
            const accentColor = `hsl(${complementaryHue}, ${80 + (seed % 20)}%, ${50 + (seed % 20)}%)`;
            const secondaryAccent = `hsl(${analogousHue1}, ${70 + (seed % 20)}%, ${60 + (seed % 20)}%)`;
            
            // Determine text color based on background brightness
            const bgBrightness = (seed % 100) < 50;
            const textColor = bgBrightness ? '#ffffff' : '#000000';
            
            // Generate semi-transparent versions of background colors
            const bgColor1 = bgColors[0].replace(')', ', 0.5)').replace('hsl', 'hsla');
            const bgColor2 = bgColors[1].replace(')', ', 0.7)').replace('hsl', 'hsla');
            
            return {
                '--bg-grad-1': bgColors[0],
                '--bg-grad-2': bgColors[1],
                '--bg-grad-3': bgColors[2],
                '--primary-color': accentColor,
                '--text-color': textColor,
                '--text-white': textColor,
                '--panel-bg': bgColor1,
                '--panel-border': accentColor,
                '--joke-container-bg': bgColor2,
                '--input-bg': bgColor1,
                '--glitch-1': accentColor,
                '--glitch-2': secondaryAccent
            };
        }

        function applyGeneratedTheme(theme) {
            const root = document.documentElement;
            for (const [property, value] of Object.entries(theme)) {
                root.style.setProperty(property, value);
            }
            
            // Save the generated theme
            const themeName = `custom-${Date.now()}`;
            const themeData = {
                name: themeName,
                colors: theme,
                prompt: document.getElementById('themePrompt').value
            };
            
            // Store in localStorage
            const savedThemes = JSON.parse(localStorage.getItem('customThemes') || '[]');
            savedThemes.push(themeData);
            localStorage.setItem('customThemes', JSON.stringify(savedThemes));
            
            // Add to theme buttons
            addCustomThemeButton(themeName, theme);
        }

        function addCustomThemeButton(themeName, theme) {
            const themeButton = document.createElement('button');
            themeButton.className = 'theme-button';
            themeButton.textContent = `Custom: ${themeName}`;
            themeButton.onclick = () => applyGeneratedTheme(theme);
            
            // Add preview colors
            const preview = document.createElement('div');
            preview.className = 'theme-preview';
            preview.style.display = 'flex';
            preview.style.gap = '4px';
            preview.style.marginTop = '4px';
            
            [theme['--bg-grad-1'], theme['--primary-color'], theme['--text-color']].forEach(color => {
                const colorBox = document.createElement('div');
                colorBox.style.width = '12px';
                colorBox.style.height = '12px';
                colorBox.style.backgroundColor = color;
                colorBox.style.borderRadius = '2px';
                preview.appendChild(colorBox);
            });
            
            themeButton.appendChild(preview);
            
            // Find the theme container and insert after the theme maker
            const themeContainer = document.querySelector('.theme-container');
            const themeMaker = document.querySelector('.ai-theme-maker');
            if (themeContainer && themeMaker) {
                themeContainer.insertBefore(themeButton, themeMaker.nextSibling);
            }
        }

        // Load saved custom themes on page load
        document.addEventListener('DOMContentLoaded', function() {
            // First create the theme maker
            const themeMaker = document.createElement('div');
            themeMaker.className = 'ai-theme-maker';
            themeMaker.innerHTML = `
                <h3 style="color: var(--text-white); margin-bottom: 1rem;">AI Theme Maker</h3>
                <input type="text" id="themePrompt" placeholder="Describe your theme (e.g., 'dark cyberpunk', 'warm sunset', 'cool ocean')" style="color: var(--text-white);">
                <button onclick="generateTheme()" style="background: var(--primary-color); color: var(--text-white);">Generate Theme</button>
                <div id="themePreview" class="theme-preview"></div>
            `;

            // Find the theme container
            const themeContainer = document.querySelector('.theme-container');
            if (themeContainer) {
                // Insert the theme maker at the beginning of the theme container
                themeContainer.insertBefore(themeMaker, themeContainer.firstChild);
                
                // Then load saved themes
                const savedThemes = JSON.parse(localStorage.getItem('customThemes') || '[]');
                savedThemes.forEach(themeData => {
                    addCustomThemeButton(themeData.name, themeData.colors);
                });
            }
        });

        function showThemePreview(theme) {
            const preview = document.getElementById('themePreview');
            preview.innerHTML = '';
            
            const colors = [
                theme['--bg-grad-1'],
                theme['--bg-grad-2'],
                theme['--bg-grad-3'],
                theme['--primary-color'],
                theme['--text-color']
            ];

            colors.forEach(color => {
                const colorBox = document.createElement('div');
                colorBox.className = 'theme-preview-color';
                colorBox.style.backgroundColor = color;
                preview.appendChild(colorBox);
            });
        }

        function generateTheme() {
            const prompt = document.getElementById('themePrompt').value;
            if (!prompt) return;

            const theme = generateThemeFromPrompt(prompt);
            showThemePreview(theme);
            applyGeneratedTheme(theme);
        }

        // Knowledge Base Management
        let knowledgeBases = JSON.parse(localStorage.getItem('knowledgeBases')) || [];

        function openKnowledgeBaseModal() {
            document.getElementById('knowledgeBaseModal').classList.remove('hidden');
            updateKnowledgeBaseList();
            updateKnowledgeBaseSelection();
        }

        function closeKnowledgeBaseModal() {
            document.getElementById('knowledgeBaseModal').classList.add('hidden');
        }

        function updateKnowledgeBaseList() {
            const list = document.getElementById('knowledgeBaseList');
            list.innerHTML = knowledgeBases.map((kb, index) => `
                <div class="knowledge-base-item">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="text-xl font-bold text-main">${kb.name}</h4>
                            <p class="text-sm text-main mt-2">${kb.content.substring(0, 100)}...</p>
                            <div class="mt-2">
                                ${kb.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                        <button onclick="deleteKnowledgeBase(${index})" class="text-main hover:text-white">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateKnowledgeBaseSelection() {
            const select = document.getElementById('kbSelection');
            select.innerHTML = knowledgeBases.map((kb, index) => 
                `<option value="${index}">${kb.name}</option>`
            ).join('');
        }

        function createKnowledgeBase() {
            const name = document.getElementById('kbName').value.trim();
            const content = document.getElementById('kbContent').value.trim();
            const tags = document.getElementById('kbTags').value
                .split(',')
                .map(tag => tag.trim())
                .filter(tag => tag);

            if (!name || !content) {
                alert('Please provide both a name and content for the knowledge base.');
                return;
            }

            knowledgeBases.push({ name, content, tags });
            localStorage.setItem('knowledgeBases', JSON.stringify(knowledgeBases));
            
            // Clear form
            document.getElementById('kbName').value = '';
            document.getElementById('kbContent').value = '';
            document.getElementById('kbTags').value = '';
            
            updateKnowledgeBaseList();
            updateKnowledgeBaseSelection();
        }

        function deleteKnowledgeBase(index) {
            if (confirm('Are you sure you want to delete this knowledge base?')) {
                knowledgeBases.splice(index, 1);
                localStorage.setItem('knowledgeBases', JSON.stringify(knowledgeBases));
                updateKnowledgeBaseList();
                updateKnowledgeBaseSelection();
            }
        }

        // File Upload Handling
        document.getElementById('kbFileUpload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const content = await readFileContent(file);
                document.getElementById('kbContent').value = content;
            } catch (error) {
                alert('Error reading file: ' + error.message);
            }
        });

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Failed to read file'));
                
                if (file.type === 'application/pdf') {
                    // For PDF files, we'll need to use a PDF.js library
                    alert('PDF support coming soon!');
                    reject(new Error('PDF support not implemented yet'));
                } else {
                    reader.readAsText(file);
                }
            });
        }

        // Drag and Drop Support
        const dropZone = document.querySelector('.file-upload-container');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('bg-opacity-50');
        }

        function unhighlight(e) {
            dropZone.classList.remove('bg-opacity-50');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            if (file) {
                document.getElementById('kbFileUpload').files = dt.files;
                const event = new Event('change');
                document.getElementById('kbFileUpload').dispatchEvent(event);
            }
        }

        // Integration with Roast Generation
        function getSelectedKnowledgeBases() {
            const select = document.getElementById('kbSelection');
            const selectedIndices = Array.from(select.selectedOptions).map(option => parseInt(option.value));
            return selectedIndices.map(index => knowledgeBases[index]);
        }

        function getKnowledgeBaseContext() {
            const selectedKBs = getSelectedKnowledgeBases();
            const keywords = document.getElementById('kbKeywords').value.trim();
            
            if (!selectedKBs.length) return '';

            let context = 'Additional context from knowledge bases:\n';
            selectedKBs.forEach(kb => {
                context += `\nFrom "${kb.name}":\n`;
                if (keywords) {
                    // Simple keyword matching - in a real implementation, this would use proper RAG
                    const relevantContent = kb.content
                        .split('\n')
                        .filter(line => keywords.split(' ').some(keyword => 
                            line.toLowerCase().includes(keyword.toLowerCase())
                        ))
                        .join('\n');
                    context += relevantContent || 'No relevant content found for the given keywords.';
                } else {
                    context += kb.content;
                }
            });
            
            return context;
        }

        // Modify the existing generateRoast function to include knowledge base context
        const originalGenerateRoast = window.generateRoast;
        window.generateRoast = async function() {
            const kbContext = getKnowledgeBaseContext();
            if (kbContext) {
                // Add knowledge base context to the prompt
                const originalPrompt = document.getElementById('prompt').value;
                document.getElementById('prompt').value = `${originalPrompt}\n\n${kbContext}`;
            }
            
            await originalGenerateRoast();
            
            // Restore original prompt if we modified it
            if (kbContext) {
                document.getElementById('prompt').value = originalPrompt;
            }
        };

        // Add Knowledge Base button to the UI
        const controlPanel = document.querySelector('.control-panel');
        const kbButton = document.createElement('button');
        kbButton.className = 'main-button px-4 py-2 rounded text-main-button-text mb-4';
        kbButton.textContent = 'Knowledge Base';
        kbButton.onclick = openKnowledgeBaseModal;
        controlPanel.insertBefore(kbButton, controlPanel.firstChild);

        // Workflow Engine
        let workflows = JSON.parse(localStorage.getItem('workflows')) || [];
        let currentWorkflow = {
            nodes: [],
            connections: []
        };
        let selectedNode = null;
        let isDragging = false;
        let dragStartNode = null;


        // Topic Clustering
        let topicClusters = JSON.parse(localStorage.getItem('topicClusters')) || [];
        
        
        function createTopicCluster() {
            const name = document.getElementById('cluster-name').value.trim();
            const color = document.getElementById('cluster-color').value;
            
            if (!name) return;
            
            const cluster = {
                id: Date.now(),
                name,
                color,
                topics: []
            };
            
            topicClusters.push(cluster);
            localStorage.setItem('topicClusters', JSON.stringify(topicClusters));
            updateActiveClusters();
            document.getElementById('cluster-name').value = '';
        }
        
        function updateActiveClusters() {
            const container = document.getElementById('active-clusters');
            container.innerHTML = topicClusters.map(cluster => `
                <div class="cluster-tag" style="background-color: ${cluster.color}20; border: 1px solid ${cluster.color}">
                    <span style="color: ${cluster.color}">${cluster.name}</span>
                    <button onclick="deleteCluster(${cluster.id})" class="ml-2 text-sm">×</button>
                </div>
            `).join('');
        }
        
        function deleteCluster(id) {
            topicClusters = topicClusters.filter(c => c.id !== id);
            localStorage.setItem('topicClusters', JSON.stringify(topicClusters));
            updateActiveClusters();
        }
        
        // Context Templates
        let contextTemplates = JSON.parse(localStorage.getItem('contextTemplates')) || [];
        
        function saveContextTemplate() {
            const category = document.getElementById('template-category').value;
            const name = document.getElementById('template-name').value.trim();
            
            if (!name) return;
            
            const template = {
                id: Date.now(),
                name,
                category,
                settings: {
                    topics: Array.from(document.getElementById('topic-matrix').querySelectorAll('.topic-btn.active')).map(btn => btn.dataset.topic),
                    guaranteedWords: document.getElementById('guaranteed-words-input').value,
                    startsWith: document.getElementById('starts-with-input').value,
                    scenario: document.getElementById('scenario-input').value,
                    culturalContext: document.getElementById('cultural-context-input').value,
                    inspirationalSource: document.getElementById('inspirational-source-input').value,
                    constraints: document.getElementById('negative-prompt-input').value,
                    excludedWords: document.getElementById('excluded-words-input').value
                }
            };
            
            contextTemplates.push(template);
            localStorage.setItem('contextTemplates', JSON.stringify(contextTemplates));
            updateTemplateList();
            document.getElementById('template-name').value = '';
        }
        
        function loadContextTemplate(id) {
            const template = contextTemplates.find(t => t.id === id);
            if (!template) return;
            
            // Apply template settings
            document.getElementById('guaranteed-words-input').value = template.settings.guaranteedWords;
            document.getElementById('starts-with-input').value = template.settings.startsWith || '';
            document.getElementById('scenario-input').value = template.settings.scenario;
            document.getElementById('cultural-context-input').value = template.settings.culturalContext;
            document.getElementById('inspirational-source-input').value = template.settings.inspirationalSource;
            document.getElementById('negative-prompt-input').value = template.settings.constraints;
            document.getElementById('excluded-words-input').value = template.settings.excludedWords;
            
            // Update topic matrix
            const topicButtons = document.getElementById('topic-matrix').querySelectorAll('.topic-btn');
            topicButtons.forEach(btn => {
                btn.classList.toggle('active', template.settings.topics.includes(btn.dataset.topic));
            });
        }
        
        function updateTemplateList() {
            const container = document.getElementById('template-list');
            container.innerHTML = contextTemplates.map(template => `
                <div class="template-card p-2 rounded-lg border border-panel-border">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">${template.name}</span>
                        <span class="text-sm text-main/70">${template.category}</span>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="loadContextTemplate(${template.id})" class="topic-btn rounded-lg p-1 text-sm">Load</button>
                        <button onclick="deleteTemplate(${template.id})" class="topic-btn rounded-lg p-1 text-sm">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function deleteTemplate(id) {
            contextTemplates = contextTemplates.filter(t => t.id !== id);
            localStorage.setItem('contextTemplates', JSON.stringify(contextTemplates));
            updateTemplateList();
        }
        
        // Reference Library
        let references = JSON.parse(localStorage.getItem('references')) || [];
        let apiSearchResults = [];
        
        async function searchAPIReferences(query) {
            const searchResults = document.getElementById('api-search-results');
            const resultsList = document.getElementById('api-results-list');
            
            try {
                // Show loading state
                resultsList.innerHTML = '<div class="text-center text-main/70">Searching...</div>';
                searchResults.classList.remove('hidden');
                
                // Make API call to search for references using the same configuration as generation
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are a reference search assistant. Search for and return relevant references related to: "${query}". 
                                Return ONLY a list of references, with each reference in quotation marks.
                                For song lyrics, include the full lyrics in quotation marks.
                                For other references, include the reference in quotation marks.
                                
                                Rules:
                                1. Return exactly 5 results
                                2. Each result must be unique and relevant
                                3. Include a mix of different types (lyrics, quotes, references)
                                4. Each reference should be on its own line
                                5. Do not include any explanations or formatting
                                6. Do not use JSON or any other structured format`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 2048,
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });
                
                const data = await response.json();
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid API response');
                }
                
                // Get the text response directly
                const text = data.candidates[0].content.parts[0].text;
                if (!text) throw new Error("API returned an empty response.");
                
                // Display the results with nice formatting
                const results = text.split('\n').filter(line => line.trim());
                resultsList.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <button id="confirm-selection" class="topic-btn rounded-lg p-2 font-semibold hidden">Add Selected References</button>
                        <span id="selection-count" class="text-main/70"></span>
                    </div>
                    ${results.map((result, index) => `
                        <div class="bg-panel-bg/50 p-3 rounded-lg border border-panel-border/50 mb-2 hover:bg-panel-bg/70 transition-colors">
                            <div class="flex items-start gap-3">
                                <input type="checkbox" class="reference-checkbox mt-1" data-index="${index}">
                                <p class="text-output flex-grow">${result}</p>
                            </div>
                        </div>
                    `).join('')}
                `;

                // Add event listeners for checkboxes
                const checkboxes = resultsList.querySelectorAll('.reference-checkbox');
                const confirmBtn = document.getElementById('confirm-selection');
                const selectionCount = document.getElementById('selection-count');
                
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const selectedCount = resultsList.querySelectorAll('.reference-checkbox:checked').length;
                        confirmBtn.classList.toggle('hidden', selectedCount === 0);
                        selectionCount.textContent = selectedCount > 0 ? `${selectedCount} selected` : '';
                    });
                });

                // Add event listener for confirm button
                confirmBtn.addEventListener('click', () => {
                    const selectedReferences = Array.from(resultsList.querySelectorAll('.reference-checkbox:checked'))
                        .map(checkbox => results[parseInt(checkbox.dataset.index)]);
                    
                    // Add each selected reference to the library
                    selectedReferences.forEach(reference => {
                        const referenceType = document.getElementById('reference-type');
                        const referenceTags = document.getElementById('reference-tags');
                        
                        // Add to references array
                        references.push({
                            id: Date.now() + Math.random(),
                            title: reference.substring(0, 50) + '...',
                            content: reference,
                            type: referenceType.value,
                            tags: referenceTags.value.split(',').map(tag => tag.trim()).filter(tag => tag)
                        });
                    });
                    
                    // Save to localStorage
                    localStorage.setItem('references', JSON.stringify(references));
                    
                    // Update display
                    displayReferences();
                    
                    // Reset selection
                    checkboxes.forEach(cb => cb.checked = false);
                    confirmBtn.classList.add('hidden');
                    selectionCount.textContent = '';
                    
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg';
                    successMsg.textContent = `Added ${selectedReferences.length} reference(s)`;
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                });
                
            } catch (error) {
                console.error("Error searching references:", error);
                resultsList.innerHTML = `<div class="text-red-400">Error: ${error.message}</div>`;
            }
        }
        
        function selectApiResult(index) {
            const result = apiSearchResults[index];
            document.getElementById('reference-type').value = result.type;
            document.getElementById('reference-tags').value = result.tags.join(', ');
        }
        
        function addApiResult(index) {
            const result = apiSearchResults[index];
            addReference(result);
        }
        
        function addReference(prefilledData = null) {
            const type = document.getElementById('reference-type').value;
            const tags = document.getElementById('reference-tags').value.split(',').map(t => t.trim());
            let content = '';
            let title = '';
            
            if (prefilledData) {
                content = prefilledData.content;
                title = prefilledData.title;
            } else {
                switch(type) {
                    case 'text':
                        title = prompt('Enter reference title:');
                        content = prompt('Enter reference text:');
                        break;
                    case 'link':
                        title = prompt('Enter link title:');
                        content = prompt('Enter URL:');
                        break;
                    case 'image':
                        title = prompt('Enter image title:');
                        content = prompt('Enter image URL:');
                        break;
                    case 'document':
                        title = prompt('Enter document title:');
                        content = prompt('Enter document URL:');
                        break;
                }
            }
            
            if (!content) return;
            
            const reference = {
                id: Date.now(),
                type,
                title: title || content.substring(0, 50),
                content,
                tags,
                createdAt: new Date().toISOString()
            };
            
            references.push(reference);
            localStorage.setItem('references', JSON.stringify(references));
            updateReferenceList();
            document.getElementById('reference-tags').value = '';
        }
        
        function updateReferenceList() {
            const container = document.getElementById('reference-list');
            const searchTerm = document.getElementById('reference-search').value.toLowerCase();
            
            const filteredRefs = references.filter(ref => 
                ref.title.toLowerCase().includes(searchTerm) ||
                ref.content.toLowerCase().includes(searchTerm) ||
                ref.tags.some(tag => tag.toLowerCase().includes(searchTerm))
            );
            
            container.innerHTML = filteredRefs.map(ref => `
                <div class="reference-item p-2 rounded-lg border border-panel-border">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <span class="text-sm text-main/70">${ref.type}</span>
                            <h5 class="font-semibold">${ref.title}</h5>
                            ${ref.type === 'image' ? 
                                `<img src="${ref.content}" alt="${ref.title}" class="mt-2 max-h-32 rounded-lg">` :
                                `<p class="mt-1">${ref.content}</p>`
                            }
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${ref.tags.map(tag => `<span class="text-xs bg-panel-border/30 px-1 rounded">${tag}</span>`).join('')}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 ml-2">
                            <button onclick="useReference(${ref.id})" class="topic-btn rounded-lg p-1 text-sm">Use</button>
                            <button onclick="deleteReference(${ref.id})" class="topic-btn rounded-lg p-1 text-sm">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function useReference(id) {
            const ref = references.find(r => r.id === id);
            if (!ref) return;
            
            switch(ref.type) {
                case 'text':
                    document.getElementById('inspirational-source-input').value = ref.content;
                    break;
                case 'link':
                    window.open(ref.content, '_blank');
                    break;
                case 'image':
                    // Add image to the context
                    const imgContext = `[Image Reference: ${ref.title}]\n${ref.content}`;
                    document.getElementById('inspirational-source-input').value += '\n\n' + imgContext;
                    break;
                case 'document':
                    // Add document reference to the context
                    const docContext = `[Document Reference: ${ref.title}]\n${ref.content}`;
                    document.getElementById('inspirational-source-input').value += '\n\n' + docContext;
                    break;
            }
        }
        
        function deleteReference(id) {
            references = references.filter(r => r.id !== id);
            localStorage.setItem('references', JSON.stringify(references));
            updateReferenceList();
        }
        
        // Event Listeners
        document.getElementById('search-api-btn').addEventListener('click', () => {
            const query = document.getElementById('reference-search').value.trim();
            if (query) {
                searchAPIReferences(query);
            }
        });
        
        document.getElementById('reference-search').addEventListener('input', (e) => {
            if (e.target.value.trim()) {
                updateReferenceList();
            } else {
                document.getElementById('api-search-results').classList.add('hidden');
            }
        });
        
        document.getElementById('add-reference-btn').addEventListener('click', () => addReference());
        
        // Initialize
        updateReferenceList();

        // Agent Templates
        const agentTemplates = {
            brainstorming: {
                name: 'Brainstorming Agent',
                defaultPrompt: 'Generate 5 potential punchlines for the following target: {target}',
                parameters: [
                    { name: 'numIdeas', label: 'Number of Ideas', type: 'number', default: 5, min: 1, max: 10 }
                ]
            },
            structure: {
                name: 'Structure Agent',
                defaultPrompt: 'Create a joke structure template based on these punchlines: {input}',
                parameters: [
                    { name: 'complexity', label: 'Structure Complexity', type: 'range', default: 5, min: 1, max: 10 }
                ]
            },
            drafting: {
                name: 'Drafting Agent',
                defaultPrompt: 'Fill in the following joke structure with engaging content: {input}',
                parameters: [
                    { name: 'style', label: 'Writing Style', type: 'select', options: ['Casual', 'Formal', 'Sarcastic', 'Witty'] }
                ]
            },
            refinement: {
                name: 'Refinement Agent',
                defaultPrompt: 'Improve and polish the following joke: {input}',
                parameters: [
                    { name: 'aggressiveness', label: 'Refinement Aggressiveness', type: 'range', default: 5, min: 1, max: 10 }
                ]
            },
            filtering: {
                name: 'Filtering Agent',
                defaultPrompt: 'Filter and clean the following joke: {input}',
                parameters: [
                    { name: 'strictness', label: 'Filter Strictness', type: 'range', default: 5, min: 1, max: 10 }
                ]
            }
        };

        function openWorkflowBuilderModal() {
            document.getElementById('workflowBuilderModal').classList.remove('hidden');
            setupWorkflowCanvas();
        }

        function closeWorkflowBuilderModal() {
            document.getElementById('workflowBuilderModal').classList.add('hidden');
        }

        function setupWorkflowCanvas() {
            const canvas = document.getElementById('workflowCanvas');
            
            // Setup drag and drop for agent types
            const agentTypes = document.querySelectorAll('.agent-type');
            agentTypes.forEach(agent => {
                agent.addEventListener('dragstart', handleAgentDragStart);
            });

            canvas.addEventListener('dragover', handleCanvasDragOver);
            canvas.addEventListener('drop', handleCanvasDrop);
            canvas.addEventListener('click', handleCanvasClick);
        }

        function handleAgentDragStart(e) {
            e.dataTransfer.setData('agentType', e.target.dataset.agentType);
        }

        function handleCanvasDragOver(e) {
            e.preventDefault();
        }

        function handleCanvasClick(e) {
            // Only handle clicks directly on the canvas, not on nodes
            if (e.target === document.getElementById('workflowCanvas')) {
                if (selectedNode) {
                    document.getElementById(selectedNode.id).classList.remove('selected');
                    selectedNode = null;
                    document.getElementById('nodeConfigPanel').classList.add('hidden');
                }
            }
        }

        function handleCanvasDrop(e) {
            e.preventDefault();
            const agentType = e.dataTransfer.getData('agentType');
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            createNode(agentType, x, y);
        }

        function createNode(agentType, x, y) {
            const nodeId = 'node_' + Date.now();
            const template = agentTemplates[agentType];
            
            const node = {
                id: nodeId,
                type: agentType,
                x: x,
                y: y,
                prompt: template.defaultPrompt,
                parameters: {}
            };

            // Set default parameter values
            template.parameters.forEach(param => {
                node.parameters[param.name] = param.default;
            });

            currentWorkflow.nodes.push(node);
            renderNode(node);
            
            // Hide the placeholder text when nodes are added
            document.getElementById('canvasPlaceholder').style.display = 'none';
        }

        function renderNode(node) {
            const canvas = document.getElementById('workflowCanvas');
            const nodeElement = document.createElement('div');
            nodeElement.id = node.id;
            nodeElement.className = 'workflow-node';
            nodeElement.style.left = node.x + 'px';
            nodeElement.style.top = node.y + 'px';
            
            const template = agentTemplates[node.type];
            
            nodeElement.innerHTML = `
                <div class="node-header">
                    <span class="text-main font-bold">${template.name}</span>
                    <button onclick="deleteNode('${node.id}')" class="text-main hover:text-white">&times;</button>
                </div>
                <div class="node-content">
                    <div class="node-input-port"></div>
                    <div class="node-output-port"></div>
                </div>
            `;

            nodeElement.addEventListener('click', (e) => {
                e.stopPropagation();
                selectNode(node);
            });

            nodeElement.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('node-output-port')) {
                    startConnection(node);
                }
            });

            canvas.appendChild(nodeElement);
        }

        function selectNode(node) {
            if (selectedNode) {
                document.getElementById(selectedNode.id).classList.remove('selected');
            }
            selectedNode = node;
            document.getElementById(node.id).classList.add('selected');
            showNodeConfig(node);
        }

        function showNodeConfig(node) {
            const panel = document.getElementById('nodeConfigPanel');
            const template = agentTemplates[node.type];
            
            document.getElementById('nodeAgentType').value = template.name;
            document.getElementById('nodePromptTemplate').value = node.prompt;
            
            const paramsContainer = document.getElementById('nodeParameters');
            paramsContainer.innerHTML = '';
            
            template.parameters.forEach(param => {
                const paramElement = document.createElement('div');
                paramElement.className = 'mb-2';
                
                let inputHtml = '';
                switch (param.type) {
                    case 'number':
                    case 'range':
                        inputHtml = `
                            <input type="range" 
                                min="${param.min}" 
                                max="${param.max}" 
                                value="${node.parameters[param.name] || param.default}"
                                onchange="updateNodeParameter('${node.id}', '${param.name}', this.value)"
                                class="w-full">
                            <span class="text-main">${node.parameters[param.name] || param.default}</span>
                        `;
                        break;
                    case 'select':
                        inputHtml = `
                            <select 
                                onchange="updateNodeParameter('${node.id}', '${param.name}', this.value)"
                                class="w-full p-2 rounded">
                                ${param.options.map(opt => `
                                    <option value="${opt}" ${node.parameters[param.name] === opt ? 'selected' : ''}>
                                        ${opt}
                                    </option>
                                `).join('')}
                            </select>
                        `;
                        break;
                }
                
                paramElement.innerHTML = `
                    <label class="block text-main mb-1">${param.label}</label>
                    ${inputHtml}
                `;
                
                paramsContainer.appendChild(paramElement);
            });
            
            panel.classList.remove('hidden');
        }

        function updateNodeParameter(nodeId, paramName, value) {
            const node = currentWorkflow.nodes.find(n => n.id === nodeId);
            if (node) {
                node.parameters[paramName] = value;
            }
        }

        function deleteNode(nodeId) {
            currentWorkflow.nodes = currentWorkflow.nodes.filter(n => n.id !== nodeId);
            currentWorkflow.connections = currentWorkflow.connections.filter(
                c => c.from !== nodeId && c.to !== nodeId
            );
            document.getElementById(nodeId).remove();
            renderConnections();
        }

        function startConnection(fromNode) {
            dragStartNode = fromNode;
            isDragging = true;
            
            document.addEventListener('mousemove', handleConnectionDrag);
            document.addEventListener('mouseup', handleConnectionEnd);
        }

        function handleConnectionDrag(e) {
            if (!isDragging) return;
            
            const canvas = document.getElementById('workflowCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Update temporary connection line
            renderTemporaryConnection(x, y);
        }

        function handleConnectionEnd(e) {
            if (!isDragging) return;
            
            const canvas = document.getElementById('workflowCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Find target node
            const targetNode = findNodeAtPosition(x, y);
            
            if (targetNode && targetNode !== dragStartNode) {
                createConnection(dragStartNode, targetNode);
            }
            
            isDragging = false;
            dragStartNode = null;
            document.removeEventListener('mousemove', handleConnectionDrag);
            document.removeEventListener('mouseup', handleConnectionEnd);
            
            // Remove temporary connection
            const tempConnection = document.querySelector('.workflow-connection.temporary');
            if (tempConnection) {
                tempConnection.remove();
            }
        }

        function createConnection(fromNode, toNode) {
            const connection = {
                from: fromNode.id,
                to: toNode.id
            };
            
            currentWorkflow.connections.push(connection);
            renderConnections();
        }

        function renderConnections() {
            // Remove existing connections
            document.querySelectorAll('.workflow-connection').forEach(conn => conn.remove());
            
            currentWorkflow.connections.forEach(conn => {
                const fromNode = document.getElementById(conn.from);
                const toNode = document.getElementById(conn.to);
                
                if (fromNode && toNode) {
                    const fromRect = fromNode.getBoundingClientRect();
                    const toRect = toNode.getBoundingClientRect();
                    const canvasRect = document.getElementById('workflowCanvas').getBoundingClientRect();
                    
                    const fromX = fromRect.right - canvasRect.left;
                    const fromY = fromRect.top + fromRect.height / 2 - canvasRect.top;
                    const toX = toRect.left - canvasRect.left;
                    const toY = toRect.top + toRect.height / 2 - canvasRect.top;
                    
                    const length = Math.sqrt(Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2));
                    const angle = Math.atan2(toY - fromY, toX - fromX) * 180 / Math.PI;
                    
                    const connection = document.createElement('div');
                    connection.className = 'workflow-connection';
                    connection.style.width = length + 'px';
                    connection.style.left = fromX + 'px';
                    connection.style.top = fromY + 'px';
                    connection.style.transform = `rotate(${angle}deg)`;
                    
                    document.getElementById('workflowCanvas').appendChild(connection);
                }
            });
        }

        function renderTemporaryConnection(x, y) {
            const canvas = document.getElementById('workflowCanvas');
            const fromNode = document.getElementById(dragStartNode.id);
            const fromRect = fromNode.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            
            const fromX = fromRect.right - canvasRect.left;
            const fromY = fromRect.top + fromRect.height / 2 - canvasRect.top;
            
            const length = Math.sqrt(Math.pow(x - fromX, 2) + Math.pow(y - fromY, 2));
            const angle = Math.atan2(y - fromY, x - fromX) * 180 / Math.PI;
            
            const connection = document.createElement('div');
            connection.className = 'workflow-connection temporary';
            connection.style.width = length + 'px';
            connection.style.left = fromX + 'px';
            connection.style.top = fromY + 'px';
            connection.style.transform = `rotate(${angle}deg)`;
            
            canvas.appendChild(connection);
        }

        function findNodeAtPosition(x, y) {
            return currentWorkflow.nodes.find(node => {
                const element = document.getElementById(node.id);
                if (!element) return false;
                
                const rect = element.getBoundingClientRect();
                const canvasRect = document.getElementById('workflowCanvas').getBoundingClientRect();
                
                return (
                    x >= rect.left - canvasRect.left &&
                    x <= rect.right - canvasRect.left &&
                    y >= rect.top - canvasRect.top &&
                    y <= rect.bottom - canvasRect.top
                );
            });
        }

        function saveWorkflow() {
            const name = prompt('Enter a name for this workflow:');
            if (!name) return;
            
            const workflow = {
                name,
                nodes: currentWorkflow.nodes,
                connections: currentWorkflow.connections
            };
            
            workflows.push(workflow);
            localStorage.setItem('workflows', JSON.stringify(workflows));
        }

        function loadWorkflow() {
            if (workflows.length === 0) {
                alert('No saved workflows found.');
                return;
            }
            
            const workflowNames = workflows.map(w => w.name);
            const name = prompt('Enter the name of the workflow to load:\n' + workflowNames.join('\n'));
            if (!name) return;
            
            const workflow = workflows.find(w => w.name === name);
            if (!workflow) {
                alert('Workflow not found.');
                return;
            }
            
            clearWorkflow();
            currentWorkflow = workflow;
            
            workflow.nodes.forEach(node => renderNode(node));
            renderConnections();
        }

        function clearWorkflow() {
            currentWorkflow = { nodes: [], connections: [] };
            document.getElementById('workflowCanvas').innerHTML = `
                <div class="absolute inset-0 flex items-center justify-center text-main opacity-50 pointer-events-none" id="canvasPlaceholder">
                    Drag agents here to start building your workflow
                </div>
            `;
            document.getElementById('nodeConfigPanel').classList.add('hidden');
        }

        async function executeWorkflow() {
            if (currentWorkflow.nodes.length === 0) {
                alert('No nodes in the workflow.');
                return;
            }

            // Find start nodes (nodes with no incoming connections)
            const startNodes = currentWorkflow.nodes.filter(node => 
                !currentWorkflow.connections.some(conn => conn.to === node.id)
            );

            if (startNodes.length === 0) {
                alert('No start nodes found. Add nodes without incoming connections.');
                return;
            }

            // Execute workflow
            const results = new Map();
            
            for (const node of startNodes) {
                await executeNode(node, results);
            }

            // Use the final result
            const finalNodes = currentWorkflow.nodes.filter(node =>
                !currentWorkflow.connections.some(conn => conn.from === node.id)
            );

            if (finalNodes.length > 0) {
                const finalResult = results.get(finalNodes[0].id);
                if (finalResult) {
                    document.getElementById('prompt').value = finalResult;
                    await generateRoast();
                }
            }
        }

        async function executeNode(node, results) {
            // Get input from connected nodes
            const inputConnections = currentWorkflow.connections.filter(conn => conn.to === node.id);
            const inputs = await Promise.all(
                inputConnections.map(async conn => {
                    const fromNode = currentWorkflow.nodes.find(n => n.id === conn.from);
                    if (!results.has(fromNode.id)) {
                        await executeNode(fromNode, results);
                    }
                    return results.get(fromNode.id);
                })
            );

            // Prepare prompt
            let prompt = node.prompt;
            if (inputs.length > 0) {
                prompt = prompt.replace('{input}', inputs.join('\n'));
            }

            // Add parameters to prompt
            Object.entries(node.parameters).forEach(([key, value]) => {
                prompt = prompt.replace(`{${key}}`, value);
            });

            // Add target to prompt
            prompt = prompt.replace('{target}', document.getElementById('target').value);

            // Execute agent
            const result = await callApi(prompt);
            results.set(node.id, result);
        }
        // Add Workflow Builder button to the UI
        const workflowButton = document.createElement('button');
        workflowButton.className = 'main-button px-4 py-2 rounded text-main-button-text mb-4';
        workflowButton.textContent = 'Workflow Builder';
        workflowButton.onclick = openWorkflowBuilderModal;
        controlPanel.insertBefore(workflowButton, controlPanel.firstChild);

        // Example Library Logic
        let exampleLibrary = JSON.parse(localStorage.getItem('obliterate_examples')) || [];

        function updateExampleSelect() {
            const select = document.getElementById('example-select');
            if (!select) return;
            select.innerHTML = exampleLibrary.length === 0
                ? '<option value="">-- No examples selected --</option>'
                : exampleLibrary.map((ex, i) => `<option value="${i}">${ex.replace(/\n/g, ' ').slice(0, 80)}${ex.length > 80 ? '...' : ''}</option>`).join('');
        }

        // Call updateExampleSelect after rendering examples
        function renderExamples() {
            const list = document.getElementById('examples-list');
            if (!list) return;
            if (exampleLibrary.length === 0) {
                list.innerHTML = '<p class="text-output/70 text-center text-lg">No examples yet. Add one above!</p>';
                updateExampleSelect();
                return;
            }
            list.innerHTML = exampleLibrary.map((ex, i) => `
                <div class="bg-black/20 p-4 rounded-lg border border-panel-border/50 flex flex-col gap-2">
                    <textarea class="example-edit-area w-full rounded-lg px-2 py-1 text-lg" data-index="${i}" readonly>${ex}</textarea>
                    <div class="flex gap-2">
                        <button class="edit-example-btn topic-btn rounded-lg p-2 font-semibold" data-index="${i}">Edit</button>
                        <button class="save-example-btn topic-btn rounded-lg p-2 font-semibold hidden" data-index="${i}">Save</button>
                        <button class="delete-example-btn topic-btn rounded-lg p-2 font-semibold" data-index="${i}">Delete</button>
                    </div>
                </div>
            `).join('');
            // Add event listeners for edit, save, delete
            list.querySelectorAll('.edit-example-btn').forEach(btn => btn.onclick = handleEditExample);
            list.querySelectorAll('.save-example-btn').forEach(btn => btn.onclick = handleSaveExample);
            list.querySelectorAll('.delete-example-btn').forEach(btn => btn.onclick = handleDeleteExample);
            updateExampleSelect();
        }

        function handleAddExample() {
            const input = document.getElementById('new-example-input');
            const value = input.value.trim();
            if (!value) return;
            exampleLibrary.unshift(value);
            localStorage.setItem('obliterate_examples', JSON.stringify(exampleLibrary));
            input.value = '';
            renderExamples();
        }

        function handleEditExample(e) {
            const idx = e.target.dataset.index;
            const area = document.querySelector(`.example-edit-area[data-index='${idx}']`);
            area.removeAttribute('readonly');
            area.focus();
            e.target.style.display = 'none';
            e.target.parentNode.querySelector('.save-example-btn').style.display = '';
        }

        function handleSaveExample(e) {
            const idx = e.target.dataset.index;
            const area = document.querySelector(`.example-edit-area[data-index='${idx}']`);
            const value = area.value.trim();
            if (!value) return;
            exampleLibrary[idx] = value;
            localStorage.setItem('obliterate_examples', JSON.stringify(exampleLibrary));
            area.setAttribute('readonly', 'readonly');
            e.target.style.display = 'none';
            e.target.parentNode.querySelector('.edit-example-btn').style.display = '';
            renderExamples();
        }

        function handleDeleteExample(e) {
            const idx = e.target.dataset.index;
            if (!confirm('Delete this example?')) return;
            exampleLibrary.splice(idx, 1);
            localStorage.setItem('obliterate_examples', JSON.stringify(exampleLibrary));
            renderExamples();
        }

        document.getElementById('add-example-btn').addEventListener('click', handleAddExample);
        document.getElementById('show-examples-btn').addEventListener('click', () => {
            showModal('examples-modal');
            renderExamples();
        });

        // Add this in the script section after the existing configuration functions
        function exportConfiguration() {
            const configName = document.getElementById('config-loader-select').value;
            if (!configName) {
                alert('Please select a configuration to export');
                return;
            }

            const configs = JSON.parse(localStorage.getItem(STORAGE_KEYS.configs)) || {};
            const configToExport = configs[configName];
            
            if (!configToExport) {
                alert('Configuration not found');
                return;
            }

            // Get the current prompt
            const currentPrompt = document.getElementById('direct-prompt-toggle').checked 
                ? document.getElementById('direct-prompt-input').value 
                : constructPrompt(true);

            // Create a shareable object with metadata
            const shareableConfig = {
                name: configName,
                version: '1.0',
                timestamp: new Date().toISOString(),
                config: configToExport,
                prompt: currentPrompt
            };

            // Convert to a base64 string for easy sharing
            const configString = btoa(JSON.stringify(shareableConfig));

            // Create a modal with options
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="modal-content rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-main">Export Configuration</h2>
                        <button class="close-modal-btn text-4xl hover:text-white">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div class="flex space-x-4">
                            <button id="copy-to-clipboard-btn" class="px-4 py-2 bg-main text-black rounded-lg hover:bg-main/80">
                                Copy to Clipboard
                            </button>
                            <button id="save-as-file-btn" class="px-4 py-2 bg-main text-black rounded-lg hover:bg-main/80">
                                Save as File
                            </button>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-main mb-2">Configuration Name:</h3>
                            <p class="text-white">${configName}</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-main mb-2">Prompt:</h3>
                            <pre class="bg-black/20 p-4 rounded-lg text-white whitespace-pre-wrap">${currentPrompt}</pre>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-main mb-2">Settings:</h3>
                            <pre class="bg-black/20 p-4 rounded-lg text-white whitespace-pre-wrap">${JSON.stringify(configToExport, null, 2)}</pre>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Add event listeners for the buttons
            modal.querySelector('#copy-to-clipboard-btn').onclick = () => {
                const textarea = document.createElement('textarea');
                textarea.value = configString;
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    document.execCommand('copy');
                    const btn = modal.querySelector('#copy-to-clipboard-btn');
                    const originalText = btn.textContent;
                    btn.textContent = '✓ Copied!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                } catch (err) {
                    alert('Failed to copy to clipboard. Please try again.');
                } finally {
                    document.body.removeChild(textarea);
                }
            };

            modal.querySelector('#save-as-file-btn').onclick = () => {
                const blob = new Blob([configString], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${configName}_config.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // Add close functionality
            modal.querySelector('.close-modal-btn').onclick = () => {
                document.body.removeChild(modal);
            };
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        function importConfiguration() {
            // Create a modal for import options
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="modal-content rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-main">Import Configuration</h2>
                        <button class="close-modal-btn text-4xl hover:text-white">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div class="flex space-x-4">
                            <button id="paste-config-btn" class="px-4 py-2 bg-main text-black rounded-lg hover:bg-main/80">
                                Paste Configuration
                            </button>
                            <button id="import-file-btn" class="px-4 py-2 bg-main text-black rounded-lg hover:bg-main/80">
                                Import from File
                            </button>
                        </div>
                        <div id="paste-area" class="hidden">
                            <textarea id="config-paste-input" class="w-full h-32 p-2 bg-black/20 text-white rounded-lg" 
                                placeholder="Paste your configuration string here..."></textarea>
                            <button id="confirm-paste-btn" class="mt-2 px-4 py-2 bg-main text-black rounded-lg hover:bg-main/80">
                                Import
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Add event listeners
            modal.querySelector('#paste-config-btn').onclick = () => {
                const pasteArea = modal.querySelector('#paste-area');
                pasteArea.classList.remove('hidden');
            };

            modal.querySelector('#import-file-btn').onclick = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.txt';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                processImportedConfig(event.target.result);
                            } catch (error) {
                                alert('Error importing file: ' + error.message);
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            };

            modal.querySelector('#confirm-paste-btn').onclick = () => {
                const configString = modal.querySelector('#config-paste-input').value.trim();
                if (configString) {
                    try {
                        processImportedConfig(configString);
                    } catch (error) {
                        alert('Error importing configuration: ' + error.message);
                    }
                } else {
                    alert('Please paste a configuration string');
                }
            };

            // Add close functionality
            modal.querySelector('.close-modal-btn').onclick = () => {
                document.body.removeChild(modal);
            };
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        function processImportedConfig(configString) {
            try {
                // Decode the base64 string
                const decodedString = atob(configString);
                const importedConfig = JSON.parse(decodedString);

                // Validate the imported config
                if (!importedConfig.name || !importedConfig.config) {
                    throw new Error('Invalid configuration format');
                }

                // Check if config with same name exists
                const configs = JSON.parse(localStorage.getItem(STORAGE_KEYS.configs)) || {};
                if (configs[importedConfig.name]) {
                    if (!confirm(`A configuration named "${importedConfig.name}" already exists. Overwrite it?`)) {
                        return;
                    }
                }

                // Save the imported config
                configs[importedConfig.name] = importedConfig.config;
                localStorage.setItem(STORAGE_KEYS.configs, JSON.stringify(configs));

                // Update the UI
                populateConfigsDropdown();
                document.getElementById('config-loader-select').value = importedConfig.name;
                loadConfiguration(importedConfig.name);

                // If there's a prompt in the imported config, set it
                if (importedConfig.prompt) {
                    const directPromptToggle = document.getElementById('direct-prompt-toggle');
                    const directPromptInput = document.getElementById('direct-prompt-input');
                    const directPromptEditorContainer = document.getElementById('direct-prompt-editor-container');
                    
                    if (directPromptToggle && directPromptInput && directPromptEditorContainer) {
                        directPromptToggle.checked = true;
                        directPromptInput.value = importedConfig.prompt;
                        directPromptEditorContainer.classList.remove('hidden');
                    }
                }

                // Show success message
                const successModal = document.createElement('div');
                successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                successModal.innerHTML = `
                    <div class="modal-content rounded-2xl p-6 w-full max-w-md">
                        <div class="text-center">
                            <h2 class="text-2xl font-bold text-main mb-4">Success!</h2>
                            <p class="text-white mb-4">Configuration "${importedConfig.name}" has been imported successfully.</p>
                            <button class="px-4 py-2 bg-main text-black rounded-lg hover:bg-main/80" onclick="this.closest('.fixed').remove()">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(successModal);
            } catch (error) {
                throw new Error('Invalid configuration format: ' + error.message);
            }
        }

        // Add event listeners for the new buttons
        document.getElementById('export-config-btn').addEventListener('click', exportConfiguration);
        document.getElementById('import-config-btn').addEventListener('click', importConfiguration);

        function showSaveConfigModal() {
            document.getElementById('save-config-modal').classList.remove('hidden');
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('config-name-input').value = '';
            document.getElementById('config-name-input').focus();
        }

        function hideSaveConfigModal() {
            document.getElementById('save-config-modal').classList.add('hidden');
            document.getElementById('modal-backdrop').classList.add('hidden');
        }

        function constructPrompt(includeTopics = false) {
            const generatorPersonaSelect = document.getElementById('generator-persona-select');
            const pointOfViewSelect = document.getElementById('point-of-view-select');
            const topicsInput = document.getElementById('topics-input');
            
            // Default values in case elements are not found
            const generatorPersona = generatorPersonaSelect ? generatorPersonaSelect.value : 'default';
            const pointOfView = pointOfViewSelect ? pointOfViewSelect.value : 'any';
            const topics = includeTopics && topicsInput ? topicsInput.value : '';
            
            let prompt = `Generate a ${generatorPersona} style joke`;
            
            if (pointOfView !== 'any') {
                prompt += ` in ${pointOfView} person`;
            }
            
            if (topics) {
                prompt += ` about ${topics}`;
            }
            
            return prompt;
        }

        function displayReferences() {
            updateReferenceList();
        }

        // Add animation classes to elements when they come into view
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('fade-in');
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        // Observe all panels and containers
        document.querySelectorAll('.control-panel, .joke-container, .modal-content').forEach(el => {
            observer.observe(el);
        });

        // Add smooth scroll behavior
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });

        // Add loading animation
        function showLoading(element) {
            const spinner = document.createElement('div');
            spinner.className = 'loading-spinner';
            element.appendChild(spinner);
            return spinner;
        }

        function hideLoading(spinner) {
            if (spinner) {
                spinner.remove();
            }
        }

        // Add card flip animation to joke containers
        document.querySelectorAll('.joke-container').forEach(container => {
            container.classList.add('card-flip');
            const front = container.querySelector('.joke-content');
            const back = document.createElement('div');
            back.className = 'card-back';
            back.innerHTML = '<p>Click to flip back</p>';
            container.appendChild(back);
        });

        // Add ripple effect to buttons
        document.querySelectorAll('.main-button, .minimal-button').forEach(button => {
            button.addEventListener('click', function(e) {
                const ripple = document.createElement('span');
                ripple.className = 'ripple';
                this.appendChild(ripple);
                
                const rect = button.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.width = ripple.style.height = `${size}px`;
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                
                setTimeout(() => ripple.remove(), 600);
            });
        });

        // Add smooth transitions between themes
        document.querySelectorAll('[data-theme]').forEach(themeButton => {
            themeButton.addEventListener('click', function() {
                document.body.style.transition = 'all 0.5s ease';
                document.body.className = this.dataset.theme;
            });
        });

        // Add parallax effect to background
        document.addEventListener('mousemove', (e) => {
            const moveX = (e.clientX - window.innerWidth / 2) * 0.01;
            const moveY = (e.clientY - window.innerHeight / 2) * 0.01;
            
            document.querySelectorAll('.control-panel, .joke-container').forEach(el => {
                el.style.transform = `translate(${moveX}px, ${moveY}px)`;
            });
        });

        // Add minimal input animations
        document.querySelectorAll('input, textarea').forEach(input => {
            input.classList.add('minimal-input');
            
            input.addEventListener('focus', function() {
                this.parentElement.classList.add('focused');
            });
            
            input.addEventListener('blur', function() {
                if (!this.value) {
                    this.parentElement.classList.remove('focused');
                }
            });
        });

        // Add smooth page transitions
        window.addEventListener('beforeunload', () => {
            document.body.classList.add('fade-out');
        });

        // Add pulse animation to important elements
        document.querySelectorAll('.title-glitch, .main-button').forEach(el => {
            el.classList.add('pulse');
        });

        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 'Enter') {
                generateJoke();
            }
        });

        // Add this near the top of your script, with other global variables
        let usedWords = new Set();
        let usedThemes = new Set();
        let usedScenarios = new Set();
        let usedFamilyMembers = new Set();
        let usedObjects = new Set();
        let usedActions = new Set();
        let usedComparisons = new Set();

        // Add theme variation suggestions
        const themeVariations = {
            familyMembers: ['uncle', 'dad', 'mom', 'cousin', 'brother', 'sister', 'grandma', 'grandpa', 'aunt'],
            objects: ['toilet', 'shower', 'oven', 'alarm clock', 'remote', 'belt', 'stapler', 'cardboard', 'fire hose', 'hotdog', 'jar', 'toolbox', 'knuckles', 'anchor', 'hat'],
            actions: ['walk', 'run', 'jump', 'fly', 'dive', 'throw', 'drop', 'pour', 'tie', 'wear', 'use', 'steal', 'serve', 'flush', 'spit'],
            comparisons: ['like', 'as if', 'just like', 'similar to', 'resembling', 'matching', 'copying'],
            locations: ['attic', 'sink', 'bathroom', 'kitchen', 'living room', 'bedroom', 'garage', 'basement', 'roof'],
            situations: ['instead of', 'when', 'why', 'because', 'after', 'before', 'while']
        };

        // Function to get random unused variations
        function getRandomUnusedVariations() {
            const variations = {};
            for (const [category, items] of Object.entries(themeVariations)) {
                const unused = items.filter(item => !usedWords.has(item));
                if (unused.length > 0) {
                    variations[category] = unused[Math.floor(Math.random() * unused.length)];
                }
            }
            return variations;
        }

        // Enhanced tracking function
        function trackUsedContent(joke) {
            // Track individual words
            const words = joke.toLowerCase().split(/\s+/);
            words.forEach(word => {
                if (word.length > 3) {
                    usedWords.add(word);
                }
            });

            // Track family members
            const familyPattern = /(yo\s+(uncle|dad|mom|cousin|brother|sister|grandma|grandpa|aunt)|your\s+(uncle|dad|mom|cousin|brother|sister|grandma|grandpa|aunt))/gi;
            const familyMatches = joke.match(familyPattern) || [];
            familyMatches.forEach(match => usedFamilyMembers.add(match.toLowerCase()));

            // Track objects
            const objectPattern = /(toilet|shower|oven|alarm clock|remote|belt|stapler|cardboard|fire hose|hotdog|jar|toolbox|knuckles|anchor|hat)/gi;
            const objectMatches = joke.match(objectPattern) || [];
            objectMatches.forEach(match => usedObjects.add(match.toLowerCase()));

            // Track actions
            const actionPattern = /(walk|run|jump|fly|dive|throw|drop|pour|tie|wear|use|steal|serve|flush|spit)(?:ed|ing|s)?/gi;
            const actionMatches = joke.match(actionPattern) || [];
            actionMatches.forEach(match => usedActions.add(match.toLowerCase()));

            // Track comparisons
            const comparisonPattern = /(like|as if|just like|similar to|resembling|matching|copying)/gi;
            const comparisonMatches = joke.match(comparisonPattern) || [];
            comparisonMatches.forEach(match => usedComparisons.add(match.toLowerCase()));

            // Track scenarios
            const scenarioPattern = /(instead of|when|why|because|after|before|while).*?(?=\s|$)/gi;
            const scenarioMatches = joke.match(scenarioPattern) || [];
            scenarioMatches.forEach(match => usedScenarios.add(match.toLowerCase()));
        }

        // Modify the constructPrompt function to include variation suggestions
        function constructPrompt(forDisplayOnly = false) {
            // ... existing prompt construction code ...

            const variations = getRandomUnusedVariations();
            
            // Add this section to the styleBlock
            styleBlock += `\n- **IMPORTANT: DO NOT USE THESE PREVIOUSLY USED ELEMENTS:**
  * Previously used family members: ${Array.from(usedFamilyMembers).join(', ')}
  * Previously used objects: ${Array.from(usedObjects).join(', ')}
  * Previously used actions: ${Array.from(usedActions).join(', ')}
  * Previously used comparisons: ${Array.from(usedComparisons).join(', ')}
  * Previously used scenarios: ${Array.from(usedScenarios).join(', ')}

- **SUGGESTED NEW VARIATIONS TO USE:**
  * Try using these family members: ${variations.familyMembers || 'any unused family member'}
  * Try using these objects: ${variations.objects || 'any unused object'}
  * Try using these actions: ${variations.actions || 'any unused action'}
  * Try using these comparisons: ${variations.comparisons || 'any unused comparison'}
  * Try using these locations: ${variations.locations || 'any unused location'}

  * Create a completely new joke that:
    - Avoids all previously used elements
    - Uses at least one of the suggested variations
    - Maintains the authentic "pack" style
    - Is unique and creative`;

            return styleBlock;
        }

        // Add a function to clear tracking (useful for new sessions)
        function clearTracking() {
            usedWords.clear();
            usedThemes.clear();
            usedScenarios.clear();
            usedFamilyMembers.clear();
            usedObjects.clear();
            usedActions.clear();
            usedComparisons.clear();
        }

        // Add clear tracking to the initializeApp function
        function initializeApp() {
            clearTracking();
            clearUsedAIContent();
            // ... rest of initialization code ...
        }

        // Add a function to clear usedAIContent for new sessions
        function clearUsedAIContent() {
            usedAIContent = {};
        }
    </script>
</body>
</html>
